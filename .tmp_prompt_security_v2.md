# CONTEXTO

Lee PRIMERO este archivo para entender tu rol y permisos:
`/Users/pedro/Documents/odoo19/docs/prompts/00_knowledge_base/CLI_AGENTS_SYSTEM_CONTEXT.md`

Eres un CLI agent (Copilot) trabajando bajo orquestaci√≥n de Claude Code Sonnet 4.5 (Orchestrator Maestro). Tu rol es ejecutar una auditor√≠a de Security del microservicio ai-service de forma **100% aut√≥noma**.

---

# TAREA

Audita la seguridad del microservicio **ai-service**.

**M√≥dulo:** `/Users/pedro/Documents/odoo19/ai-service/`

**Enfoque:**
- OWASP Top 10 compliance (injection, XSS, broken auth, etc.)
- Secrets management (API keys, credentials storage)
- Input validation (Pydantic validators, sanitization)
- Authentication & Authorization (API key validation, timing attacks)
- Session management (session IDs, TTL, storage)
- Security headers (CORS, CSP, X-Frame-Options)
- Dependency vulnerabilities (requirements.txt audit)
- PII handling in logs

**Target Score:** 90/100 (Excelente)

---

# PERMISOS (Pre-Autorizados - NO PEDIR CONFIRMACI√ìN)

Seg√∫n CLI_AGENTS_SYSTEM_CONTEXT.md, tienes **autonom√≠a total** para:

‚úÖ **Lectura:**
- Full access a TODO el proyecto: `/Users/pedro/Documents/odoo19/**`
- Leer cualquier archivo Python, YAML, JSON, MD, .env.example
- Ejecutar comandos an√°lisis: `grep`, `find`, `wc`
- Buscar patrones de seguridad: hardcoded secrets, SQL injection risks, etc.

‚úÖ **Escritura:**
- Escribir reporte en: `docs/prompts/06_outputs/2025-11/AUDIT_SECURITY_AI_SERVICE_V2_2025-11-13.md`

‚úÖ **An√°lisis:**
- Revisar validators (RUT, montos, fechas)
- Verificar API key storage
- Analizar CORS configuration
- Check dependencies con `pip-audit` conceptualmente (NO ejecutar, solo analizar requirements.txt)

‚ùå **NO Hacer:**
- Modificar c√≥digo
- Ejecutar dependency scanners externos (solo an√°lisis manual)
- Crear nuevos archivos de config

**IMPORTANTE:** NO pidas confirmaci√≥n para reads/an√°lisis/writes en rutas autorizadas.

---

# OUTPUT

**Archivo de Reporte:**
`/Users/pedro/Documents/odoo19/docs/prompts/06_outputs/2025-11/AUDIT_SECURITY_AI_SERVICE_V2_2025-11-13.md`

**Formato del Reporte:**

```markdown
# Auditor√≠a Security - AI Service Microservice

**Score:** X/100
**Fecha:** 2025-11-13
**Auditor:** Copilot CLI (GPT-4o)
**M√≥dulo:** ai-service
**Dimensi√≥n:** Security (OWASP + Secrets + Validation)

---

## üìä Resumen Ejecutivo

[Overview del estado de seguridad]

### Hallazgos Cr√≠ticos (Top 3):
1. **[P1/P2/P3]** Descripci√≥n finding 1
2. **[P1/P2/P3]** Descripci√≥n finding 2
3. **[P1/P2/P3]** Descripci√≥n finding 3

---

## üéØ Score Breakdown

| Categor√≠a | Score | Detalles |
|-----------|-------|----------|
| **OWASP Top 10 Compliance** | X/25 | Injection, XSS, Auth issues |
| **Secrets Management** | X/25 | API keys, credentials |
| **Input Validation** | X/25 | Pydantic validators |
| **Security Headers & Sessions** | X/25 | CORS, CSP, session handling |
| **TOTAL** | **X/100** | Grade: A/B/C/D |

---

## üîç Hallazgos Detallados

### Sec-1: [T√≠tulo] (P1/P2/P3 - High/Medium/Low)
**Descripci√≥n:** [Vulnerabilidad encontrada]

**OWASP Category:** [A01-A10]

**Ubicaci√≥n:** `archivo.py:l√≠nea`

**Riesgo:** [Explicar impacto potencial]

**Recomendaci√≥n:**
```python
# C√≥digo seguro sugerido
```

**Esfuerzo:** X horas

---

[... Repetir para todos los hallazgos ...]

---

## ‚úÖ Controles de Seguridad Validados

- ‚úÖ Control 1 implementado
- ‚úÖ Control 2 implementado
- ‚úÖ Control 3 implementado

---

## üöÄ Plan de Remediaci√≥n Prioritario

### Prioridad P1 (Cr√≠tica - X hallazgos)
[Vulnerabilidades que deben arreglarse ASAP]

### Prioridad P2 (Media - X hallazgos)
[Mejoras de seguridad importantes]

### Prioridad P3 (Baja - X hallazgos)
[Mejoras nice-to-have]

---

**CONCLUSI√ìN:** [Resumen de seguridad general, score, principales vulnerabilidades, esfuerzo para 90/100]
```

**Stdout (Retornar al Finalizar):**

```
‚úÖ Auditor√≠a Security completada
Score: X/100 (Grade: A/B/C)
OWASP Compliance: X/10 categor√≠as

Top 3 Findings:
[P1] Finding 1 brief
[P2] Finding 2 brief
[P3] Finding 3 brief

Vulnerabilidades cr√≠ticas: X
Esfuerzo remediaci√≥n P1: ~X horas
Reporte completo: docs/prompts/06_outputs/2025-11/AUDIT_SECURITY_AI_SERVICE_V2_2025-11-13.md
```

---

# RESTRICCIONES

- ‚ùå NO modificar c√≥digo
- ‚ùå NO ejecutar vulnerability scanners externos
- ‚è±Ô∏è  Target: < 5 minutos ejecuci√≥n

---

# NOTAS ADICIONALES

**Orquestaci√≥n v1.1 LEAN:**
- Claude NO lee tus logs (file polling)
- Escribe TODO en el archivo de reporte
- Primeras 50 l√≠neas = Score + Top 3 findings + Resumen ejecutivo

**Archivos Clave:**
- `ai-service/main.py` (endpoints, auth middleware)
- `ai-service/config.py` (settings, secrets loading)
- `ai-service/clients/anthropic_client.py` (API key usage)
- `ai-service/chat/validators.py` (input validation)
- `ai-service/requirements.txt` (dependencies)
- `.env.example` (env vars structure)

**OWASP Top 10 2021:**
1. A01: Broken Access Control
2. A02: Cryptographic Failures
3. A03: Injection
4. A04: Insecure Design
5. A05: Security Misconfiguration
6. A06: Vulnerable and Outdated Components
7. A07: Identification and Authentication Failures
8. A08: Software and Data Integrity Failures
9. A09: Security Logging and Monitoring Failures
10. A10: Server-Side Request Forgery

**Validar Espec√≠ficamente:**
- API key validation usa `secrets.compare_digest()` (timing-attack resistant)?
- Session IDs son UUID v4 (no predecibles)?
- CORS permite solo or√≠genes autorizados?
- `/metrics` endpoint est√° protegido?
- Logs NO contienen PII (session_ids, wages, employee_ids)?
- Rate limiting implementado?

¬°Adelante! Ejecuta la auditor√≠a de seguridad de forma completamente aut√≥noma.
