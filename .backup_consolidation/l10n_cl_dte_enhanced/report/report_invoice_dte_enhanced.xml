<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!--
    DTE Invoice Report Template - Enhanced
    =======================================

    Professional PDF report template for Chilean Electronic Tax Documents (DTE)
    with enhanced features from l10n_cl_dte_enhanced module.

    Extends: l10n_cl_dte.report_invoice_dte_document

    Enhanced Features:
    - PDF417 barcode generation (TED - Timbre Electrónico)
    - Contact person field (contact_id)
    - Custom payment terms (forma_pago)
    - CEDIBLE indicator for factoring
    - SII Document References table

    Author: EERGYGROUP - Ing. Pedro Troncoso Willz
    License: LGPL-3
    Version: 19.0.1.0.0
    Date: 2025-11-04
    -->

    <!-- ═══════════════════════════════════════════════════════════════════ -->
    <!-- ENHANCED TEMPLATE: Inherit and extend base DTE template             -->
    <!-- ═══════════════════════════════════════════════════════════════════ -->

    <template id="report_invoice_dte_document_enhanced"
              inherit_id="l10n_cl_dte.report_invoice_dte_document">

        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- OVERRIDE: PDF417 Barcode Generation (TED)                       -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- Replace TED barcode section with professional PDF417 generation -->

        <xpath expr="//t[@t-set='ted_barcode']" position="replace">
            <t t-set="ted_barcode" t-value="o.get_ted_pdf417()"/>
            <t t-if="not ted_barcode" t-set="ted_barcode" t-value="o.get_ted_qrcode()"/>
        </xpath>

        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- ENHANCEMENT: Contact Person Field                               -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- Add contact person below customer "Giro" information -->

        <xpath expr="//p[@t-if='o.partner_id.activity_description'][strong[text()='Giro:']]" position="after">
            <p class="mb-0 mt-2 pt-2 border-top" t-if="o.contact_id">
                <strong>Persona de Contacto:</strong>
                <t t-out="o.contact_id.name"/>
            </p>
            <p class="mb-0 small" t-if="o.contact_id and o.contact_id.phone">
                <i class="fa fa-phone" title="Phone"/> <t t-out="o.contact_id.phone"/>
            </p>
            <p class="mb-0 small" t-if="o.contact_id and o.contact_id.email">
                <i class="fa fa-envelope" title="Email"/> <t t-out="o.contact_id.email"/>
            </p>
        </xpath>

        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- ENHANCEMENT: Custom Payment Terms (forma_pago)                  -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- Override payment terms to show custom forma_pago if available -->

        <xpath expr="//tr[@t-if='o.invoice_payment_term_id']" position="replace">
            <tr t-if="o.forma_pago or o.invoice_payment_term_id">
                <td><strong>Condición de Pago:</strong></td>
                <td>
                    <!-- Priority: Custom forma_pago, then standard payment term -->
                    <t t-if="o.forma_pago" t-out="o.forma_pago"/>
                    <t t-else="" t-out="o.invoice_payment_term_id.name"/>
                </td>
            </tr>
        </xpath>

        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- ENHANCEMENT: CEDIBLE Indicator                                  -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- Add CEDIBLE indicator in DTE header box -->

        <xpath expr="//div[hasclass('border', 'border-dark', 'p-3', 'd-inline-block', 'text-center')]" position="inside">
            <div t-if="o.cedible" class="mt-2 pt-2 border-top border-dark">
                <p class="mb-0 small text-danger" style="font-weight: bold;">
                    ✓ CEDIBLE ELECTRÓNICAMENTE
                </p>
                <p class="mb-0" style="font-size: 8pt;">
                    Art. 18 Res. Ex. SII N° 93 de 2003
                </p>
            </div>
        </xpath>

        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- ENHANCEMENT: SII Document References Table                      -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- Add SII references section after observations/notes -->

        <xpath expr="//div[@class='row mt-3'][@t-if='o.narration']" position="after">
            <div class="row mt-4" t-if="o.reference_ids">
                <div class="col-12">
                    <p class="mb-2">
                        <strong>
                            <i class="fa fa-link" title="References"/> Referencias a Documentos SII:
                        </strong>
                    </p>
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 30%;">Tipo Documento</th>
                                <th style="width: 15%;">Folio</th>
                                <th style="width: 15%;">Fecha</th>
                                <th style="width: 10%;">Código</th>
                                <th style="width: 30%;">Razón</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="o.reference_ids" t-as="ref">
                                <tr>
                                    <td>
                                        <t t-out="ref.document_type_id.name"/>
                                    </td>
                                    <td class="text-center">
                                        <strong><t t-out="ref.folio"/></strong>
                                    </td>
                                    <td class="text-center">
                                        <t t-out="ref.date" t-options='{"widget": "date", "format": "dd/MM/yyyy"}'/>
                                    </td>
                                    <td class="text-center">
                                        <t t-out="ref.code"/>
                                    </td>
                                    <td>
                                        <t t-out="ref.reason or '-'"/>
                                    </td>
                                </tr>
                            </t>
                        </tbody>
                    </table>
                    <p class="small text-muted mb-0" style="font-size: 8pt;">
                        <i class="fa fa-info-circle" title="Information"/>
                        Referencias según Resolución Ex. SII N° 80 de 2014
                    </p>
                </div>
            </div>
        </xpath>

        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- ENHANCEMENT: Bank Information (from res.company)                -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- Add bank information section before payment terms breakdown -->

        <xpath expr="//t[@t-set='payment_lines']" position="before">
            <div class="row mt-3" t-if="o.company_id.bank_name and o.company_id.bank_account_number">
                <div class="col-12">
                    <p class="mb-2">
                        <strong>
                            <i class="fa fa-bank" title="Bank"/> Información Bancaria para Pagos:
                        </strong>
                    </p>
                    <div class="border p-3" style="background-color: #f8f9fa;">
                        <div class="row">
                            <div class="col-6">
                                <p class="mb-1">
                                    <strong>Banco:</strong> <t t-out="o.company_id.bank_name"/>
                                </p>
                            </div>
                            <div class="col-6">
                                <p class="mb-1">
                                    <strong>Tipo de Cuenta:</strong>
                                    <t t-if="o.company_id.bank_account_type == 'checking'">Cuenta Corriente</t>
                                    <t t-if="o.company_id.bank_account_type == 'savings'">Cuenta de Ahorro</t>
                                </p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <p class="mb-0">
                                    <strong>Número de Cuenta:</strong>
                                    <span style="font-family: monospace; font-size: 14pt;">
                                        <t t-out="o.company_id.bank_account_number"/>
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </xpath>

        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- ENHANCEMENT: Format RUT/VAT with proper Chilean format         -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- Replace all RUT displays with formatted version -->

        <xpath expr="//t[@t-out='format_vat(o.partner_id.vat)']" position="replace">
            <t t-out="o.format_vat(o.partner_id.vat)"/>
        </xpath>

        <xpath expr="//t[@t-out='format_vat(o.company_id.vat)']" position="replace">
            <t t-out="o.format_vat(o.company_id.vat)"/>
        </xpath>

        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- ENHANCEMENT: Human-readable DTE Type Name                       -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- Replace DTE type code with translated name -->

        <xpath expr="//t[@t-out='get_dte_type_name(o.dte_code)']" position="replace">
            <t t-out="o.get_dte_type_name()"/>
        </xpath>

    </template>

    <!-- ═══════════════════════════════════════════════════════════════════ -->
    <!-- REPORT ACTION: Enhanced DTE Invoice                                 -->
    <!-- ═══════════════════════════════════════════════════════════════════ -->

    <record id="action_report_invoice_dte_enhanced" model="ir.actions.report">
        <field name="name">DTE - Factura Electrónica (Enhanced)</field>
        <field name="model">account.move</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">l10n_cl_dte_enhanced.report_invoice_dte_document_enhanced</field>
        <field name="report_file">l10n_cl_dte_enhanced.report_invoice_dte_document_enhanced</field>
        <field name="print_report_name">'DTE-%s-%s' % (object.dte_code or 'DOC', object.dte_folio or object.name)</field>
        <field name="binding_model_id" ref="account.model_account_move"/>
        <field name="binding_type">report</field>
        <field name="paperformat_id" ref="base.paperformat_us"/>
    </record>

</odoo>
