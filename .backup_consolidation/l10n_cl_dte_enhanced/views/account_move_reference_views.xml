<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- ==================================================================== -->
        <!-- ACCOUNT.MOVE.REFERENCE VIEWS                                         -->
        <!-- ==================================================================== -->

        <!-- ================================================================ -->
        <!-- Tree View - List of References                                  -->
        <!-- ================================================================ -->

        <record id="view_account_move_reference_tree" model="ir.ui.view">
            <field name="name">account.move.reference.tree</field>
            <field name="model">account.move.reference</field>
            <field name="arch" type="xml">
                <list string="SII Document References"
                      create="true"
                      delete="true"
                      editable="bottom"
                      decoration-info="code == '1'"
                      decoration-warning="code == '2'"
                      decoration-success="code == '3'">

                    <!-- Parent Document -->
                    <field name="move_name" string="Document" optional="show"/>
                    <field name="move_partner_id" string="Customer" optional="hide"/>

                    <!-- Reference Details -->
                    <field name="document_type_id"
                           string="Referenced Doc Type"
                           options="{'no_create': True, 'no_create_edit': True}"/>
                    <field name="folio" string="Folio"/>
                    <field name="date" string="Date"/>
                    <field name="code" string="Code" optional="show"/>
                    <field name="reason" string="Reason" optional="show"/>

                    <!-- Display Name (hidden, for search) -->
                    <field name="display_name" invisible="1"/>
                    <field name="move_id" invisible="1"/>

                </list>
            </field>
        </record>

        <!-- ================================================================ -->
        <!-- Form View - Detailed Reference Entry                            -->
        <!-- ================================================================ -->

        <record id="view_account_move_reference_form" model="ir.ui.view">
            <field name="name">account.move.reference.form</field>
            <field name="model">account.move.reference</field>
            <field name="arch" type="xml">
                <form string="SII Document Reference">
                    <sheet>

                        <!-- Header -->
                        <div class="oe_title">
                            <label for="display_name" class="oe_edit_only"/>
                            <h1>
                                <field name="display_name" placeholder="New Reference" readonly="1"/>
                            </h1>
                        </div>

                        <!-- Information Box -->
                        <div class="alert alert-info" role="alert">
                            <i class="fa fa-info-circle" title="Information"/> <strong>SII Document Reference</strong><br/>
                            Enter the details of the document you want to reference (original invoice, delivery guide, etc.).
                            This information will be sent to SII for validation.
                        </div>

                        <!-- Main Fields -->
                        <group>
                            <group string="Parent Document">
                                <field name="move_id"
                                       string="Invoice/Note"
                                       options="{'no_create': True, 'no_create_edit': True}"
                                       readonly="id"/>
                                <field name="move_name" invisible="1"/>
                                <field name="move_partner_id" string="Customer" readonly="1"/>
                            </group>

                            <group string="Referenced Document">
                                <field name="document_type_id"
                                       string="Document Type"
                                       options="{'no_create': True, 'no_create_edit': True}"
                                       help="Type of document being referenced (e.g., Factura Electrónica, Guía de Despacho)"/>
                                <field name="folio"
                                       string="Folio"
                                       placeholder="Enter folio number..."
                                       help="Folio number of the referenced document"/>
                                <field name="date"
                                       string="Document Date"
                                       help="Date when the referenced document was issued"/>
                            </group>
                        </group>

                        <group>
                            <group string="Reference Details">
                                <field name="code"
                                       string="Reference Code"
                                       help="SII reference code (only for Credit/Debit Notes)"/>
                                <field name="reason"
                                       string="Reason"
                                       placeholder="Optional: Describe reason for reference..."
                                       help="Optional description of why this document is being referenced"/>
                            </group>
                        </group>

                        <!-- Help Section -->
                        <group string="SII Reference Codes - Quick Reference">
                            <div class="text-muted">
                                <table class="table table-sm table-bordered" style="margin-top: 10px;">
                                    <thead>
                                        <tr>
                                            <th style="width: 10%;">Code</th>
                                            <th style="width: 30%;">Name</th>
                                            <th style="width: 60%;">Description</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>1</strong></td>
                                            <td>Anula Documento</td>
                                            <td>Completely cancels the referenced document. Use when issuing a Credit Note
                                                that fully reverses an invoice.</td>
                                        </tr>
                                        <tr>
                                            <td><strong>2</strong></td>
                                            <td>Corrige Texto</td>
                                            <td>Corrects non-monetary data in the referenced document
                                                (e.g., customer info, item descriptions, addresses).</td>
                                        </tr>
                                        <tr>
                                            <td><strong>3</strong></td>
                                            <td>Corrige Montos</td>
                                            <td>Corrects monetary amounts or calculations in the referenced document
                                                (e.g., price errors, quantity errors, tax calculations).</td>
                                        </tr>
                                    </tbody>
                                </table>
                                <p style="margin-top: 15px;">
                                    <i class="fa fa-lightbulb-o" title="Best Practice"/> <strong>Best Practice:</strong><br/>
                                    • Always verify the folio number and date match the original document<br/>
                                    • Use the "Reason" field to document why you're creating this reference<br/>
                                    • For Credit Notes, select code "1" (Anula) when fully reversing an invoice
                                </p>
                            </div>
                        </group>

                    </sheet>
                </form>
            </field>
        </record>

        <!-- ================================================================ -->
        <!-- Search View - Filter/Group References                           -->
        <!-- ================================================================ -->

        <record id="view_account_move_reference_search" model="ir.ui.view">
            <field name="name">account.move.reference.search</field>
            <field name="model">account.move.reference</field>
            <field name="arch" type="xml">
                <search string="SII Document References">

                    <!-- Search Fields -->
                    <field name="display_name" string="Reference"/>
                    <field name="folio" string="Folio"/>
                    <field name="move_name" string="Parent Document"/>
                    <field name="move_partner_id" string="Customer"/>
                    <field name="document_type_id" string="Document Type"/>
                    <field name="date" string="Date"/>

                    <!-- Filters -->
                    <filter name="filter_anula"
                            string="Anula (Code 1)"
                            domain="[('code', '=', '1')]"/>
                    <filter name="filter_corrige_texto"
                            string="Corrige Texto (Code 2)"
                            domain="[('code', '=', '2')]"/>
                    <filter name="filter_corrige_montos"
                            string="Corrige Montos (Code 3)"
                            domain="[('code', '=', '3')]"/>

                    <separator/>

                    <filter name="filter_this_month"
                            string="This Month"
                            domain="[('date', '&gt;=', (context_today() - relativedelta(day=1)).strftime('%Y-%m-%d')),
                                    ('date', '&lt;=', (context_today() + relativedelta(day=31)).strftime('%Y-%m-%d'))]"/>
                    <filter name="filter_this_year"
                            string="This Year"
                            domain="[('date', '&gt;=', (context_today() - relativedelta(month=1, day=1)).strftime('%Y-%m-%d')),
                                    ('date', '&lt;=', (context_today() + relativedelta(month=12, day=31)).strftime('%Y-%m-%d'))]"/>

                    <!-- Group By -->
                    <separator/>
                    <filter name="group_document_type"
                            string="Document Type"
                            context="{'group_by': 'document_type_id'}"/>
                    <filter name="group_code"
                            string="Reference Code"
                            context="{'group_by': 'code'}"/>
                    <filter name="group_parent"
                            string="Parent Document"
                            context="{'group_by': 'move_id'}"/>
                    <filter name="group_customer"
                            string="Customer"
                            context="{'group_by': 'move_partner_id'}"/>
                    <filter name="group_date_month"
                            string="Month"
                            context="{'group_by': 'date:month'}"/>

                </search>
            </field>
        </record>

        <!-- ================================================================ -->
        <!-- Action - Open References List                                   -->
        <!-- ================================================================ -->

        <record id="action_account_move_reference" model="ir.actions.act_window">
            <field name="name">SII Document References</field>
            <field name="res_model">account.move.reference</field>
            <field name="view_mode">list,form</field>
            <field name="search_view_id" ref="view_account_move_reference_search"/>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Create your first SII Document Reference
                </p>
                <p>
                    Document references link invoices, credit notes, and debit notes
                    to their source documents as required by SII regulations.
                </p>
                <p>
                    References are <strong>mandatory</strong> for Credit Notes (DTE 61)
                    and Debit Notes (DTE 56).
                </p>
            </field>
        </record>

        <!-- ================================================================ -->
        <!-- Menu Item - Under Accounting > Chilean DTE > Configuration     -->
        <!-- ================================================================ -->

        <menuitem id="menu_account_move_reference"
                  name="SII Document References"
                  parent="l10n_cl_dte.menu_dte_configuration"
                  action="action_account_move_reference"
                  sequence="40"
                  groups="l10n_cl_dte.group_dte_user"/>

    </data>
</odoo>
