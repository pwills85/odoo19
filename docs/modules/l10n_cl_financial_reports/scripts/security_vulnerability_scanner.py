#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# -*- coding: utf-8 -*-
"""
Security Vulnerability Scanner for account_financial_report
Comprehensive security analysis following OWASP guidelines
"""

import os
import re
import json
import ast
from pathlib import Path
from datetime import datetime
from typing import Dict, List, Any, Tuple
import logging

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)


class SecurityVulnerabilityScanner:
    """Advanced security scanner for Odoo modules with Chilean compliance focus"""

    def __init__(self, module_path: str):
        self.module_path = Path(module_path)
        self.vulnerabilities = []
        self.security_score = 100
        self.compliance_issues = []

        # OWASP Top 10 patterns
        self.vulnerability_patterns = {
            'sql_injection': {
                'patterns': [
                    r'\.execute\([^,]*%[^,]*\)',  # SQL with % formatting
                    r'\.execute\([^,]*\+[^,]*\)',  # SQL with concatenation
                    r'\.execute\([^,]*\.format\(',  # SQL with .format()
                    r'\.execute\(f["\']',  # SQL with f-strings
                    r'SELECT.*FROM.*WHERE.*\+',  # Direct SQL concatenation
                ],
                'severity': 'CRITICAL',
                'description': 'Possible SQL injection vulnerability'
            },
            'xss': {
                'patterns': [
                    r'\.html\s*=.*request\.',  # Direct HTML from request
                    r'Markup\([^)]*request\.',  # Markup with request data
                    r'\.innerHTML\s*=',  # Direct innerHTML assignment
                    r'document\.write\(',  # document.write usage
                    r'\|safe(?!\w)',  # |safe filter in templates
                ],
                'severity': 'HIGH',
                'description': 'Possible XSS vulnerability'
            },
            'command_injection': {
                'patterns': [
                    r'os\.system\(',
                    r'subprocess\.call\([^,]*shell=True',
                    r'eval\(',
                    r'exec\(',
                    r'__import__\(',
                ],
                'severity': 'CRITICAL',
                'description': 'Possible command injection vulnerability'
            },
            'insecure_deserialization': {
                'patterns': [
                    r'pickle\.loads\(',
                    r'yaml\.load\([^,]*Loader=yaml\.Loader',
                    r'eval\(.*json',
                    r'ast\.literal_eval\(.*request',
                ],
                'severity': 'HIGH',
                'description': 'Insecure deserialization detected'
            },
            'hardcoded_secrets': {
                'patterns': [
                    r'password\s*=\s*["\'][^"\']{8,}',
                    r'secret\s*=\s*["\'][^"\']{8,}',
                    r'api_key\s*=\s*["\'][^"\']{8,}',
                    r'token\s*=\s*["\'][^"\']{8,}',
                    r'private_key\s*=\s*["\']',
                ],
                'severity': 'HIGH',
                'description': 'Hardcoded credentials or secrets detected'
            },
            'weak_crypto': {
                'patterns': [
                    r'hashlib\.md5\(',
                    r'hashlib\.sha1\(',
                    r'DES\.',
                    r'Random\(\)',  # Non-cryptographic random
                    r'random\.',
                ],
                'severity': 'MEDIUM',
                'description': 'Weak cryptographic algorithm detected'
            },
            'missing_access_control': {
                'patterns': [
                    r'\.sudo\(\)(?!\.with_context)',  # sudo without context
                    r'auth=["\']public["\'].*type=["\']json',  # Public JSON endpoints
                    r'@http\.route.*auth=["\']none',  # No authentication
                    r'\.search\(\[\]\)',  # Search all records
                ],
                'severity': 'HIGH',
                'description': 'Missing or weak access control'
            },
            'path_traversal': {
                'patterns': [
                    r'open\([^)]*request\.',
                    r'\.\./',
                    r'os\.path\.join\([^)]*request',
                    r'send_file\([^)]*request',
                ],
                'severity': 'HIGH',
                'description': 'Possible path traversal vulnerability'
            },
            'csrf': {
                'patterns': [
                    r'csrf=False',
                    r'@http\.route.*methods=\[[^]]*POST[^]]*\](?!.*csrf)',
                ],
                'severity': 'MEDIUM',
                'description': 'CSRF protection disabled'
            },
            'sensitive_data_exposure': {
                'patterns': [
                    r'_logger\.(error|critical|warning)\([^)]*password',
                    r'print\([^)]*token',
                    r'console\.log\([^)]*secret',
                ],
                'severity': 'MEDIUM',
                'description': 'Sensitive data in logs'
            }
        }

        # Chilean compliance patterns
        self.chilean_compliance_patterns = {
            'rut_validation': {
                'patterns': [
                    r'rut(?!.*validate)',  # RUT without validation
                    r'vat(?!.*check)',  # VAT without check
                ],
                'severity': 'MEDIUM',
                'description': 'RUT/VAT validation missing'
            },
            'sii_certificate': {
                'patterns': [
                    r'certificate(?!.*encrypt)',  # Certificate without encryption
                    r'private_key(?!.*protected)',  # Unprotected private key
                ],
                'severity': 'HIGH',
                'description': 'SII certificate security issue'
            },
            'f29_f22_audit': {
                'patterns': [
                    r'class.*F29(?!.*mail\.thread)',  # F29 without audit trail
                    r'class.*F22(?!.*mail\.thread)',  # F22 without audit trail
                ],
                'severity': 'HIGH',
                'description': 'Tax form without audit trail'
            },
            'data_retention': {
                'patterns': [
                    r'unlink\(\)(?!.*check)',  # Delete without checks
                    r'DELETE FROM(?!.*audit)',  # Direct delete without audit
                ],
                'severity': 'MEDIUM',
                'description': 'Data retention compliance issue'
            }
        }

    def scan(self) -> Dict[str, Any]:
        """Run comprehensive security scan"""
        logger.info(f"Starting security scan for {self.module_path}")

        # Scan Python files
        self._scan_python_files()

        # Scan XML files
        self._scan_xml_files()

        # Scan JavaScript files
        self._scan_javascript_files()

        # Check security configurations
        self._check_security_configs()

        # Check access rights
        self._check_access_rights()

        # Check Chilean compliance
        self._check_chilean_compliance()

        # Generate report
        return self._generate_report()

    def _scan_python_files(self):
        """Scan Python files for vulnerabilities"""
        python_files = list(self.module_path.rglob('*.py'))

        for file_path in python_files:
            if '__pycache__' in str(file_path):
                continue

            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    content = f.read()

                # Check vulnerability patterns
                for vuln_type, config in self.vulnerability_patterns.items():
                    for pattern in config['patterns']:
                        matches = re.finditer(pattern, content, re.IGNORECASE | re.MULTILINE)
                        for match in matches:
                            line_num = content[:match.start()].count('\n') + 1
                            self._add_vulnerability(
                                file_path=str(file_path.relative_to(self.module_path)),
                                line=line_num,
                                type=vuln_type,
                                severity=config['severity'],
                                description=config['description'],
                                code_snippet=self._get_code_snippet(content, line_num)
                            )

                # AST analysis for deeper inspection
                self._analyze_python_ast(file_path, content)

            except Exception as e:
                logger.error(f"Error scanning {file_path}: {e}")

    def _analyze_python_ast(self, file_path: Path, content: str):
        """Analyze Python AST for security issues"""
        try:
            tree = ast.parse(content)

            class SecurityVisitor(ast.NodeVisitor):
                def __init__(self, scanner, file_path):
                    self.scanner = scanner
                    self.file_path = file_path

                def visit_Call(self, node):
                    # Check for dangerous functions
                    if isinstance(node.func, ast.Name):
                        if node.func.id in ['eval', 'exec', '__import__']:
                            self.scanner._add_vulnerability(
                                file_path=str(file_path.relative_to(self.scanner.module_path)),
                                line=node.lineno,
                                type='dangerous_function',
                                severity='HIGH',
                                description=f'Dangerous function {node.func.id} used',
                                code_snippet=f'{node.func.id}(...)'
                            )

                    # Check for .sudo() without proper context
                    if isinstance(node.func, ast.Attribute):
                        if node.func.attr == 'sudo':
                            # Check if followed by with_context
                            parent = getattr(node, '_parent', None)
                            if parent and not self._has_with_context(parent):
                                self.scanner._add_vulnerability(
                                    file_path=str(file_path.relative_to(self.scanner.module_path)),
                                    line=node.lineno,
                                    type='unsafe_sudo',
                                    severity='MEDIUM',
                                    description='sudo() used without proper context',
                                    code_snippet='....sudo()'
                                )

                    self.generic_visit(node)

                def _has_with_context(self, node):
                    """Check if node has .with_context() call"""
                    if isinstance(node, ast.Call) and isinstance(node.func, ast.Attribute):
                        if node.func.attr == 'with_context':
                            return True
                    return False

            visitor = SecurityVisitor(self, file_path)

            # Add parent references for context
            for node in ast.walk(tree):
                for child in ast.iter_child_nodes(node):
                    child._parent = node

            visitor.visit(tree)

        except SyntaxError:
            pass  # Ignore syntax errors in analysis

    def _scan_xml_files(self):
        """Scan XML files for security issues"""
        xml_files = list(self.module_path.rglob('*.xml'))

        for file_path in xml_files:
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    content = f.read()

                # Check for unsafe eval in XML
                if 'eval=' in content:
                    # Check for dangerous eval expressions
                    eval_pattern = r'eval=["\']([^"\']+)["\']'
                    matches = re.finditer(eval_pattern, content)
                    for match in matches:
                        eval_expr = match.group(1)
                        if any(danger in eval_expr for danger in ['__', 'import', 'exec', 'eval']):
                            line_num = content[:match.start()].count('\n') + 1
                            self._add_vulnerability(
                                file_path=str(file_path.relative_to(self.module_path)),
                                line=line_num,
                                type='unsafe_eval_xml',
                                severity='HIGH',
                                description='Unsafe eval expression in XML',
                                code_snippet=match.group(0)
                            )

                # Check for missing noupdate in security data
                if 'security' in str(file_path) and 'noupdate="1"' not in content:
                    self._add_vulnerability(
                        file_path=str(file_path.relative_to(self.module_path)),
                        line=1,
                        type='missing_noupdate',
                        severity='LOW',
                        description='Security data without noupdate="1"',
                        code_snippet='<data> missing noupdate="1"'
                    )

            except Exception as e:
                logger.error(f"Error scanning {file_path}: {e}")

    def _scan_javascript_files(self):
        """Scan JavaScript files for client-side vulnerabilities"""
        js_files = list(self.module_path.rglob('*.js'))

        js_patterns = {
            'dom_xss': [
                r'\.innerHTML\s*=',
                r'\.outerHTML\s*=',
                r'document\.write\(',
                r'\.insertAdjacentHTML\(',
            ],
            'unsafe_jquery': [
                r'\$\([^)]*\)\.html\(',
                r'\$\([^)]*\)\.append\([^)]*\+',
            ],
            'sensitive_storage': [
                r'localStorage\.setItem\([^)]*password',
                r'sessionStorage\.[^(]*password',
            ]
        }

        for file_path in js_files:
            if 'node_modules' in str(file_path):
                continue

            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    content = f.read()

                for vuln_type, patterns in js_patterns.items():
                    for pattern in patterns:
                        matches = re.finditer(pattern, content, re.IGNORECASE)
                        for match in matches:
                            line_num = content[:match.start()].count('\n') + 1
                            self._add_vulnerability(
                                file_path=str(file_path.relative_to(self.module_path)),
                                line=line_num,
                                type=vuln_type,
                                severity='MEDIUM',
                                description=f'Client-side vulnerability: {vuln_type}',
                                code_snippet=self._get_code_snippet(content, line_num)
                            )

            except Exception as e:
                logger.error(f"Error scanning {file_path}: {e}")

    def _check_security_configs(self):
        """Check security configuration files"""
        # Check ir.model.access.csv
        access_file = self.module_path / 'security' / 'ir.model.access.csv'
        if access_file.exists():
            with open(access_file, 'r') as f:
                content = f.read()
                lines = content.strip().split('\n')

                if len(lines) > 1:  # Has data beyond header
                    # Check for overly permissive access
                    for i, line in enumerate(lines[1:], 2):
                        parts = line.split(',')
                        if len(parts) >= 8:
                            # Check if public or portal users have write/create/unlink
                            if 'public' in parts[0].lower() or 'portal' in parts[0].lower():
                                if any(parts[j] == '1' for j in [5, 6, 7]):  # write, create, unlink
                                    self._add_vulnerability(
                                        file_path='security/ir.model.access.csv',
                                        line=i,
                                        type='overly_permissive_access',
                                        severity='HIGH',
                                        description='Public/Portal users have write access',
                                        code_snippet=line
                                    )

        # Check for missing security rules
        security_dir = self.module_path / 'security'
        if not security_dir.exists():
            self._add_vulnerability(
                file_path='',
                line=0,
                type='missing_security_dir',
                severity='HIGH',
                description='No security directory found',
                code_snippet='Missing /security directory'
            )

    def _check_access_rights(self):
        """Check access rights and record rules"""
        security_files = list((self.module_path / 'security').glob('*.xml')) if (self.module_path / 'security').exists() else []

        has_record_rules = False
        has_groups = False

        for file_path in security_files:
            with open(file_path, 'r') as f:
                content = f.read()
                if '<record model="ir.rule"' in content:
                    has_record_rules = True
                if '<record model="res.groups"' in content:
                    has_groups = True

        if not has_record_rules:
            self._add_vulnerability(
                file_path='security/',
                line=0,
                type='missing_record_rules',
                severity='MEDIUM',
                description='No record rules defined for data isolation',
                code_snippet='No ir.rule records found'
            )

        if not has_groups:
            self._add_vulnerability(
                file_path='security/',
                line=0,
                type='missing_groups',
                severity='LOW',
                description='No security groups defined',
                code_snippet='No res.groups records found'
            )

    def _check_chilean_compliance(self):
        """Check Chilean regulatory compliance"""
        # Check for F29/F22 models
        models_dir = self.module_path / 'models'
        if models_dir.exists():
            f29_found = False
            f22_found = False

            for py_file in models_dir.rglob('*.py'):
                with open(py_file, 'r') as f:
                    content = f.read()
                    if "class.*F29" in content or '_name.*f29' in content:
                        f29_found = True
                        # Check for audit trail
                        if 'mail.thread' not in content:
                            self._add_compliance_issue(
                                'F29 model without audit trail (mail.thread)',
                                'HIGH'
                            )

                    if "class.*F22" in content or '_name.*f22' in content:
                        f22_found = True
                        # Check for audit trail
                        if 'mail.thread' not in content:
                            self._add_compliance_issue(
                                'F22 model without audit trail (mail.thread)',
                                'HIGH'
                            )

            # Check for RUT validation
            rut_validation_found = False
            for py_file in models_dir.rglob('*.py'):
                with open(py_file, 'r') as f:
                    if 'validate.*rut' in f.read().lower():
                        rut_validation_found = True
                        break

            if not rut_validation_found and (f29_found or f22_found):
                self._add_compliance_issue(
                    'Tax forms without RUT validation implementation',
                    'MEDIUM'
                )

    def _add_vulnerability(self, file_path: str, line: int, type: str,
                          severity: str, description: str, code_snippet: str):
        """Add vulnerability to the list"""
        vuln = {
            'file': file_path,
            'line': line,
            'type': type,
            'severity': severity,
            'description': description,
            'code_snippet': code_snippet[:200] if len(code_snippet) > 200 else code_snippet
        }
        self.vulnerabilities.append(vuln)

        # Update security score
        severity_impact = {
            'CRITICAL': 20,
            'HIGH': 10,
            'MEDIUM': 5,
            'LOW': 2
        }
        self.security_score -= severity_impact.get(severity, 0)
        self.security_score = max(0, self.security_score)

    def _add_compliance_issue(self, description: str, severity: str):
        """Add compliance issue"""
        self.compliance_issues.append({
            'description': description,
            'severity': severity
        })

    def _get_code_snippet(self, content: str, line_num: int) -> str:
        """Get code snippet around the vulnerability"""
        lines = content.split('\n')
        start = max(0, line_num - 2)
        end = min(len(lines), line_num + 1)
        return '\n'.join(lines[start:end])

    def _generate_report(self) -> Dict[str, Any]:
        """Generate comprehensive security report"""
        # Group vulnerabilities by severity
        critical = [v for v in self.vulnerabilities if v['severity'] == 'CRITICAL']
        high = [v for v in self.vulnerabilities if v['severity'] == 'HIGH']
        medium = [v for v in self.vulnerabilities if v['severity'] == 'MEDIUM']
        low = [v for v in self.vulnerabilities if v['severity'] == 'LOW']

        # Group by type
        by_type = {}
        for vuln in self.vulnerabilities:
            if vuln['type'] not in by_type:
                by_type[vuln['type']] = []
            by_type[vuln['type']].append(vuln)

        report = {
            'module': str(self.module_path.name),
            'scan_date': datetime.now().isoformat(),
            'security_score': self.security_score,
            'total_vulnerabilities': len(self.vulnerabilities),
            'summary': {
                'critical': len(critical),
                'high': len(high),
                'medium': len(medium),
                'low': len(low)
            },
            'vulnerabilities_by_severity': {
                'critical': critical,
                'high': high,
                'medium': medium,
                'low': low
            },
            'vulnerabilities_by_type': by_type,
            'compliance_issues': self.compliance_issues,
            'recommendations': self._generate_recommendations()
        }

        return report

    def _generate_recommendations(self) -> List[str]:
        """Generate security recommendations based on findings"""
        recommendations = []

        if any(v['type'] == 'sql_injection' for v in self.vulnerabilities):
            recommendations.append("Use parameterized queries instead of string formatting in SQL")

        if any(v['type'] == 'xss' for v in self.vulnerabilities):
            recommendations.append("Sanitize all user input and use safe rendering methods")

        if any(v['type'] == 'missing_access_control' for v in self.vulnerabilities):
            recommendations.append("Implement proper access control with record rules and groups")

        if any(v['type'] == 'hardcoded_secrets' for v in self.vulnerabilities):
            recommendations.append("Move secrets to environment variables or secure configuration")

        if any(v['type'] == 'weak_crypto' for v in self.vulnerabilities):
            recommendations.append("Use strong cryptographic algorithms (SHA256+, AES256)")

        if self.compliance_issues:
            recommendations.append("Implement audit trails for tax forms using mail.thread")
            recommendations.append("Add RUT validation for all Chilean tax documents")

        if self.security_score < 50:
            recommendations.append("URGENT: Address critical and high severity issues immediately")

        recommendations.append("Implement security testing in CI/CD pipeline")
        recommendations.append("Conduct regular security audits and penetration testing")

        return recommendations


def main():
    """Main execution function"""
    import argparse

    parser = argparse.ArgumentParser(description='Security Vulnerability Scanner for Odoo Modules')
    parser.add_argument('module_path', help='Path to the Odoo module')
    parser.add_argument('--output', '-o', help='Output file for report (JSON)', default='security_report.json')
    parser.add_argument('--format', '-f', choices=['json', 'html', 'markdown'], default='json', help='Output format')

    args = parser.parse_args()

    # Run scan
    scanner = SecurityVulnerabilityScanner(args.module_path)
    report = scanner.scan()

    # Save report
    if args.format == 'json':
        with open(args.output, 'w') as f:
            json.dump(report, f, indent=2, default=str)
        logger.info(f"Security report saved to {args.output}")

    # Print summary
    print("\n" + "="*60)
    print("SECURITY SCAN SUMMARY")
    print("="*60)
    print(f"Module: {report['module']}")
    print(f"Security Score: {report['security_score']}/100")
    print(f"Total Vulnerabilities: {report['total_vulnerabilities']}")
    print(f"  - Critical: {report['summary']['critical']}")
    print(f"  - High: {report['summary']['high']}")
    print(f"  - Medium: {report['summary']['medium']}")
    print(f"  - Low: {report['summary']['low']}")
    print(f"Compliance Issues: {len(report['compliance_issues'])}")

    if report['summary']['critical'] > 0:
        print("\n⚠️  CRITICAL VULNERABILITIES FOUND - IMMEDIATE ACTION REQUIRED")

    print("\nTop Recommendations:")
    for i, rec in enumerate(report['recommendations'][:5], 1):
        print(f"  {i}. {rec}")

    return 0 if report['security_score'] >= 70 else 1


if __name__ == '__main__':
    exit(main())
