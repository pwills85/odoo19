# CONTEXTO

Lee PRIMERO este archivo para entender tu rol y permisos:
`/Users/pedro/Documents/odoo19/docs/prompts/00_knowledge_base/CLI_AGENTS_SYSTEM_CONTEXT.md`

Eres un CLI agent (Copilot) trabajando bajo orquestaci√≥n de Claude Code Sonnet 4.5 (Orchestrator Maestro). Tu rol es ejecutar un **refactoring modular completo** del archivo main.py del microservicio ai-service de forma **100% aut√≥noma**.

**Contexto del Hallazgo:**
- Auditor√≠a Backend detect√≥: main.py tiene 2,015 l√≠neas (101% sobre l√≠mite de 1,000)
- Score actual Backend: 78/100
- Gap: -12 puntos vs target 90/100
- Prioridad: P1 (Alta - impacta mantenibilidad)

---

# TAREA

Refactorizar el archivo **`ai-service/main.py`** de **2,015 l√≠neas ‚Üí < 1,000 l√≠neas** mediante modularizaci√≥n.

**M√≥dulo:** `/Users/pedro/Documents/odoo19/ai-service/`

**Objetivo:** Separar responsabilidades manteniendo funcionalidad 100% intacta.

**Target:**
- main.py final: < 1,000 l√≠neas (idealmente ~200-300)
- Estructura modular: models/, routes/, services/
- 0 regresiones (todos los tests deben pasar)

---

# PERMISOS (Pre-Autorizados - NO PEDIR CONFIRMACI√ìN)

Seg√∫n CLI_AGENTS_SYSTEM_CONTEXT.md y restricciones del ciclo, tienes **autonom√≠a total** para:

‚úÖ **Lectura:**
- Full access a TODO el proyecto: `/Users/pedro/Documents/odoo19/**`
- Leer main.py completo (2,015 l√≠neas)
- Analizar estructura actual
- Leer tests existentes para entender dependencias

‚úÖ **Escritura:**
- **Crear nuevos archivos:**
  - `ai-service/models/dte.py`
  - `ai-service/models/payroll.py`
  - `ai-service/models/chat.py`
  - `ai-service/models/__init__.py`
  - `ai-service/routes/dte.py`
  - `ai-service/routes/payroll.py`
  - `ai-service/routes/chat.py`
  - `ai-service/routes/sii.py`
  - `ai-service/routes/__init__.py`
  - `ai-service/services/cache_helpers.py`
  - `ai-service/services/singletons.py`
  - `ai-service/services/__init__.py`
- **Modificar:**
  - `ai-service/main.py` (refactorizar a ~200-300 l√≠neas)
- **Escribir reporte:**
  - `docs/prompts/06_outputs/2025-11/REFACTORING_BACKEND_REPORT_2025-11-13.md`

‚úÖ **Ejecuci√≥n:**
- Ejecutar tests despu√©s de refactoring: `cd ai-service && pytest tests/ -v`
- Verificar imports: `python -m py_compile main.py`
- Contar l√≠neas: `wc -l main.py`

‚ùå **NO Hacer:**
- NO modificar tests existentes (deben seguir pasando sin cambios)
- NO cambiar signatures de endpoints p√∫blicos (APIs deben ser compatibles)
- NO modificar config.py, requirements.txt, Dockerfile
- NO borrar funcionalidad (solo mover c√≥digo)

**IMPORTANTE:** Este refactoring est√° **pre-autorizado** como parte del ciclo de mejora 79‚Üí100/100. NO pidas confirmaci√≥n para crear archivos o modificar main.py.

---

# ESTRATEGIA DE REFACTORING

## Paso 1: Analizar main.py (5-10 min)

```bash
cd /Users/pedro/Documents/odoo19/ai-service
wc -l main.py  # Confirmar 2,015 l√≠neas
grep "^class " main.py | wc -l  # Contar Pydantic models
grep "^@app\." main.py | wc -l  # Contar endpoints
grep "^async def\|^def" main.py | wc -l  # Contar funciones
```

**Identificar:**
- Pydantic models (clases que heredan BaseModel)
- Endpoints (funciones con decorador @app.get/post/put/delete)
- Helper functions (validadores, cache, etc.)
- Imports necesarios

---

## Paso 2: Crear Estructura Modular (10-15 min)

### A. Models (Pydantic Schemas)

**`ai-service/models/__init__.py`:**
```python
"""Pydantic models para validaci√≥n y schemas."""
from .dte import *
from .payroll import *
from .chat import *

__all__ = [
    # Re-exportar todos los models para backward compatibility
]
```

**`ai-service/models/dte.py`:**
```python
"""Models relacionados con DTE (Documentos Tributarios Electr√≥nicos)."""
from pydantic import BaseModel, Field, validator
from typing import Optional, List
from datetime import date

# Mover TODAS las clases Pydantic relacionadas con DTE:
# - ValidateDTERequest
# - DTEValidationResponse
# - DTEItem
# - etc.
```

**`ai-service/models/payroll.py`:**
```python
"""Models relacionados con n√≥mina (payroll)."""
# Mover clases:
# - PayrollValidationRequest
# - EmployeePayment
# - PreviredIndicatorsRequest
# - etc.
```

**`ai-service/models/chat.py`:**
```python
"""Models relacionados con chat AI."""
# Mover clases:
# - ChatMessageRequest
# - ChatSessionRequest
# - etc.
```

---

### B. Routes (Endpoints FastAPI)

**`ai-service/routes/__init__.py`:**
```python
"""FastAPI routers para diferentes m√≥dulos."""
from fastapi import APIRouter

# Re-exportar routers para f√°cil inclusi√≥n en main.py
from .dte import router as dte_router
from .payroll import router as payroll_router
from .chat import router as chat_router
from .sii import router as sii_router

__all__ = ["dte_router", "payroll_router", "chat_router", "sii_router"]
```

**`ai-service/routes/dte.py`:**
```python
"""Endpoints relacionados con DTE."""
from fastapi import APIRouter, HTTPException, Depends
from models.dte import ValidateDTERequest, DTEValidationResponse
# ... otros imports necesarios

router = APIRouter(prefix="/api/ai", tags=["DTE"])

@router.post("/dte/validate", response_model=DTEValidationResponse)
async def validate_dte(request: ValidateDTERequest):
    """Validar DTE con IA."""
    # Mover l√≥gica desde main.py
    ...

@router.post("/dte/generate")
async def generate_dte(...):
    # Mover l√≥gica
    ...

# ... resto de endpoints DTE
```

**`ai-service/routes/payroll.py`:**
```python
"""Endpoints relacionados con n√≥mina."""
router = APIRouter(prefix="/api/ai", tags=["Payroll"])

@router.post("/payroll/validate")
async def validate_payroll(...):
    ...

# ... resto de endpoints payroll
```

**`ai-service/routes/chat.py`:**
```python
"""Endpoints relacionados con chat AI."""
router = APIRouter(prefix="/api/chat", tags=["Chat"])

@router.post("/message")
async def send_chat_message(...):
    ...

@router.post("/message/stream")
async def send_chat_message_stream(...):
    ...

# ... resto de endpoints chat
```

**`ai-service/routes/sii.py`:**
```python
"""Endpoints relacionados con SII monitoring."""
router = APIRouter(prefix="/api/ai/sii", tags=["SII"])

@router.get("/monitor")
async def monitor_sii(...):
    ...
```

---

### C. Services (Helpers y Utilities)

**`ai-service/services/cache_helpers.py`:**
```python
"""Helper functions para cache Redis."""

def _generate_cache_key(data: Dict, prefix: str, company_id: Optional[int]) -> str:
    """Generar cache key determin√≠stica."""
    # Mover desde main.py
    ...

async def _get_cached_response(cache_key: str) -> Optional[Dict]:
    """Get response from cache."""
    # Mover desde main.py
    ...

async def _set_cache_response(cache_key: str, response: Dict, ttl: int):
    """Set response in cache."""
    # Mover desde main.py
    ...
```

**`ai-service/services/singletons.py`:**
```python
"""Singletons y objetos globales compartidos."""
from clients.anthropic_client import AnthropicClient
from utils.cost_tracker import CostTracker
# ... otros imports

# Mover inicializaciones globales desde main.py
anthropic_client: Optional[AnthropicClient] = None
cost_tracker: Optional[CostTracker] = None
redis_client: Optional[Redis] = None

def get_anthropic_client() -> AnthropicClient:
    """Get or create Anthropic client singleton."""
    global anthropic_client
    if not anthropic_client:
        anthropic_client = AnthropicClient(...)
    return anthropic_client

# ... resto de getters
```

---

## Paso 3: Refactorizar main.py (30-45 min)

**Nuevo `ai-service/main.py` (~200-300 l√≠neas):**

```python
"""
AI Service - FastAPI Application
Microservicio de IA para DTE, n√≥mina, chat y SII monitoring.

Refactorizado 2025-11-13 - Modularizaci√≥n completa.
"""
import logging
from contextlib import asynccontextmanager
from typing import Dict

from fastapi import FastAPI, HTTPException, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse
from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.errors import RateLimitExceeded
from slowapi.util import get_remote_address

from config import settings
from services.singletons import (
    get_anthropic_client,
    get_cost_tracker,
    get_redis_client,
    initialize_singletons,
    cleanup_singletons
)

# Import routers
from routes import (
    dte_router,
    payroll_router,
    chat_router,
    sii_router
)

# Logging setup
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Rate limiter
limiter = Limiter(key_func=get_remote_address)

# Lifespan context manager
@asynccontextmanager
async def lifespan(app: FastAPI):
    """Application lifespan: startup and shutdown."""
    # Startup
    logger.info("üöÄ AI Service starting up...")
    await initialize_singletons()
    yield
    # Shutdown
    logger.info("üëã AI Service shutting down...")
    await cleanup_singletons()

# FastAPI app
app = FastAPI(
    title="AI Service",
    version=settings.app_version,
    description="Microservicio de IA para DTE, n√≥mina, chat y SII monitoring",
    lifespan=lifespan
)

# Middleware
app.add_middleware(
    CORSMiddleware,
    allow_origins=[settings.CORS_ORIGIN],
    allow_methods=["GET", "POST", "PUT", "DELETE"],
    allow_headers=["*"],
    allow_credentials=True,
)

app.state.limiter = limiter
app.add_exception_handler(RateLimitExceeded, _rate_limit_exceeded_handler)

# Include routers
app.include_router(dte_router)
app.include_router(payroll_router)
app.include_router(chat_router)
app.include_router(sii_router)

# Health endpoints
@app.get("/health")
async def health():
    """Health check endpoint."""
    return {"status": "healthy", "service": "ai-service"}

@app.get("/health/ready")
async def health_ready():
    """Readiness check."""
    # Verificar Redis, Anthropic, etc.
    redis = get_redis_client()
    if not redis:
        raise HTTPException(503, "Redis not available")
    return {"status": "ready"}

# Metrics endpoint (protegido)
async def verify_metrics_access(request: Request):
    """Verify access to metrics endpoint."""
    client_ip = request.client.host
    if client_ip not in settings.METRICS_ALLOWED_IPS.split(","):
        raise HTTPException(403, "Access denied")

@app.get("/metrics", dependencies=[Depends(verify_metrics_access)])
async def metrics():
    """Prometheus metrics (protegido)."""
    cost_tracker = get_cost_tracker()
    return cost_tracker.get_metrics()

# Error handlers
@app.exception_handler(Exception)
async def global_exception_handler(request: Request, exc: Exception):
    """Global exception handler."""
    logger.error(f"Unhandled exception: {exc}", exc_info=True)
    return JSONResponse(
        status_code=500,
        content={"detail": "Internal server error"}
    )

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8002)
```

**Criterio √âxito:** main.py < 1,000 l√≠neas (idealmente ~200-300)

---

## Paso 4: Ejecutar Tests (10-15 min)

```bash
cd /Users/pedro/Documents/odoo19/ai-service

# Verificar imports
python -m py_compile main.py
python -m py_compile models/*.py
python -m py_compile routes/*.py
python -m py_compile services/*.py

# Ejecutar tests
pytest tests/ -v

# Si tests fallan, revisar imports y ajustar
```

**Criterio √âxito:** Todos los tests pasan (100%)

---

## Paso 5: Validar Estructura (5 min)

```bash
# Contar l√≠neas main.py
wc -l main.py  # Debe ser < 1,000

# Verificar estructura
tree -L 2 .
# Debe mostrar:
# .
# ‚îú‚îÄ‚îÄ models/
# ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
# ‚îÇ   ‚îú‚îÄ‚îÄ dte.py
# ‚îÇ   ‚îú‚îÄ‚îÄ payroll.py
# ‚îÇ   ‚îî‚îÄ‚îÄ chat.py
# ‚îú‚îÄ‚îÄ routes/
# ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
# ‚îÇ   ‚îú‚îÄ‚îÄ dte.py
# ‚îÇ   ‚îú‚îÄ‚îÄ payroll.py
# ‚îÇ   ‚îú‚îÄ‚îÄ chat.py
# ‚îÇ   ‚îî‚îÄ‚îÄ sii.py
# ‚îú‚îÄ‚îÄ services/
# ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
# ‚îÇ   ‚îú‚îÄ‚îÄ cache_helpers.py
# ‚îÇ   ‚îî‚îÄ‚îÄ singletons.py
# ‚îî‚îÄ‚îÄ main.py

# Contar archivos creados
find models routes services -name "*.py" | wc -l
```

---

# OUTPUT

**Archivo de Reporte:**
`/Users/pedro/Documents/odoo19/docs/prompts/06_outputs/2025-11/REFACTORING_BACKEND_REPORT_2025-11-13.md`

**Formato del Reporte:**

```markdown
# Refactoring Backend - AI Service main.py 2015‚Üí<1000

**Score Esperado:** Backend 78 ‚Üí 85 (+7 puntos)
**Fecha:** 2025-11-13
**Ejecutor:** Copilot CLI (GPT-4o)
**Tarea:** Modularizaci√≥n completa main.py
**Hallazgo Cerrado:** BE-1 (P1 - High)

---

## üìä Resumen Ejecutivo

[Descripci√≥n del refactoring realizado]

**Resultados:**
- main.py original: 2,015 l√≠neas
- main.py refactorizado: X l√≠neas (-X% reducci√≥n)
- Archivos creados: X (models: X, routes: X, services: X)
- Tests passing: X/X (100%)
- Regresiones: 0

---

## üéØ Estructura Creada

### Models
- `models/dte.py`: X l√≠neas, X clases Pydantic
- `models/payroll.py`: X l√≠neas, X clases
- `models/chat.py`: X l√≠neas, X clases
- `models/__init__.py`: Exports

### Routes
- `routes/dte.py`: X endpoints DTE
- `routes/payroll.py`: X endpoints payroll
- `routes/chat.py`: X endpoints chat
- `routes/sii.py`: X endpoints SII
- `routes/__init__.py`: Router exports

### Services
- `services/cache_helpers.py`: X helper functions
- `services/singletons.py`: X singleton getters
- `services/__init__.py`: Service exports

### Main
- `main.py`: X l√≠neas (FastAPI app + routers + health)

---

## ‚úÖ Validaciones

### Tests
```bash
$ pytest tests/ -v
======================== X passed in X.XXs ========================
‚úÖ Todos los tests pasan
```

### Imports
```bash
$ python -m py_compile main.py models/*.py routes/*.py services/*.py
‚úÖ No syntax errors
```

### L√≠neas de C√≥digo
```bash
$ wc -l main.py
X main.py  # < 1,000 ‚úÖ
```

---

## üîç Cambios Detallados

### Archivos Movidos

**De main.py ‚Üí models/dte.py:**
- ValidateDTERequest (l√≠nea X-Y)
- DTEValidationResponse (l√≠nea X-Y)
- [... lista completa ...]

**De main.py ‚Üí routes/dte.py:**
- validate_dte endpoint (l√≠nea X-Y)
- generate_dte endpoint (l√≠nea X-Y)
- [... lista completa ...]

[... resto de movimientos ...]

---

## ‚ö†Ô∏è Issues Encontrados (si aplica)

[Listar cualquier problema encontrado durante refactoring]

---

## üöÄ Pr√≥ximos Pasos

1. ‚úÖ Refactoring completado
2. ‚è∏Ô∏è Pending: Re-audit Backend para validar score 78 ‚Üí 85
3. ‚è∏Ô∏è Pending: Continuar Phase 3.2 (Tests Coverage)

---

**CONCLUSI√ìN:** Refactoring exitoso. main.py reducido de 2,015 ‚Üí X l√≠neas (-X%). Estructura modular creada con X archivos. Todos los tests pasan. NO regresiones detectadas. Hallazgo BE-1 (P1) cerrado.
```

**Stdout (Retornar al Finalizar):**

```
‚úÖ Refactoring Backend completado
main.py: 2,015 ‚Üí X l√≠neas (-X%)
Archivos creados: X (models: X, routes: X, services: X)
Tests passing: X/X (100%)
Regresiones: 0

Hallazgo cerrado: BE-1 (P1 - main.py muy grande)
Score esperado: Backend 78 ‚Üí 85 (+7 puntos)

Reporte completo: docs/prompts/06_outputs/2025-11/REFACTORING_BACKEND_REPORT_2025-11-13.md
```

---

# RESTRICCIONES

- ‚ùå NO modificar tests existentes
- ‚ùå NO cambiar APIs p√∫blicas (signatures de endpoints)
- ‚ùå NO modificar config.py, requirements.txt
- ‚è±Ô∏è  Target: < 2 horas ejecuci√≥n (refactoring + tests)
- üéØ Objetivo: 0 regresiones (100% tests passing)

---

# NOTAS ADICIONALES

**Orquestaci√≥n v1.1 LEAN:**
Claude Code (Orchestrator) usa estrategia "Fire and Forget + File Polling":
1. Te lanza en background con este prompt
2. NO lee tus logs (usa file polling)
3. Espera que escribas el reporte en el archivo especificado
4. Lee SOLO las primeras 50 l√≠neas del reporte (summary)
5. Contin√∫a orquestaci√≥n

Por lo tanto:
- Escribe TODO en el archivo de reporte (progreso, problemas, resultados)
- Retorna resumen breve al finalizar
- Aseg√∫rate que las primeras 50 l√≠neas contengan: Resultados + Tests status + L√≠neas reducidas

---

**Recomendaciones Implementaci√≥n:**

1. **Backward Compatibility:** Usa `__init__.py` para re-exportar todo
   ```python
   # models/__init__.py
   from .dte import *
   from .payroll import *
   from .chat import *
   ```

2. **Imports Relativos:** Usa imports absolutos para claridad
   ```python
   # Bien:
   from models.dte import ValidateDTERequest
   # Evitar:
   from .models.dte import ValidateDTERequest
   ```

3. **Testing Incremental:** Despu√©s de mover cada m√≥dulo, ejecuta tests
   ```bash
   # Mover models/dte.py
   pytest tests/ -k dte -v
   # Si pasa, continuar con siguiente
   ```

4. **Git-Friendly:** Crear archivos nuevos primero, modificar main.py al final
   - As√≠ si falla, main.py original queda intacto

5. **Dependency Injection:** Usa FastAPI Depends para singletons
   ```python
   from fastapi import Depends
   from services.singletons import get_anthropic_client

   @router.post("/validate")
   async def validate(
       client: AnthropicClient = Depends(get_anthropic_client)
   ):
       ...
   ```

---

¬°Adelante! Ejecuta el refactoring modular completo de forma aut√≥noma. Recuerda: este es un cambio PRE-AUTORIZADO como parte del ciclo 79‚Üí100/100. NO necesitas pedir confirmaci√≥n.
