# Auditoría Backend - AI Service Microservice

**ROL:** Agente Auditor Backend Experto en Python/FastAPI

**OBJETIVO:** Auditar calidad de código Python, patrones FastAPI, error handling y arquitectura del microservicio ai-service

**MÓDULO EN ALCANCE:**
- `/Users/pedro/Documents/odoo19/ai-service/`
- FastAPI application (main.py - 2015 líneas)
- 78 archivos Python totales

**CONTEXTO CRÍTICO:**
- Microservicio FastAPI 0.104.1 con Python 3.11+
- Antropic Claude API integration
- Redis Sentinel cluster
- Plugin architecture (multi-module support)
- 20+ endpoints REST + SSE streaming

**CRITERIOS DE AUDITORÍA:**

## 1. Código Python & Arquitectura

### 1.1 Complejidad y Tamaño
- ⚠️ **main.py tiene 2,015 líneas** - Evaluar si requiere refactoring (threshold: 1,000 líneas)
- Identificar funciones > 50 líneas (candidatas a refactor)
- Evaluar cohesión y acoplamiento entre módulos

### 1.2 Patrones FastAPI
- ✅ Dependency injection usado correctamente (`Depends()`)
- ✅ Pydantic models para validación (request/response)
- ✅ Async/await usado consistentemente
- ⚠️ Verificar que todos los endpoints tienen response_model
- ⚠️ Verificar que todos los endpoints tienen docstrings + examples

### 1.3 Error Handling
- ✅ Excepciones HTTP (`HTTPException`) usadas correctamente
- ✅ Try-catch blocks con logging estructurado (structlog)
- ⚠️ Verificar graceful degradation (ej: cache failures no rompen flujo)
- ⚠️ Validar que errors NO exponen stack traces en producción

### 1.4 Código Limpio
- PEP8 compliance (black, isort, flake8)
- Type hints completos (mypy compatible)
- NO código comentado sin justificación
- NO imports no usados
- NO duplicación de lógica (DRY principle)

## 2. Funcionalidad Core

### 2.1 Anthropic Integration
- ✅ Cliente Anthropic usado correctamente (async)
- ✅ Prompt caching implementado (90% cost reduction)
- ✅ Token pre-counting habilitado (cost control)
- ✅ Streaming SSE implementado (3x better UX)

### 2.2 Redis Integration
- ✅ Redis Sentinel support (high availability)
- ✅ Cache helper functions con TTL
- ⚠️ Verificar que cache failures NO rompen flujo (graceful degradation)
- ⚠️ Validar que cache keys son deterministas

### 2.3 Plugin System
- ✅ Plugin registry funcionando
- ✅ Dynamic plugin loading
- ⚠️ Verificar error handling si plugin falla

## 3. Configuración

### 3.1 Settings (Pydantic)
- ✅ Todas las variables via environment variables
- ✅ Secrets NO hardcoded (API keys via env)
- ⚠️ **ENCONTRADO: Version mismatch** (README: 1.2.0, config.py: 1.0.0)

### 3.2 Feature Flags
- ✅ enable_prompt_caching, enable_streaming, enable_plugin_system

## 4. Logging & Observability
- ✅ Structlog para logging estructurado
- ✅ Middleware observability (ObservabilityMiddleware)
- ✅ Prometheus metrics endpoint
- ⚠️ Verificar que PII NO se loguea (RUT, nombres, sueldos)

**COMANDOS ÚTILES:**

```bash
# Análisis estático
cd /Users/pedro/Documents/odoo19/ai-service
flake8 . --max-line-length=120 --exclude=__pycache__,.venv
mypy . --ignore-missing-imports
black --check .
isort --check-only .

# Complejidad
radon cc . -a -nb --min B  # Funciones complejas (> B grade)

# Funciones largas
grep -rn "^def\|^async def" --include="*.py" | wc -l
```

**ENTREGABLE:**

Generar `AUDIT_BACKEND_AI_SERVICE_2025-11-13.md` con:

1. **Resumen Ejecutivo** (3-5 bullets críticos)

2. **Score Backend:** [X]/100
   - Python Quality: [X]/25
   - FastAPI Patterns: [X]/25
   - Error Handling: [X]/25
   - Architecture: [X]/25

3. **Matriz de Hallazgos:**

| ID | Archivo:Línea | Descripción | Criticidad | Recomendación |
|----|--------------|-------------|-----------|---------------|
| B1 | main.py:N | ... | P0/P1/P2/P3 | ... |

4. **Métricas:**
   - Funciones totales analizadas
   - Funciones > 50 líneas
   - Archivos > 500 líneas
   - Type hints coverage (%)
   - Duplicación de código (%)

**OUTPUT FORMAT (OBLIGATORIO):**

```markdown
**Score:** [N]/100

**Fecha:** 2025-11-13
**Auditor:** Copilot CLI (GPT-4o)
**Módulo:** ai-service
**Dimensión:** Backend

## Hallazgos

[P0] Critical finding description (file.py:123)
[P1] High priority finding (file.py:456)
[P2] Medium priority finding (file.py:789)
```

**RESTRICCIONES:**
- Modo solo lectura (NO modificar archivos)
- Basar análisis en código real del repositorio
- Priorizar hallazgos P0/P1 (críticos y altos)
- Incluir números de línea precisos
