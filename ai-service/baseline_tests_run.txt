2025-11-09 06:33:28 [info     ] circuit_breaker_initialized    failure_threshold=5 name=anthropic_api recovery_timeout=60.0
============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-8.4.2, pluggy-1.6.0 -- /usr/local/bin/python3.11
cachedir: .pytest_cache
rootdir: /app
configfile: pyproject.toml
testpaths: tests
plugins: asyncio-1.2.0, cov-7.0.0, anyio-3.7.1
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 185 items

tests/integration/test_critical_endpoints.py::TestDTEValidationEndpoint::test_validate_dte_success ERROR
tests/integration/test_critical_endpoints.py::TestDTEValidationEndpoint::test_validate_dte_invalid_tipo ERROR
tests/integration/test_critical_endpoints.py::TestDTEValidationEndpoint::test_validate_dte_negative_company_id ERROR
tests/integration/test_critical_endpoints.py::TestDTEValidationEndpoint::test_validate_dte_unauthorized ERROR
tests/integration/test_critical_endpoints.py::TestPOMatchingEndpoint::test_match_po_endpoint_exists ERROR
tests/integration/test_critical_endpoints.py::TestPOMatchingEndpoint::test_match_po_invalid_rut ERROR
tests/integration/test_critical_endpoints.py::TestPOMatchingEndpoint::test_match_po_invalid_monto ERROR
tests/integration/test_critical_endpoints.py::TestAnalyticsEndpoint::test_suggest_project_success ERROR
tests/integration/test_critical_endpoints.py::TestChatEndpoints::test_create_session ERROR
tests/integration/test_critical_endpoints.py::TestChatEndpoints::test_send_message_invalid_long ERROR
tests/integration/test_critical_endpoints.py::TestHealthEndpoint::test_health_check ERROR
tests/integration/test_critical_endpoints.py::TestRateLimiting::test_rate_limit_validation_endpoint ERROR
tests/integration/test_prompt_caching.py::TestPromptCachingIntegration::test_caching_endpoint_exists ERROR
tests/integration/test_prompt_caching.py::TestPromptCachingIntegration::test_caching_creates_cache_on_first_call ERROR
tests/integration/test_prompt_caching.py::TestPromptCachingIntegration::test_caching_reads_cache_on_second_call ERROR
tests/integration/test_prompt_caching.py::TestPromptCachingIntegration::test_caching_reduces_costs ERROR
tests/integration/test_prompt_caching.py::TestPromptCachingIntegration::test_cache_control_header_in_system_messages 2025-11-09 06:33:29 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
FAILED
tests/integration/test_prompt_caching.py::TestPromptCachingIntegration::test_caching_with_multiple_validations ERROR
tests/integration/test_prompt_caching.py::TestPromptCachingIntegration::test_cache_different_contexts ERROR
tests/integration/test_prompt_caching.py::TestPromptCachingIntegration::test_caching_preserves_validation_quality ERROR
tests/integration/test_prompt_caching.py::TestPromptCachingIntegration::test_caching_with_history ERROR
tests/integration/test_prompt_caching.py::TestPromptCachingIntegration::test_caching_error_handling ERROR
tests/integration/test_streaming_sse.py::TestStreamingSSEIntegration::test_streaming_endpoint_exists ERROR
tests/integration/test_streaming_sse.py::TestStreamingSSEIntegration::test_streaming_returns_sse_format ERROR
tests/integration/test_streaming_sse.py::TestStreamingSSEIntegration::test_streaming_progressive_tokens ERROR
tests/integration/test_streaming_sse.py::TestStreamingSSEIntegration::test_streaming_handles_errors_gracefully ERROR
tests/integration/test_streaming_sse.py::TestStreamingSSEIntegration::test_streaming_sends_done_event ERROR
tests/integration/test_streaming_sse.py::TestStreamingSSEIntegration::test_streaming_maintains_session_context ERROR
tests/integration/test_streaming_sse.py::TestStreamingSSEIntegration::test_streaming_with_knowledge_base_injection ERROR
tests/integration/test_streaming_sse.py::TestStreamingSSEIntegration::test_streaming_with_caching_metrics ERROR
tests/integration/test_streaming_sse.py::TestStreamingSSEIntegration::test_streaming_with_empty_response ERROR
tests/integration/test_streaming_sse.py::TestStreamingSSEIntegration::test_streaming_large_response ERROR
tests/integration/test_streaming_sse.py::TestStreamingSSEIntegration::test_streaming_respects_rate_limiting ERROR
tests/integration/test_token_precounting.py::TestTokenPrecountingIntegration::test_estimate_tokens_returns_valid_format 2025-11-09 06:33:29 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
2025-11-09 06:33:29 [info     ] token_estimation               estimated_cost=$0.001125 estimated_total=195 input_tokens=150
PASSED
tests/integration/test_token_precounting.py::TestTokenPrecountingIntegration::test_token_estimation_accuracy 2025-11-09 06:33:29 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
2025-11-09 06:33:29 [info     ] token_estimation               estimated_cost=$0.000105 estimated_total=19 input_tokens=15
PASSED
tests/integration/test_token_precounting.py::TestTokenPrecountingIntegration::test_precounting_prevents_oversized_requests 2025-11-09 06:33:29 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
2025-11-09 06:33:29 [info     ] token_estimation               estimated_cost=$1.875000 estimated_total=325000 input_tokens=250000
2025-11-09 06:33:29 [error    ] token_estimation_failed        error='Request too large: 325000 tokens (max 100000)'
PASSED
tests/integration/test_token_precounting.py::TestTokenPrecountingIntegration::test_precounting_validates_against_model_limits 2025-11-09 06:33:29 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
2025-11-09 06:33:29 [info     ] token_estimation               estimated_cost=$0.750000 estimated_total=130000 input_tokens=100000
2025-11-09 06:33:29 [error    ] token_estimation_failed        error='Request too large: 130000 tokens (max 100000)'
FAILED
tests/integration/test_token_precounting.py::TestTokenPrecountingIntegration::test_estimate_includes_system_prompt_overhead 2025-11-09 06:33:29 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
2025-11-09 06:33:29 [info     ] token_estimation               estimated_cost=$0.001500 estimated_total=260 input_tokens=200
PASSED
tests/integration/test_token_precounting.py::TestTokenPrecountingIntegration::test_cost_estimation_accuracy 2025-11-09 06:33:29 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
2025-11-09 06:33:29 [info     ] token_estimation               estimated_cost=$0.007500 estimated_total=1300 input_tokens=1000
PASSED
tests/integration/test_token_precounting.py::TestTokenPrecountingIntegration::test_precounting_with_conversation_history 2025-11-09 06:33:29 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
2025-11-09 06:33:29 [info     ] token_estimation               estimated_cost=$0.003750 estimated_total=650 input_tokens=500
PASSED
tests/integration/test_token_precounting.py::TestTokenPrecountingIntegration::test_precounting_prevents_expensive_requests 2025-11-09 06:33:29 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
2025-11-09 06:33:29 [info     ] token_estimation               estimated_cost=$0.750000 estimated_total=130000 input_tokens=100000
2025-11-09 06:33:29 [error    ] token_estimation_failed        error='Request too large: 130000 tokens (max 100000)'
FAILED
tests/integration/test_token_precounting.py::TestTokenPrecountingIntegration::test_token_counting_with_special_characters 2025-11-09 06:33:29 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
2025-11-09 06:33:29 [info     ] token_estimation               estimated_cost=$0.000255 estimated_total=45 input_tokens=35
PASSED
tests/integration/test_token_precounting.py::TestTokenPrecountingIntegration::test_token_counting_empty_messages 2025-11-09 06:33:29 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
2025-11-09 06:33:29 [info     ] token_estimation               estimated_cost=$0.000075 estimated_total=13 input_tokens=10
PASSED
tests/integration/test_token_precounting.py::TestTokenPrecountingIntegration::test_precounting_logging 2025-11-09 06:33:29 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
2025-11-09 06:33:29 [info     ] token_estimation               estimated_cost=$0.001125 estimated_total=195 input_tokens=150
FAILED
tests/integration/test_token_precounting.py::TestTokenPrecountingIntegration::test_validate_dte_uses_precounting 2025-11-09 06:33:29 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
2025-11-09 06:33:29 [info     ] dte_validation_started
2025-11-09 06:33:29 [info     ] token_estimation               estimated_cost=$0.003750 estimated_total=650 input_tokens=500
2025-11-09 06:33:29 [info     ] dte_validation_cost_estimate   estimated_cost=$0.003750
2025-11-09 06:33:29 [warning  ] circuit_breaker_failure        failure_count=1 name=anthropic_api
2025-11-09 06:33:29 [error    ] dte_validation_error           error="object MagicMock can't be used in 'await' expression"
Traceback (most recent call last):
  File "/app/clients/anthropic_client.py", line 223, in validate_dte
    message = await self.client.messages.create(
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: object MagicMock can't be used in 'await' expression
FAILED
tests/integration/test_token_precounting.py::TestTokenPrecountingIntegration::test_token_counting_model_differences 2025-11-09 06:33:29 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
2025-11-09 06:33:29 [info     ] token_estimation               estimated_cost=$0.001125 estimated_total=195 input_tokens=150
PASSED
tests/integration/test_token_precounting.py::TestTokenPrecountingIntegration::test_precounting_handles_api_errors 2025-11-09 06:33:29 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
FAILED
tests/integration/test_token_precounting.py::TestTokenPrecountingIntegration::test_token_estimation_consistency 2025-11-09 06:33:29 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
2025-11-09 06:33:29 [info     ] token_estimation               estimated_cost=$0.001125 estimated_total=195 input_tokens=150
2025-11-09 06:33:29 [info     ] token_estimation               estimated_cost=$0.001125 estimated_total=195 input_tokens=150
2025-11-09 06:33:29 [info     ] token_estimation               estimated_cost=$0.001125 estimated_total=195 input_tokens=150
PASSED
tests/test_dte_regression.py::TestDTEValidationEndpoint::test_endpoint_exists ERROR
tests/test_dte_regression.py::TestDTEValidationEndpoint::test_endpoint_requires_auth ERROR
tests/test_dte_regression.py::TestDTEValidationEndpoint::test_response_format ERROR
tests/test_dte_regression.py::TestDTEValidationEndpoint::test_handles_invalid_data ERROR
tests/test_dte_regression.py::TestDTEValidationEndpoint::test_preserves_history_parameter ERROR
tests/test_dte_regression.py::TestChatEndpoint::test_endpoint_exists ERROR
tests/test_dte_regression.py::TestChatEndpoint::test_endpoint_requires_auth ERROR
tests/test_dte_regression.py::TestChatEndpoint::test_dte_knowledge_preserved ERROR
tests/test_dte_regression.py::TestChatEndpoint::test_session_management ERROR
tests/test_dte_regression.py::TestHealthEndpoint::test_health_check ERROR
tests/test_dte_regression.py::TestSIIMonitoring::test_sii_monitor_endpoint_exists ERROR
tests/test_dte_regression.py::TestBackwardCompatibility::test_all_critical_endpoints_exist ERROR
tests/test_dte_regression.py::TestBackwardCompatibility::test_pydantic_models_unchanged PASSED
tests/test_dte_regression.py::TestPerformanceBaseline::test_validation_response_time ERROR
tests/test_dte_regression.py::TestPerformanceBaseline::test_chat_response_time ERROR
tests/unit/test_anthropic_client.py::test_anthropic_client_init 2025-11-09 06:33:30 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
PASSED
tests/unit/test_anthropic_client.py::test_anthropic_client_init_default_model 2025-11-09 06:33:30 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
PASSED
tests/unit/test_anthropic_client.py::test_estimate_tokens_success 2025-11-09 06:33:30 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
FAILED
tests/unit/test_anthropic_client.py::test_estimate_tokens_without_system_prompt 2025-11-09 06:33:30 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
FAILED
tests/unit/test_anthropic_client.py::test_estimate_tokens_exceeds_max_tokens 2025-11-09 06:33:30 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
FAILED
tests/unit/test_anthropic_client.py::test_estimate_tokens_exceeds_max_cost 2025-11-09 06:33:30 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
FAILED
tests/unit/test_anthropic_client.py::test_estimate_tokens_api_error 2025-11-09 06:33:30 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
FAILED
tests/unit/test_anthropic_client.py::test_validate_dte_success 2025-11-09 06:33:30 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
FAILED
tests/unit/test_anthropic_client.py::test_validate_dte_with_caching 2025-11-09 06:33:30 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
FAILED
tests/unit/test_anthropic_client.py::test_validate_dte_cost_exceeded 2025-11-09 06:33:30 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
FAILED
tests/unit/test_anthropic_client.py::test_validate_dte_circuit_breaker_open 2025-11-09 06:33:30 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
FAILED
tests/unit/test_anthropic_client.py::test_validate_dte_json_parse_error 2025-11-09 06:33:30 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
FAILED
tests/unit/test_anthropic_client.py::test_validate_dte_with_history 2025-11-09 06:33:30 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
FAILED
tests/unit/test_anthropic_client.py::test_build_validation_system_prompt 2025-11-09 06:33:30 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
PASSED
tests/unit/test_anthropic_client.py::test_build_validation_user_prompt_compact 2025-11-09 06:33:30 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
PASSED
tests/unit/test_anthropic_client.py::test_build_validation_user_prompt_empty_history 2025-11-09 06:33:30 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
PASSED
tests/unit/test_anthropic_client.py::test_call_with_caching_no_cache 2025-11-09 06:33:30 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
FAILED
tests/unit/test_anthropic_client.py::test_call_with_caching_with_context 2025-11-09 06:33:30 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
FAILED
tests/unit/test_anthropic_client.py::test_call_with_caching_custom_tokens_temp 2025-11-09 06:33:31 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
FAILED
tests/unit/test_anthropic_client.py::test_get_anthropic_client_singleton PASSED
tests/unit/test_anthropic_client.py::test_validate_dte_rate_limit_error 2025-11-09 06:33:31 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
FAILED
tests/unit/test_anthropic_client.py::test_build_validation_user_prompt_long_history 2025-11-09 06:33:31 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
FAILED
tests/unit/test_anthropic_client.py::test_estimate_tokens_precounting_disabled 2025-11-09 06:33:31 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
FAILED
tests/unit/test_anthropic_client.py::test_validate_dte_cache_hit_tracking 2025-11-09 06:33:31 [info     ] anthropic_client_initialized   model=claude-sonnet-4-5-20250929 optimizations_enabled=['prompt_caching', 'token_precounting', 'compact_output', 'streaming']
FAILED
tests/unit/test_chat_engine.py::test_chat_engine_init 2025-11-09 06:33:31 [info     ] chat_engine_initialized        has_context_manager=True has_knowledge_base=True max_context_messages=10 plugin_count=0 plugins_enabled=False
PASSED
tests/unit/test_chat_engine.py::test_chat_engine_init_with_plugins 2025-11-09 06:33:31 [info     ] chat_engine_initialized        has_context_manager=True has_knowledge_base=True max_context_messages=10 plugin_count=2 plugins_enabled=True
PASSED
tests/unit/test_chat_engine.py::test_chat_engine_init_custom_parameters 2025-11-09 06:33:31 [info     ] chat_engine_initialized        has_context_manager=True has_knowledge_base=True max_context_messages=20 plugin_count=0 plugins_enabled=False
PASSED
tests/unit/test_chat_engine.py::test_send_message_basic 2025-11-09 06:33:31 [info     ] chat_engine_initialized        has_context_manager=True has_knowledge_base=True max_context_messages=10 plugin_count=2 plugins_enabled=True
FAILED
tests/unit/test_chat_engine.py::test_send_message_without_user_context 2025-11-09 06:33:31 [info     ] chat_engine_initialized        has_context_manager=True has_knowledge_base=True max_context_messages=10 plugin_count=2 plugins_enabled=True
FAILED
tests/unit/test_chat_engine.py::test_send_message_with_conversation_history 2025-11-09 06:33:31 [info     ] chat_engine_initialized        has_context_manager=True has_knowledge_base=True max_context_messages=10 plugin_count=2 plugins_enabled=True
FAILED
tests/unit/test_chat_engine.py::test_send_message_plugin_selection 2025-11-09 06:33:31 [info     ] chat_engine_initialized        has_context_manager=True has_knowledge_base=True max_context_messages=10 plugin_count=2 plugins_enabled=True
FAILED
tests/unit/test_chat_engine.py::test_send_message_knowledge_base_search 2025-11-09 06:33:31 [info     ] chat_engine_initialized        has_context_manager=True has_knowledge_base=True max_context_messages=10 plugin_count=2 plugins_enabled=True
FAILED
tests/unit/test_chat_engine.py::test_send_message_anthropic_api_error 2025-11-09 06:33:31 [info     ] chat_engine_initialized        has_context_manager=True has_knowledge_base=True max_context_messages=10 plugin_count=2 plugins_enabled=True
FAILED
tests/unit/test_chat_engine.py::test_build_system_prompt_with_context 2025-11-09 06:33:31 [info     ] chat_engine_initialized        has_context_manager=True has_knowledge_base=True max_context_messages=10 plugin_count=2 plugins_enabled=True
PASSED
tests/unit/test_chat_engine.py::test_build_system_prompt_without_context 2025-11-09 06:33:31 [info     ] chat_engine_initialized        has_context_manager=True has_knowledge_base=True max_context_messages=10 plugin_count=2 plugins_enabled=True
PASSED
tests/unit/test_chat_engine.py::test_build_system_prompt_no_docs 2025-11-09 06:33:31 [info     ] chat_engine_initialized        has_context_manager=True has_knowledge_base=True max_context_messages=10 plugin_count=2 plugins_enabled=True
PASSED
tests/unit/test_chat_engine.py::test_build_system_prompt_empty_docs 2025-11-09 06:33:31 [info     ] chat_engine_initialized        has_context_manager=True has_knowledge_base=True max_context_messages=10 plugin_count=2 plugins_enabled=True
PASSED
tests/unit/test_chat_engine.py::test_build_plugin_system_prompt 2025-11-09 06:33:31 [info     ] chat_engine_initialized        has_context_manager=True has_knowledge_base=True max_context_messages=10 plugin_count=2 plugins_enabled=True
2025-11-09 06:33:31 [debug    ] plugin_system_prompt_built     kb_docs=1 plugin_module=l10n_cl_dte prompt_length=391
PASSED
tests/unit/test_chat_engine.py::test_build_plugin_system_prompt_long_doc_content 2025-11-09 06:33:31 [info     ] chat_engine_initialized        has_context_manager=True has_knowledge_base=True max_context_messages=10 plugin_count=2 plugins_enabled=True
2025-11-09 06:33:31 [debug    ] plugin_system_prompt_built     kb_docs=1 plugin_module=l10n_cl_dte prompt_length=1031
PASSED
tests/unit/test_chat_engine.py::test_call_anthropic_success 2025-11-09 06:33:31 [info     ] chat_engine_initialized        has_context_manager=True has_knowledge_base=True max_context_messages=10 plugin_count=2 plugins_enabled=True
FAILED
tests/unit/test_chat_engine.py::test_call_anthropic_api_error 2025-11-09 06:33:31 [info     ] chat_engine_initialized        has_context_manager=True has_knowledge_base=True max_context_messages=10 plugin_count=2 plugins_enabled=True
FAILED
tests/unit/test_chat_engine.py::test_call_anthropic_filters_system_messages 2025-11-09 06:33:31 [info     ] chat_engine_initialized        has_context_manager=True has_knowledge_base=True max_context_messages=10 plugin_count=2 plugins_enabled=True
FAILED
tests/unit/test_chat_engine.py::test_send_message_stream_basic 2025-11-09 06:33:31 [info     ] chat_engine_initialized        has_context_manager=True has_knowledge_base=True max_context_messages=10 plugin_count=2 plugins_enabled=True
ERROR
tests/unit/test_chat_engine.py::test_send_message_stream_disabled 2025-11-09 06:33:31 [info     ] chat_engine_initialized        has_context_manager=True has_knowledge_base=True max_context_messages=10 plugin_count=2 plugins_enabled=True
ERROR
tests/unit/test_chat_engine.py::test_send_message_confidence_hardcoded_todo 2025-11-09 06:33:31 [info     ] chat_engine_initialized        has_context_manager=True has_knowledge_base=True max_context_messages=10 plugin_count=2 plugins_enabled=True
FAILED
tests/unit/test_chat_engine.py::test_send_message_stream_confidence_hardcoded_todo 2025-11-09 06:33:32 [info     ] chat_engine_initialized        has_context_manager=True has_knowledge_base=True max_context_messages=10 plugin_count=2 plugins_enabled=True
ERROR
tests/unit/test_chat_engine.py::test_get_conversation_stats 2025-11-09 06:33:32 [info     ] chat_engine_initialized        has_context_manager=True has_knowledge_base=True max_context_messages=10 plugin_count=2 plugins_enabled=True
PASSED
tests/unit/test_chat_engine.py::test_chat_message_creation PASSED
tests/unit/test_chat_engine.py::test_chat_response_creation PASSED
tests/unit/test_chat_engine.py::test_send_message_max_context_messages 2025-11-09 06:33:32 [info     ] chat_engine_initialized        has_context_manager=True has_knowledge_base=True max_context_messages=10 plugin_count=2 plugins_enabled=True
FAILED
tests/unit/test_chat_engine.py::test_send_message_empty_response 2025-11-09 06:33:32 [info     ] chat_engine_initialized        has_context_manager=True has_knowledge_base=True max_context_messages=10 plugin_count=2 plugins_enabled=True
FAILED
tests/unit/test_cost_tracker.py::TestCostTracker::test_record_usage_calculation 2025-11-09 06:33:32 [info     ] claude_api_usage               cost_usd=0.0033 endpoint=/api/dte/validate input_tokens=100 metadata={} model=claude-sonnet-4-5-20250929 operation=dte_validation output_tokens=200 total_tokens=300
2025-11-09 06:33:32 [info     ] redis_sentinel_initializing    db=1 has_password=True master_name=mymaster sentinel_hosts=[('redis-sentinel-1', 26379), ('redis-sentinel-2', 26379), ('redis-sentinel-3', 26379)]
2025-11-09 06:33:32 [info     ] redis_sentinel_initialized     master_host=odoo19_redis_master master_name=mymaster master_port=6379 sentinel_count=3
PASSED
tests/unit/test_cost_tracker.py::TestCostTracker::test_record_usage_unknown_model 2025-11-09 06:33:32 [info     ] claude_api_usage               cost_usd=0.0018 endpoint=/test input_tokens=100 metadata={} model=unknown-model operation=test output_tokens=100 total_tokens=200
PASSED
tests/unit/test_cost_tracker.py::TestCostTracker::test_token_usage_dataclass PASSED
tests/unit/test_cost_tracker.py::TestPricing::test_pricing_structure PASSED
tests/unit/test_cost_tracker.py::TestPricing::test_cost_calculation_accuracy PASSED
tests/unit/test_llm_helpers.py::TestExtractJSON::test_plain_json 2025-11-09 06:33:32 [debug    ] json_parsed_successfully       keys=['status', 'value']
PASSED
tests/unit/test_llm_helpers.py::TestExtractJSON::test_json_in_markdown 2025-11-09 06:33:32 [debug    ] json_extracted_from_markdown
2025-11-09 06:33:32 [debug    ] json_parsed_successfully       keys=['status', 'value']
PASSED
tests/unit/test_llm_helpers.py::TestExtractJSON::test_json_with_text_before_after 2025-11-09 06:33:32 [debug    ] json_parsed_successfully       keys=['status', 'value']
PASSED
tests/unit/test_llm_helpers.py::TestExtractJSON::test_json_array 2025-11-09 06:33:32 [error    ] json_parse_failed              error='Extra data: line 1 column 10 (char 9)' json_preview='{"id": 1}, {"id": 2}'
FAILED
tests/unit/test_llm_helpers.py::TestExtractJSON::test_invalid_no_json 2025-11-09 06:33:32 [error    ] no_json_found                  text_preview='This is just plain text without JSON'
PASSED
tests/unit/test_llm_helpers.py::TestExtractJSON::test_invalid_malformed_json 2025-11-09 06:33:32 [error    ] json_parse_failed              error='Expecting value: line 1 column 27 (char 26)' json_preview='{"status": "ok", "value": }'
PASSED
tests/unit/test_llm_helpers.py::TestValidateJSONSchema::test_valid_schema PASSED
tests/unit/test_llm_helpers.py::TestValidateJSONSchema::test_missing_required_field PASSED
tests/unit/test_llm_helpers.py::TestValidateJSONSchema::test_wrong_field_type PASSED
tests/unit/test_llm_helpers.py::TestSanitizeResponse::test_normal_text PASSED
tests/unit/test_llm_helpers.py::TestSanitizeResponse::test_multiple_spaces PASSED
tests/unit/test_llm_helpers.py::TestSanitizeResponse::test_truncate_long_text 2025-11-09 06:33:32 [warning  ] llm_response_truncated         max_length=10000 original_length=15000
PASSED
tests/unit/test_llm_helpers.py::TestSanitizeResponse::test_remove_control_chars PASSED
tests/unit/test_markers_example.py::test_simple_function PASSED
tests/unit/test_markers_example.py::test_string_validation PASSED
tests/unit/test_markers_example.py::test_with_fixture PASSED
tests/unit/test_markers_example.py::test_multiple_assertions PASSED
tests/unit/test_markers_example.py::test_exception_handling PASSED
tests/unit/test_markers_example.py::test_api_health_check ERROR
tests/unit/test_markers_example.py::test_api_with_auth_headers ERROR
tests/unit/test_markers_example.py::test_rut_validation_parametrized[12.345.678-9-True] PASSED
tests/unit/test_markers_example.py::test_rut_validation_parametrized[12.345.678-0-False] FAILED
tests/unit/test_markers_example.py::test_rut_validation_parametrized[invalid-False] PASSED
tests/unit/test_markers_example.py::test_rut_validation_parametrized[-False] PASSED
tests/unit/test_markers_example.py::test_not_yet_implemented SKIPPED
tests/unit/test_markers_example.py::test_requires_feature SKIPPED
tests/unit/test_markers_example.py::test_with_multiple_markers PASSED
tests/unit/test_markers_example.py::test_coverage_demonstration PASSED
tests/unit/test_markers_example.py::test_clear_descriptive_name PASSED
tests/unit/test_markers_example.py::test_arrange_act_assert_pattern PASSED
tests/unit/test_markers_example.py::test_one_thing_per_test PASSED
tests/unit/test_plugin_system.py::TestPluginLoader::test_loader_initialization 2025-11-09 06:33:32 [info     ] plugin_loader_initialized      dir_exists=True plugins_dir=/app/plugins
PASSED
tests/unit/test_plugin_system.py::TestPluginLoader::test_discover_plugins 2025-11-09 06:33:32 [info     ] plugin_loader_initialized      dir_exists=True plugins_dir=/app/plugins
2025-11-09 06:33:32 [info     ] plugin_discovery_started       path=/app/plugins
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=DTEPlugin module=dte
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=DTEPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=DTEPlugin file=/app/plugins/dte/plugin.py module=dte
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=AccountPlugin module=account
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=AccountPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=AccountPlugin file=/app/plugins/account/plugin.py module=account
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=PayrollPlugin module=payroll
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=PayrollPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=PayrollPlugin file=/app/plugins/payroll/plugin.py module=payroll
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=StockPlugin module=stock
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=StockPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=StockPlugin file=/app/plugins/stock/plugin.py module=stock
2025-11-09 06:33:32 [info     ] plugin_discovery_completed     plugin_names=['DTEPlugin', 'AccountPlugin', 'PayrollPlugin', 'StockPlugin'] plugins_found=4
PASSED
tests/unit/test_plugin_system.py::TestPluginLoader::test_load_all_plugins 2025-11-09 06:33:32 [info     ] plugin_loader_initialized      dir_exists=True plugins_dir=/app/plugins
2025-11-09 06:33:32 [info     ] plugin_discovery_started       path=/app/plugins
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=DTEPlugin module=dte
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=DTEPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=DTEPlugin file=/app/plugins/dte/plugin.py module=dte
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=AccountPlugin module=account
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=AccountPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=AccountPlugin file=/app/plugins/account/plugin.py module=account
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=PayrollPlugin module=payroll
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=PayrollPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=PayrollPlugin file=/app/plugins/payroll/plugin.py module=payroll
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=StockPlugin module=stock
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=StockPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=StockPlugin file=/app/plugins/stock/plugin.py module=stock
2025-11-09 06:33:32 [info     ] plugin_discovery_completed     plugin_names=['DTEPlugin', 'AccountPlugin', 'PayrollPlugin', 'StockPlugin'] plugins_found=4
2025-11-09 06:33:32 [info     ] dte_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Facturación Electrónica Chilena' module=l10n_cl_dte operations=['validate', 'chat', 'monitor_sii'] version=2.0.0
2025-11-09 06:33:32 [info     ] account_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Contabilidad y Finanzas' module=account operations=['chat', 'validate_entry', 'suggest_account', 'auto_categorize', 'detect_anomalies', 'forecast_cashflow', 'reconcile_bank'] version=2.0.0
2025-11-09 06:33:32 [info     ] payroll_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll operations=['validate', 'chat', 'calculate', 'previred_indicators'] version=1.0.0
2025-11-09 06:33:32 [info     ] stock_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Gestión de Inventario (Stock)' module=stock operations=['validate', 'chat', 'inventory_check', 'traceability'] version=1.0.0
2025-11-09 06:33:32 [info     ] plugin_loading_completed       failed=0 successfully_loaded=4 total_discovered=4
PASSED
tests/unit/test_plugin_system.py::TestPluginRegistry::test_registry_auto_discover 2025-11-09 06:33:32 [info     ] plugin_loader_initialized      dir_exists=True plugins_dir=/app/plugins
2025-11-09 06:33:32 [info     ] plugin_registry_initializing   auto_discover=True
2025-11-09 06:33:32 [info     ] auto_registration_started
2025-11-09 06:33:32 [info     ] plugin_discovery_started       path=/app/plugins
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=DTEPlugin module=dte
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=DTEPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=DTEPlugin file=/app/plugins/dte/plugin.py module=dte
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=AccountPlugin module=account
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=AccountPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=AccountPlugin file=/app/plugins/account/plugin.py module=account
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=PayrollPlugin module=payroll
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=PayrollPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=PayrollPlugin file=/app/plugins/payroll/plugin.py module=payroll
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=StockPlugin module=stock
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=StockPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=StockPlugin file=/app/plugins/stock/plugin.py module=stock
2025-11-09 06:33:32 [info     ] plugin_discovery_completed     plugin_names=['DTEPlugin', 'AccountPlugin', 'PayrollPlugin', 'StockPlugin'] plugins_found=4
2025-11-09 06:33:32 [info     ] dte_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Facturación Electrónica Chilena' module=l10n_cl_dte operations=['validate', 'chat', 'monitor_sii'] version=2.0.0
2025-11-09 06:33:32 [info     ] account_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Contabilidad y Finanzas' module=account operations=['chat', 'validate_entry', 'suggest_account', 'auto_categorize', 'detect_anomalies', 'forecast_cashflow', 'reconcile_bank'] version=2.0.0
2025-11-09 06:33:32 [info     ] payroll_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll operations=['validate', 'chat', 'calculate', 'previred_indicators'] version=1.0.0
2025-11-09 06:33:32 [info     ] stock_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Gestión de Inventario (Stock)' module=stock operations=['validate', 'chat', 'inventory_check', 'traceability'] version=1.0.0
2025-11-09 06:33:32 [info     ] plugin_loading_completed       failed=0 successfully_loaded=4 total_discovered=4
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Facturación Electrónica Chilena' module=l10n_cl_dte
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Facturación Electrónica Chilena' module=l10n_cl_dte operations=['validate', 'chat', 'monitor_sii'] total_plugins=1 version=2.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Contabilidad y Finanzas' module=account
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Contabilidad y Finanzas' module=account operations=['chat', 'validate_entry', 'suggest_account', 'auto_categorize', 'detect_anomalies', 'forecast_cashflow', 'reconcile_bank'] total_plugins=2 version=2.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll operations=['validate', 'chat', 'calculate', 'previred_indicators'] total_plugins=3 version=1.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Gestión de Inventario (Stock)' module=stock
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Gestión de Inventario (Stock)' module=stock operations=['validate', 'chat', 'inventory_check', 'traceability'] total_plugins=4 version=1.0.0
2025-11-09 06:33:32 [info     ] auto_registration_completed    discovered=4 registered=4
2025-11-09 06:33:32 [info     ] plugin_registry_initialized    modules=['l10n_cl_dte', 'account', 'l10n_cl_hr_payroll', 'stock'] plugin_count=4
PASSED
tests/unit/test_plugin_system.py::TestPluginRegistry::test_get_plugin 2025-11-09 06:33:32 [info     ] plugin_loader_initialized      dir_exists=True plugins_dir=/app/plugins
2025-11-09 06:33:32 [info     ] plugin_registry_initializing   auto_discover=True
2025-11-09 06:33:32 [info     ] auto_registration_started
2025-11-09 06:33:32 [info     ] plugin_discovery_started       path=/app/plugins
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=DTEPlugin module=dte
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=DTEPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=DTEPlugin file=/app/plugins/dte/plugin.py module=dte
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=AccountPlugin module=account
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=AccountPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=AccountPlugin file=/app/plugins/account/plugin.py module=account
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=PayrollPlugin module=payroll
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=PayrollPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=PayrollPlugin file=/app/plugins/payroll/plugin.py module=payroll
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=StockPlugin module=stock
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=StockPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=StockPlugin file=/app/plugins/stock/plugin.py module=stock
2025-11-09 06:33:32 [info     ] plugin_discovery_completed     plugin_names=['DTEPlugin', 'AccountPlugin', 'PayrollPlugin', 'StockPlugin'] plugins_found=4
2025-11-09 06:33:32 [info     ] dte_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Facturación Electrónica Chilena' module=l10n_cl_dte operations=['validate', 'chat', 'monitor_sii'] version=2.0.0
2025-11-09 06:33:32 [info     ] account_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Contabilidad y Finanzas' module=account operations=['chat', 'validate_entry', 'suggest_account', 'auto_categorize', 'detect_anomalies', 'forecast_cashflow', 'reconcile_bank'] version=2.0.0
2025-11-09 06:33:32 [info     ] payroll_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll operations=['validate', 'chat', 'calculate', 'previred_indicators'] version=1.0.0
2025-11-09 06:33:32 [info     ] stock_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Gestión de Inventario (Stock)' module=stock operations=['validate', 'chat', 'inventory_check', 'traceability'] version=1.0.0
2025-11-09 06:33:32 [info     ] plugin_loading_completed       failed=0 successfully_loaded=4 total_discovered=4
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Facturación Electrónica Chilena' module=l10n_cl_dte
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Facturación Electrónica Chilena' module=l10n_cl_dte operations=['validate', 'chat', 'monitor_sii'] total_plugins=1 version=2.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Contabilidad y Finanzas' module=account
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Contabilidad y Finanzas' module=account operations=['chat', 'validate_entry', 'suggest_account', 'auto_categorize', 'detect_anomalies', 'forecast_cashflow', 'reconcile_bank'] total_plugins=2 version=2.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll operations=['validate', 'chat', 'calculate', 'previred_indicators'] total_plugins=3 version=1.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Gestión de Inventario (Stock)' module=stock
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Gestión de Inventario (Stock)' module=stock operations=['validate', 'chat', 'inventory_check', 'traceability'] total_plugins=4 version=1.0.0
2025-11-09 06:33:32 [info     ] auto_registration_completed    discovered=4 registered=4
2025-11-09 06:33:32 [info     ] plugin_registry_initialized    modules=['l10n_cl_dte', 'account', 'l10n_cl_hr_payroll', 'stock'] plugin_count=4
PASSED
tests/unit/test_plugin_system.py::TestPluginRegistry::test_plugin_selection_explicit_context 2025-11-09 06:33:32 [info     ] plugin_loader_initialized      dir_exists=True plugins_dir=/app/plugins
2025-11-09 06:33:32 [info     ] plugin_registry_initializing   auto_discover=True
2025-11-09 06:33:32 [info     ] auto_registration_started
2025-11-09 06:33:32 [info     ] plugin_discovery_started       path=/app/plugins
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=DTEPlugin module=dte
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=DTEPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=DTEPlugin file=/app/plugins/dte/plugin.py module=dte
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=AccountPlugin module=account
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=AccountPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=AccountPlugin file=/app/plugins/account/plugin.py module=account
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=PayrollPlugin module=payroll
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=PayrollPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=PayrollPlugin file=/app/plugins/payroll/plugin.py module=payroll
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=StockPlugin module=stock
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=StockPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=StockPlugin file=/app/plugins/stock/plugin.py module=stock
2025-11-09 06:33:32 [info     ] plugin_discovery_completed     plugin_names=['DTEPlugin', 'AccountPlugin', 'PayrollPlugin', 'StockPlugin'] plugins_found=4
2025-11-09 06:33:32 [info     ] dte_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Facturación Electrónica Chilena' module=l10n_cl_dte operations=['validate', 'chat', 'monitor_sii'] version=2.0.0
2025-11-09 06:33:32 [info     ] account_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Contabilidad y Finanzas' module=account operations=['chat', 'validate_entry', 'suggest_account', 'auto_categorize', 'detect_anomalies', 'forecast_cashflow', 'reconcile_bank'] version=2.0.0
2025-11-09 06:33:32 [info     ] payroll_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll operations=['validate', 'chat', 'calculate', 'previred_indicators'] version=1.0.0
2025-11-09 06:33:32 [info     ] stock_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Gestión de Inventario (Stock)' module=stock operations=['validate', 'chat', 'inventory_check', 'traceability'] version=1.0.0
2025-11-09 06:33:32 [info     ] plugin_loading_completed       failed=0 successfully_loaded=4 total_discovered=4
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Facturación Electrónica Chilena' module=l10n_cl_dte
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Facturación Electrónica Chilena' module=l10n_cl_dte operations=['validate', 'chat', 'monitor_sii'] total_plugins=1 version=2.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Contabilidad y Finanzas' module=account
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Contabilidad y Finanzas' module=account operations=['chat', 'validate_entry', 'suggest_account', 'auto_categorize', 'detect_anomalies', 'forecast_cashflow', 'reconcile_bank'] total_plugins=2 version=2.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll operations=['validate', 'chat', 'calculate', 'previred_indicators'] total_plugins=3 version=1.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Gestión de Inventario (Stock)' module=stock
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Gestión de Inventario (Stock)' module=stock operations=['validate', 'chat', 'inventory_check', 'traceability'] total_plugins=4 version=1.0.0
2025-11-09 06:33:32 [info     ] auto_registration_completed    discovered=4 registered=4
2025-11-09 06:33:32 [info     ] plugin_registry_initialized    modules=['l10n_cl_dte', 'account', 'l10n_cl_hr_payroll', 'stock'] plugin_count=4
2025-11-09 06:33:32 [debug    ] plugin_selection_started       has_context=True query_preview='¿Cómo calcular AFP?'
2025-11-09 06:33:32 [info     ] plugin_selected_from_context   display_name='Facturación Electrónica Chilena' module=l10n_cl_dte
PASSED
tests/unit/test_plugin_system.py::TestPluginRegistry::test_plugin_selection_keyword_matching_dte 2025-11-09 06:33:32 [info     ] plugin_loader_initialized      dir_exists=True plugins_dir=/app/plugins
2025-11-09 06:33:32 [info     ] plugin_registry_initializing   auto_discover=True
2025-11-09 06:33:32 [info     ] auto_registration_started
2025-11-09 06:33:32 [info     ] plugin_discovery_started       path=/app/plugins
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=DTEPlugin module=dte
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=DTEPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=DTEPlugin file=/app/plugins/dte/plugin.py module=dte
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=AccountPlugin module=account
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=AccountPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=AccountPlugin file=/app/plugins/account/plugin.py module=account
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=PayrollPlugin module=payroll
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=PayrollPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=PayrollPlugin file=/app/plugins/payroll/plugin.py module=payroll
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=StockPlugin module=stock
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=StockPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=StockPlugin file=/app/plugins/stock/plugin.py module=stock
2025-11-09 06:33:32 [info     ] plugin_discovery_completed     plugin_names=['DTEPlugin', 'AccountPlugin', 'PayrollPlugin', 'StockPlugin'] plugins_found=4
2025-11-09 06:33:32 [info     ] dte_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Facturación Electrónica Chilena' module=l10n_cl_dte operations=['validate', 'chat', 'monitor_sii'] version=2.0.0
2025-11-09 06:33:32 [info     ] account_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Contabilidad y Finanzas' module=account operations=['chat', 'validate_entry', 'suggest_account', 'auto_categorize', 'detect_anomalies', 'forecast_cashflow', 'reconcile_bank'] version=2.0.0
2025-11-09 06:33:32 [info     ] payroll_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll operations=['validate', 'chat', 'calculate', 'previred_indicators'] version=1.0.0
2025-11-09 06:33:32 [info     ] stock_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Gestión de Inventario (Stock)' module=stock operations=['validate', 'chat', 'inventory_check', 'traceability'] version=1.0.0
2025-11-09 06:33:32 [info     ] plugin_loading_completed       failed=0 successfully_loaded=4 total_discovered=4
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Facturación Electrónica Chilena' module=l10n_cl_dte
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Facturación Electrónica Chilena' module=l10n_cl_dte operations=['validate', 'chat', 'monitor_sii'] total_plugins=1 version=2.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Contabilidad y Finanzas' module=account
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Contabilidad y Finanzas' module=account operations=['chat', 'validate_entry', 'suggest_account', 'auto_categorize', 'detect_anomalies', 'forecast_cashflow', 'reconcile_bank'] total_plugins=2 version=2.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll operations=['validate', 'chat', 'calculate', 'previred_indicators'] total_plugins=3 version=1.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Gestión de Inventario (Stock)' module=stock
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Gestión de Inventario (Stock)' module=stock operations=['validate', 'chat', 'inventory_check', 'traceability'] total_plugins=4 version=1.0.0
2025-11-09 06:33:32 [info     ] auto_registration_completed    discovered=4 registered=4
2025-11-09 06:33:32 [info     ] plugin_registry_initialized    modules=['l10n_cl_dte', 'account', 'l10n_cl_hr_payroll', 'stock'] plugin_count=4
2025-11-09 06:33:32 [debug    ] plugin_selection_started       has_context=False query_preview='¿Cómo genero una factura electrónica?'
2025-11-09 06:33:32 [info     ] plugin_auto_selected           display_name='Facturación Electrónica Chilena' module=l10n_cl_dte query_preview='¿Cómo genero una factura electrónica?' score=1
2025-11-09 06:33:32 [debug    ] plugin_selection_started       has_context=False query_preview='Necesito enviar un DTE al SII'
2025-11-09 06:33:32 [info     ] plugin_auto_selected           display_name='Facturación Electrónica Chilena' module=l10n_cl_dte query_preview='Necesito enviar un DTE al SII' score=2
2025-11-09 06:33:32 [debug    ] plugin_selection_started       has_context=False query_preview='Error en folio CAF'
2025-11-09 06:33:32 [info     ] plugin_auto_selected           display_name='Facturación Electrónica Chilena' module=l10n_cl_dte query_preview='Error en folio CAF' score=2
2025-11-09 06:33:32 [debug    ] plugin_selection_started       has_context=False query_preview='¿Cómo configuro el certificado digital?'
2025-11-09 06:33:32 [info     ] plugin_auto_selected           display_name='Facturación Electrónica Chilena' module=l10n_cl_dte query_preview='¿Cómo configuro el certificado digital?' score=1
PASSED
tests/unit/test_plugin_system.py::TestPluginRegistry::test_plugin_selection_keyword_matching_payroll 2025-11-09 06:33:32 [info     ] plugin_loader_initialized      dir_exists=True plugins_dir=/app/plugins
2025-11-09 06:33:32 [info     ] plugin_registry_initializing   auto_discover=True
2025-11-09 06:33:32 [info     ] auto_registration_started
2025-11-09 06:33:32 [info     ] plugin_discovery_started       path=/app/plugins
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=DTEPlugin module=dte
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=DTEPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=DTEPlugin file=/app/plugins/dte/plugin.py module=dte
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=AccountPlugin module=account
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=AccountPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=AccountPlugin file=/app/plugins/account/plugin.py module=account
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=PayrollPlugin module=payroll
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=PayrollPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=PayrollPlugin file=/app/plugins/payroll/plugin.py module=payroll
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=StockPlugin module=stock
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=StockPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=StockPlugin file=/app/plugins/stock/plugin.py module=stock
2025-11-09 06:33:32 [info     ] plugin_discovery_completed     plugin_names=['DTEPlugin', 'AccountPlugin', 'PayrollPlugin', 'StockPlugin'] plugins_found=4
2025-11-09 06:33:32 [info     ] dte_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Facturación Electrónica Chilena' module=l10n_cl_dte operations=['validate', 'chat', 'monitor_sii'] version=2.0.0
2025-11-09 06:33:32 [info     ] account_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Contabilidad y Finanzas' module=account operations=['chat', 'validate_entry', 'suggest_account', 'auto_categorize', 'detect_anomalies', 'forecast_cashflow', 'reconcile_bank'] version=2.0.0
2025-11-09 06:33:32 [info     ] payroll_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll operations=['validate', 'chat', 'calculate', 'previred_indicators'] version=1.0.0
2025-11-09 06:33:32 [info     ] stock_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Gestión de Inventario (Stock)' module=stock operations=['validate', 'chat', 'inventory_check', 'traceability'] version=1.0.0
2025-11-09 06:33:32 [info     ] plugin_loading_completed       failed=0 successfully_loaded=4 total_discovered=4
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Facturación Electrónica Chilena' module=l10n_cl_dte
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Facturación Electrónica Chilena' module=l10n_cl_dte operations=['validate', 'chat', 'monitor_sii'] total_plugins=1 version=2.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Contabilidad y Finanzas' module=account
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Contabilidad y Finanzas' module=account operations=['chat', 'validate_entry', 'suggest_account', 'auto_categorize', 'detect_anomalies', 'forecast_cashflow', 'reconcile_bank'] total_plugins=2 version=2.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll operations=['validate', 'chat', 'calculate', 'previred_indicators'] total_plugins=3 version=1.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Gestión de Inventario (Stock)' module=stock
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Gestión de Inventario (Stock)' module=stock operations=['validate', 'chat', 'inventory_check', 'traceability'] total_plugins=4 version=1.0.0
2025-11-09 06:33:32 [info     ] auto_registration_completed    discovered=4 registered=4
2025-11-09 06:33:32 [info     ] plugin_registry_initialized    modules=['l10n_cl_dte', 'account', 'l10n_cl_hr_payroll', 'stock'] plugin_count=4
2025-11-09 06:33:32 [debug    ] plugin_selection_started       has_context=False query_preview='¿Cómo calcular la AFP?'
2025-11-09 06:33:32 [info     ] plugin_auto_selected           display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll query_preview='¿Cómo calcular la AFP?' score=1
2025-11-09 06:33:32 [debug    ] plugin_selection_started       has_context=False query_preview='Liquidación de sueldo mensual'
2025-11-09 06:33:32 [info     ] plugin_auto_selected           display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll query_preview='Liquidación de sueldo mensual' score=2
2025-11-09 06:33:32 [debug    ] plugin_selection_started       has_context=False query_preview='Descuento Isapre'
2025-11-09 06:33:32 [info     ] plugin_auto_selected           display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll query_preview='Descuento Isapre' score=2
2025-11-09 06:33:32 [debug    ] plugin_selection_started       has_context=False query_preview='Gratificación legal proporcional'
2025-11-09 06:33:32 [info     ] plugin_auto_selected           display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll query_preview='Gratificación legal proporcional' score=1
PASSED
tests/unit/test_plugin_system.py::TestPluginRegistry::test_plugin_selection_keyword_matching_stock 2025-11-09 06:33:32 [info     ] plugin_loader_initialized      dir_exists=True plugins_dir=/app/plugins
2025-11-09 06:33:32 [info     ] plugin_registry_initializing   auto_discover=True
2025-11-09 06:33:32 [info     ] auto_registration_started
2025-11-09 06:33:32 [info     ] plugin_discovery_started       path=/app/plugins
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=DTEPlugin module=dte
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=DTEPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=DTEPlugin file=/app/plugins/dte/plugin.py module=dte
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=AccountPlugin module=account
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=AccountPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=AccountPlugin file=/app/plugins/account/plugin.py module=account
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=PayrollPlugin module=payroll
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=PayrollPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=PayrollPlugin file=/app/plugins/payroll/plugin.py module=payroll
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=StockPlugin module=stock
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=StockPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=StockPlugin file=/app/plugins/stock/plugin.py module=stock
2025-11-09 06:33:32 [info     ] plugin_discovery_completed     plugin_names=['DTEPlugin', 'AccountPlugin', 'PayrollPlugin', 'StockPlugin'] plugins_found=4
2025-11-09 06:33:32 [info     ] dte_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Facturación Electrónica Chilena' module=l10n_cl_dte operations=['validate', 'chat', 'monitor_sii'] version=2.0.0
2025-11-09 06:33:32 [info     ] account_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Contabilidad y Finanzas' module=account operations=['chat', 'validate_entry', 'suggest_account', 'auto_categorize', 'detect_anomalies', 'forecast_cashflow', 'reconcile_bank'] version=2.0.0
2025-11-09 06:33:32 [info     ] payroll_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll operations=['validate', 'chat', 'calculate', 'previred_indicators'] version=1.0.0
2025-11-09 06:33:32 [info     ] stock_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Gestión de Inventario (Stock)' module=stock operations=['validate', 'chat', 'inventory_check', 'traceability'] version=1.0.0
2025-11-09 06:33:32 [info     ] plugin_loading_completed       failed=0 successfully_loaded=4 total_discovered=4
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Facturación Electrónica Chilena' module=l10n_cl_dte
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Facturación Electrónica Chilena' module=l10n_cl_dte operations=['validate', 'chat', 'monitor_sii'] total_plugins=1 version=2.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Contabilidad y Finanzas' module=account
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Contabilidad y Finanzas' module=account operations=['chat', 'validate_entry', 'suggest_account', 'auto_categorize', 'detect_anomalies', 'forecast_cashflow', 'reconcile_bank'] total_plugins=2 version=2.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll operations=['validate', 'chat', 'calculate', 'previred_indicators'] total_plugins=3 version=1.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Gestión de Inventario (Stock)' module=stock
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Gestión de Inventario (Stock)' module=stock operations=['validate', 'chat', 'inventory_check', 'traceability'] total_plugins=4 version=1.0.0
2025-11-09 06:33:32 [info     ] auto_registration_completed    discovered=4 registered=4
2025-11-09 06:33:32 [info     ] plugin_registry_initialized    modules=['l10n_cl_dte', 'account', 'l10n_cl_hr_payroll', 'stock'] plugin_count=4
2025-11-09 06:33:32 [debug    ] plugin_selection_started       has_context=False query_preview='¿Cómo hacer ajuste de inventario?'
2025-11-09 06:33:32 [info     ] plugin_auto_selected           display_name='Gestión de Inventario (Stock)' module=stock query_preview='¿Cómo hacer ajuste de inventario?' score=2
2025-11-09 06:33:32 [debug    ] plugin_selection_started       has_context=False query_preview='Transferencia entre bodegas'
2025-11-09 06:33:32 [info     ] plugin_auto_selected           display_name='Gestión de Inventario (Stock)' module=stock query_preview='Transferencia entre bodegas' score=3
2025-11-09 06:33:32 [debug    ] plugin_selection_started       has_context=False query_preview='Stock disponible de producto'
2025-11-09 06:33:32 [info     ] plugin_auto_selected           display_name='Gestión de Inventario (Stock)' module=stock query_preview='Stock disponible de producto' score=3
2025-11-09 06:33:32 [debug    ] plugin_selection_started       has_context=False query_preview='Picking de almacén'
2025-11-09 06:33:32 [info     ] plugin_auto_selected           display_name='Gestión de Inventario (Stock)' module=stock query_preview='Picking de almacén' score=2
PASSED
tests/unit/test_plugin_system.py::TestPluginRegistry::test_plugin_selection_fallback 2025-11-09 06:33:32 [info     ] plugin_loader_initialized      dir_exists=True plugins_dir=/app/plugins
2025-11-09 06:33:32 [info     ] plugin_registry_initializing   auto_discover=True
2025-11-09 06:33:32 [info     ] auto_registration_started
2025-11-09 06:33:32 [info     ] plugin_discovery_started       path=/app/plugins
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=DTEPlugin module=dte
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=DTEPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=DTEPlugin file=/app/plugins/dte/plugin.py module=dte
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=AccountPlugin module=account
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=AccountPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=AccountPlugin file=/app/plugins/account/plugin.py module=account
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=PayrollPlugin module=payroll
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=PayrollPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=PayrollPlugin file=/app/plugins/payroll/plugin.py module=payroll
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=StockPlugin module=stock
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=StockPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=StockPlugin file=/app/plugins/stock/plugin.py module=stock
2025-11-09 06:33:32 [info     ] plugin_discovery_completed     plugin_names=['DTEPlugin', 'AccountPlugin', 'PayrollPlugin', 'StockPlugin'] plugins_found=4
2025-11-09 06:33:32 [info     ] dte_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Facturación Electrónica Chilena' module=l10n_cl_dte operations=['validate', 'chat', 'monitor_sii'] version=2.0.0
2025-11-09 06:33:32 [info     ] account_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Contabilidad y Finanzas' module=account operations=['chat', 'validate_entry', 'suggest_account', 'auto_categorize', 'detect_anomalies', 'forecast_cashflow', 'reconcile_bank'] version=2.0.0
2025-11-09 06:33:32 [info     ] payroll_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll operations=['validate', 'chat', 'calculate', 'previred_indicators'] version=1.0.0
2025-11-09 06:33:32 [info     ] stock_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Gestión de Inventario (Stock)' module=stock operations=['validate', 'chat', 'inventory_check', 'traceability'] version=1.0.0
2025-11-09 06:33:32 [info     ] plugin_loading_completed       failed=0 successfully_loaded=4 total_discovered=4
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Facturación Electrónica Chilena' module=l10n_cl_dte
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Facturación Electrónica Chilena' module=l10n_cl_dte operations=['validate', 'chat', 'monitor_sii'] total_plugins=1 version=2.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Contabilidad y Finanzas' module=account
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Contabilidad y Finanzas' module=account operations=['chat', 'validate_entry', 'suggest_account', 'auto_categorize', 'detect_anomalies', 'forecast_cashflow', 'reconcile_bank'] total_plugins=2 version=2.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll operations=['validate', 'chat', 'calculate', 'previred_indicators'] total_plugins=3 version=1.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Gestión de Inventario (Stock)' module=stock
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Gestión de Inventario (Stock)' module=stock operations=['validate', 'chat', 'inventory_check', 'traceability'] total_plugins=4 version=1.0.0
2025-11-09 06:33:32 [info     ] auto_registration_completed    discovered=4 registered=4
2025-11-09 06:33:32 [info     ] plugin_registry_initialized    modules=['l10n_cl_dte', 'account', 'l10n_cl_hr_payroll', 'stock'] plugin_count=4
2025-11-09 06:33:32 [debug    ] plugin_selection_started       has_context=False query_preview='¿Qué es Odoo?'
2025-11-09 06:33:32 [info     ] plugin_fallback_to_default     module=l10n_cl_dte reason=no_keyword_match
PASSED
tests/unit/test_plugin_system.py::TestPluginRegistry::test_usage_stats_tracking 2025-11-09 06:33:32 [info     ] plugin_loader_initialized      dir_exists=True plugins_dir=/app/plugins
2025-11-09 06:33:32 [info     ] plugin_registry_initializing   auto_discover=True
2025-11-09 06:33:32 [info     ] auto_registration_started
2025-11-09 06:33:32 [info     ] plugin_discovery_started       path=/app/plugins
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=DTEPlugin module=dte
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=DTEPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=DTEPlugin file=/app/plugins/dte/plugin.py module=dte
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=AccountPlugin module=account
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=AccountPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=AccountPlugin file=/app/plugins/account/plugin.py module=account
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=PayrollPlugin module=payroll
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=PayrollPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=PayrollPlugin file=/app/plugins/payroll/plugin.py module=payroll
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=StockPlugin module=stock
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=StockPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=StockPlugin file=/app/plugins/stock/plugin.py module=stock
2025-11-09 06:33:32 [info     ] plugin_discovery_completed     plugin_names=['DTEPlugin', 'AccountPlugin', 'PayrollPlugin', 'StockPlugin'] plugins_found=4
2025-11-09 06:33:32 [info     ] dte_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Facturación Electrónica Chilena' module=l10n_cl_dte operations=['validate', 'chat', 'monitor_sii'] version=2.0.0
2025-11-09 06:33:32 [info     ] account_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Contabilidad y Finanzas' module=account operations=['chat', 'validate_entry', 'suggest_account', 'auto_categorize', 'detect_anomalies', 'forecast_cashflow', 'reconcile_bank'] version=2.0.0
2025-11-09 06:33:32 [info     ] payroll_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll operations=['validate', 'chat', 'calculate', 'previred_indicators'] version=1.0.0
2025-11-09 06:33:32 [info     ] stock_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Gestión de Inventario (Stock)' module=stock operations=['validate', 'chat', 'inventory_check', 'traceability'] version=1.0.0
2025-11-09 06:33:32 [info     ] plugin_loading_completed       failed=0 successfully_loaded=4 total_discovered=4
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Facturación Electrónica Chilena' module=l10n_cl_dte
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Facturación Electrónica Chilena' module=l10n_cl_dte operations=['validate', 'chat', 'monitor_sii'] total_plugins=1 version=2.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Contabilidad y Finanzas' module=account
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Contabilidad y Finanzas' module=account operations=['chat', 'validate_entry', 'suggest_account', 'auto_categorize', 'detect_anomalies', 'forecast_cashflow', 'reconcile_bank'] total_plugins=2 version=2.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll operations=['validate', 'chat', 'calculate', 'previred_indicators'] total_plugins=3 version=1.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Gestión de Inventario (Stock)' module=stock
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Gestión de Inventario (Stock)' module=stock operations=['validate', 'chat', 'inventory_check', 'traceability'] total_plugins=4 version=1.0.0
2025-11-09 06:33:32 [info     ] auto_registration_completed    discovered=4 registered=4
2025-11-09 06:33:32 [info     ] plugin_registry_initialized    modules=['l10n_cl_dte', 'account', 'l10n_cl_hr_payroll', 'stock'] plugin_count=4
PASSED
tests/unit/test_plugin_system.py::TestPluginRegistry::test_get_stats 2025-11-09 06:33:32 [info     ] plugin_loader_initialized      dir_exists=True plugins_dir=/app/plugins
2025-11-09 06:33:32 [info     ] plugin_registry_initializing   auto_discover=True
2025-11-09 06:33:32 [info     ] auto_registration_started
2025-11-09 06:33:32 [info     ] plugin_discovery_started       path=/app/plugins
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=DTEPlugin module=dte
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=DTEPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=DTEPlugin file=/app/plugins/dte/plugin.py module=dte
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=AccountPlugin module=account
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=AccountPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=AccountPlugin file=/app/plugins/account/plugin.py module=account
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=PayrollPlugin module=payroll
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=PayrollPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=PayrollPlugin file=/app/plugins/payroll/plugin.py module=payroll
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=StockPlugin module=stock
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=StockPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=StockPlugin file=/app/plugins/stock/plugin.py module=stock
2025-11-09 06:33:32 [info     ] plugin_discovery_completed     plugin_names=['DTEPlugin', 'AccountPlugin', 'PayrollPlugin', 'StockPlugin'] plugins_found=4
2025-11-09 06:33:32 [info     ] dte_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Facturación Electrónica Chilena' module=l10n_cl_dte operations=['validate', 'chat', 'monitor_sii'] version=2.0.0
2025-11-09 06:33:32 [info     ] account_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Contabilidad y Finanzas' module=account operations=['chat', 'validate_entry', 'suggest_account', 'auto_categorize', 'detect_anomalies', 'forecast_cashflow', 'reconcile_bank'] version=2.0.0
2025-11-09 06:33:32 [info     ] payroll_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll operations=['validate', 'chat', 'calculate', 'previred_indicators'] version=1.0.0
2025-11-09 06:33:32 [info     ] stock_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Gestión de Inventario (Stock)' module=stock operations=['validate', 'chat', 'inventory_check', 'traceability'] version=1.0.0
2025-11-09 06:33:32 [info     ] plugin_loading_completed       failed=0 successfully_loaded=4 total_discovered=4
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Facturación Electrónica Chilena' module=l10n_cl_dte
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Facturación Electrónica Chilena' module=l10n_cl_dte operations=['validate', 'chat', 'monitor_sii'] total_plugins=1 version=2.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Contabilidad y Finanzas' module=account
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Contabilidad y Finanzas' module=account operations=['chat', 'validate_entry', 'suggest_account', 'auto_categorize', 'detect_anomalies', 'forecast_cashflow', 'reconcile_bank'] total_plugins=2 version=2.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll operations=['validate', 'chat', 'calculate', 'previred_indicators'] total_plugins=3 version=1.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Gestión de Inventario (Stock)' module=stock
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Gestión de Inventario (Stock)' module=stock operations=['validate', 'chat', 'inventory_check', 'traceability'] total_plugins=4 version=1.0.0
2025-11-09 06:33:32 [info     ] auto_registration_completed    discovered=4 registered=4
2025-11-09 06:33:32 [info     ] plugin_registry_initialized    modules=['l10n_cl_dte', 'account', 'l10n_cl_hr_payroll', 'stock'] plugin_count=4
PASSED
tests/unit/test_plugin_system.py::TestPluginRegistry::test_singleton_registry 2025-11-09 06:33:32 [info     ] plugin_loader_initialized      dir_exists=True plugins_dir=/app/plugins
2025-11-09 06:33:32 [info     ] plugin_registry_initializing   auto_discover=True
2025-11-09 06:33:32 [info     ] auto_registration_started
2025-11-09 06:33:32 [info     ] plugin_discovery_started       path=/app/plugins
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=DTEPlugin module=dte
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=DTEPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=DTEPlugin file=/app/plugins/dte/plugin.py module=dte
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=AccountPlugin module=account
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=AccountPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=AccountPlugin file=/app/plugins/account/plugin.py module=account
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=PayrollPlugin module=payroll
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=PayrollPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=PayrollPlugin file=/app/plugins/payroll/plugin.py module=payroll
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=StockPlugin module=stock
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=StockPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=StockPlugin file=/app/plugins/stock/plugin.py module=stock
2025-11-09 06:33:32 [info     ] plugin_discovery_completed     plugin_names=['DTEPlugin', 'AccountPlugin', 'PayrollPlugin', 'StockPlugin'] plugins_found=4
2025-11-09 06:33:32 [info     ] dte_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Facturación Electrónica Chilena' module=l10n_cl_dte operations=['validate', 'chat', 'monitor_sii'] version=2.0.0
2025-11-09 06:33:32 [info     ] account_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Contabilidad y Finanzas' module=account operations=['chat', 'validate_entry', 'suggest_account', 'auto_categorize', 'detect_anomalies', 'forecast_cashflow', 'reconcile_bank'] version=2.0.0
2025-11-09 06:33:32 [info     ] payroll_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll operations=['validate', 'chat', 'calculate', 'previred_indicators'] version=1.0.0
2025-11-09 06:33:32 [info     ] stock_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Gestión de Inventario (Stock)' module=stock operations=['validate', 'chat', 'inventory_check', 'traceability'] version=1.0.0
2025-11-09 06:33:32 [info     ] plugin_loading_completed       failed=0 successfully_loaded=4 total_discovered=4
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Facturación Electrónica Chilena' module=l10n_cl_dte
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Facturación Electrónica Chilena' module=l10n_cl_dte operations=['validate', 'chat', 'monitor_sii'] total_plugins=1 version=2.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Contabilidad y Finanzas' module=account
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Contabilidad y Finanzas' module=account operations=['chat', 'validate_entry', 'suggest_account', 'auto_categorize', 'detect_anomalies', 'forecast_cashflow', 'reconcile_bank'] total_plugins=2 version=2.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll operations=['validate', 'chat', 'calculate', 'previred_indicators'] total_plugins=3 version=1.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Gestión de Inventario (Stock)' module=stock
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Gestión de Inventario (Stock)' module=stock operations=['validate', 'chat', 'inventory_check', 'traceability'] total_plugins=4 version=1.0.0
2025-11-09 06:33:32 [info     ] auto_registration_completed    discovered=4 registered=4
2025-11-09 06:33:32 [info     ] plugin_registry_initialized    modules=['l10n_cl_dte', 'account', 'l10n_cl_hr_payroll', 'stock'] plugin_count=4
PASSED
tests/unit/test_plugin_system.py::TestPluginInterface::test_dte_plugin_interface 2025-11-09 06:33:32 [info     ] plugin_loader_initialized      dir_exists=True plugins_dir=/app/plugins
2025-11-09 06:33:32 [info     ] plugin_registry_initializing   auto_discover=True
2025-11-09 06:33:32 [info     ] auto_registration_started
2025-11-09 06:33:32 [info     ] plugin_discovery_started       path=/app/plugins
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=DTEPlugin module=dte
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=DTEPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=DTEPlugin file=/app/plugins/dte/plugin.py module=dte
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=AccountPlugin module=account
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=AccountPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=AccountPlugin file=/app/plugins/account/plugin.py module=account
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=PayrollPlugin module=payroll
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=PayrollPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=PayrollPlugin file=/app/plugins/payroll/plugin.py module=payroll
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=StockPlugin module=stock
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=StockPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=StockPlugin file=/app/plugins/stock/plugin.py module=stock
2025-11-09 06:33:32 [info     ] plugin_discovery_completed     plugin_names=['DTEPlugin', 'AccountPlugin', 'PayrollPlugin', 'StockPlugin'] plugins_found=4
2025-11-09 06:33:32 [info     ] dte_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Facturación Electrónica Chilena' module=l10n_cl_dte operations=['validate', 'chat', 'monitor_sii'] version=2.0.0
2025-11-09 06:33:32 [info     ] account_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Contabilidad y Finanzas' module=account operations=['chat', 'validate_entry', 'suggest_account', 'auto_categorize', 'detect_anomalies', 'forecast_cashflow', 'reconcile_bank'] version=2.0.0
2025-11-09 06:33:32 [info     ] payroll_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll operations=['validate', 'chat', 'calculate', 'previred_indicators'] version=1.0.0
2025-11-09 06:33:32 [info     ] stock_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Gestión de Inventario (Stock)' module=stock operations=['validate', 'chat', 'inventory_check', 'traceability'] version=1.0.0
2025-11-09 06:33:32 [info     ] plugin_loading_completed       failed=0 successfully_loaded=4 total_discovered=4
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Facturación Electrónica Chilena' module=l10n_cl_dte
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Facturación Electrónica Chilena' module=l10n_cl_dte operations=['validate', 'chat', 'monitor_sii'] total_plugins=1 version=2.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Contabilidad y Finanzas' module=account
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Contabilidad y Finanzas' module=account operations=['chat', 'validate_entry', 'suggest_account', 'auto_categorize', 'detect_anomalies', 'forecast_cashflow', 'reconcile_bank'] total_plugins=2 version=2.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll operations=['validate', 'chat', 'calculate', 'previred_indicators'] total_plugins=3 version=1.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Gestión de Inventario (Stock)' module=stock
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Gestión de Inventario (Stock)' module=stock operations=['validate', 'chat', 'inventory_check', 'traceability'] total_plugins=4 version=1.0.0
2025-11-09 06:33:32 [info     ] auto_registration_completed    discovered=4 registered=4
2025-11-09 06:33:32 [info     ] plugin_registry_initialized    modules=['l10n_cl_dte', 'account', 'l10n_cl_hr_payroll', 'stock'] plugin_count=4
PASSED
tests/unit/test_plugin_system.py::TestPluginInterface::test_payroll_plugin_interface 2025-11-09 06:33:32 [info     ] plugin_loader_initialized      dir_exists=True plugins_dir=/app/plugins
2025-11-09 06:33:32 [info     ] plugin_registry_initializing   auto_discover=True
2025-11-09 06:33:32 [info     ] auto_registration_started
2025-11-09 06:33:32 [info     ] plugin_discovery_started       path=/app/plugins
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=DTEPlugin module=dte
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=DTEPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=DTEPlugin file=/app/plugins/dte/plugin.py module=dte
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=AccountPlugin module=account
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=AccountPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=AccountPlugin file=/app/plugins/account/plugin.py module=account
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=PayrollPlugin module=payroll
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=PayrollPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=PayrollPlugin file=/app/plugins/payroll/plugin.py module=payroll
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=StockPlugin module=stock
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=StockPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=StockPlugin file=/app/plugins/stock/plugin.py module=stock
2025-11-09 06:33:32 [info     ] plugin_discovery_completed     plugin_names=['DTEPlugin', 'AccountPlugin', 'PayrollPlugin', 'StockPlugin'] plugins_found=4
2025-11-09 06:33:32 [info     ] dte_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Facturación Electrónica Chilena' module=l10n_cl_dte operations=['validate', 'chat', 'monitor_sii'] version=2.0.0
2025-11-09 06:33:32 [info     ] account_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Contabilidad y Finanzas' module=account operations=['chat', 'validate_entry', 'suggest_account', 'auto_categorize', 'detect_anomalies', 'forecast_cashflow', 'reconcile_bank'] version=2.0.0
2025-11-09 06:33:32 [info     ] payroll_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll operations=['validate', 'chat', 'calculate', 'previred_indicators'] version=1.0.0
2025-11-09 06:33:32 [info     ] stock_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Gestión de Inventario (Stock)' module=stock operations=['validate', 'chat', 'inventory_check', 'traceability'] version=1.0.0
2025-11-09 06:33:32 [info     ] plugin_loading_completed       failed=0 successfully_loaded=4 total_discovered=4
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Facturación Electrónica Chilena' module=l10n_cl_dte
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Facturación Electrónica Chilena' module=l10n_cl_dte operations=['validate', 'chat', 'monitor_sii'] total_plugins=1 version=2.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Contabilidad y Finanzas' module=account
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Contabilidad y Finanzas' module=account operations=['chat', 'validate_entry', 'suggest_account', 'auto_categorize', 'detect_anomalies', 'forecast_cashflow', 'reconcile_bank'] total_plugins=2 version=2.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll operations=['validate', 'chat', 'calculate', 'previred_indicators'] total_plugins=3 version=1.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Gestión de Inventario (Stock)' module=stock
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Gestión de Inventario (Stock)' module=stock operations=['validate', 'chat', 'inventory_check', 'traceability'] total_plugins=4 version=1.0.0
2025-11-09 06:33:32 [info     ] auto_registration_completed    discovered=4 registered=4
2025-11-09 06:33:32 [info     ] plugin_registry_initialized    modules=['l10n_cl_dte', 'account', 'l10n_cl_hr_payroll', 'stock'] plugin_count=4
PASSED
tests/unit/test_plugin_system.py::TestPluginInterface::test_stock_plugin_interface 2025-11-09 06:33:32 [info     ] plugin_loader_initialized      dir_exists=True plugins_dir=/app/plugins
2025-11-09 06:33:32 [info     ] plugin_registry_initializing   auto_discover=True
2025-11-09 06:33:32 [info     ] auto_registration_started
2025-11-09 06:33:32 [info     ] plugin_discovery_started       path=/app/plugins
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=DTEPlugin module=dte
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=DTEPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=DTEPlugin file=/app/plugins/dte/plugin.py module=dte
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=AccountPlugin module=account
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=AccountPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=AccountPlugin file=/app/plugins/account/plugin.py module=account
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=PayrollPlugin module=payroll
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=PayrollPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=PayrollPlugin file=/app/plugins/payroll/plugin.py module=payroll
2025-11-09 06:33:32 [debug    ] plugin_class_found             class_name=StockPlugin module=stock
2025-11-09 06:33:32 [debug    ] plugin_interface_valid         class_name=StockPlugin
2025-11-09 06:33:32 [info     ] plugin_discovered              class_name=StockPlugin file=/app/plugins/stock/plugin.py module=stock
2025-11-09 06:33:32 [info     ] plugin_discovery_completed     plugin_names=['DTEPlugin', 'AccountPlugin', 'PayrollPlugin', 'StockPlugin'] plugins_found=4
2025-11-09 06:33:32 [info     ] dte_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Facturación Electrónica Chilena' module=l10n_cl_dte operations=['validate', 'chat', 'monitor_sii'] version=2.0.0
2025-11-09 06:33:32 [info     ] account_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Contabilidad y Finanzas' module=account operations=['chat', 'validate_entry', 'suggest_account', 'auto_categorize', 'detect_anomalies', 'forecast_cashflow', 'reconcile_bank'] version=2.0.0
2025-11-09 06:33:32 [info     ] payroll_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll operations=['validate', 'chat', 'calculate', 'previred_indicators'] version=1.0.0
2025-11-09 06:33:32 [info     ] stock_plugin_initialized
2025-11-09 06:33:32 [info     ] plugin_instantiated            display_name='Gestión de Inventario (Stock)' module=stock operations=['validate', 'chat', 'inventory_check', 'traceability'] version=1.0.0
2025-11-09 06:33:32 [info     ] plugin_loading_completed       failed=0 successfully_loaded=4 total_discovered=4
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Facturación Electrónica Chilena' module=l10n_cl_dte
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Facturación Electrónica Chilena' module=l10n_cl_dte operations=['validate', 'chat', 'monitor_sii'] total_plugins=1 version=2.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Contabilidad y Finanzas' module=account
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Contabilidad y Finanzas' module=account operations=['chat', 'validate_entry', 'suggest_account', 'auto_categorize', 'detect_anomalies', 'forecast_cashflow', 'reconcile_bank'] total_plugins=2 version=2.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Nómina Chilena (Payroll)' module=l10n_cl_hr_payroll operations=['validate', 'chat', 'calculate', 'previred_indicators'] total_plugins=3 version=1.0.0
2025-11-09 06:33:32 [info     ] plugin_registration_started    display_name='Gestión de Inventario (Stock)' module=stock
2025-11-09 06:33:32 [info     ] plugin_registered              display_name='Gestión de Inventario (Stock)' module=stock operations=['validate', 'chat', 'inventory_check', 'traceability'] total_plugins=4 version=1.0.0
2025-11-09 06:33:32 [info     ] auto_registration_completed    discovered=4 registered=4
2025-11-09 06:33:32 [info     ] plugin_registry_initialized    modules=['l10n_cl_dte', 'account', 'l10n_cl_hr_payroll', 'stock'] plugin_count=4
PASSED
tests/unit/test_validators.py::TestRUTValidation::test_valid_rut_with_dots FAILED
tests/unit/test_validators.py::TestRUTValidation::test_valid_rut_without_dots FAILED
tests/unit/test_validators.py::TestRUTValidation::test_valid_rut_with_k FAILED
tests/unit/test_validators.py::TestRUTValidation::test_invalid_rut_checksum PASSED
tests/unit/test_validators.py::TestRUTValidation::test_invalid_rut_format PASSED
tests/unit/test_validators.py::TestRUTValidation::test_sanitize_rut FAILED
tests/unit/test_validators.py::TestDTEValidation::test_valid_dte_types PASSED
tests/unit/test_validators.py::TestDTEValidation::test_invalid_dte_types PASSED
tests/unit/test_validators.py::TestDTEValidation::test_valid_dte_amounts PASSED
tests/unit/test_validators.py::TestDTEValidation::test_invalid_dte_amounts PASSED
tests/unit/test_validators.py::TestDTEValidation::test_validate_dte_data_valid FAILED
tests/unit/test_validators.py::TestDTEValidation::test_validate_dte_data_missing_field PASSED
tests/unit/test_validators.py::TestDTEValidation::test_validate_dte_data_invalid_rut FAILED
tests/unit/test_validators.py::TestStringValidation::test_sanitize_normal_string PASSED
tests/unit/test_validators.py::TestStringValidation::test_sanitize_string_max_length 2025-11-09 06:33:32 [warning  ] string_truncated               max_length=100 original_length=2000
PASSED
tests/unit/test_validators.py::TestStringValidation::test_sanitize_control_characters PASSED
tests/unit/test_validators.py::TestNumericValidation::test_validate_positive_number PASSED
tests/unit/test_validators.py::TestNumericValidation::test_validate_percentage PASSED
tests/unit/test_validators.py::TestNumericValidation::test_validate_company_id PASSED
ERROR: Coverage failure: total of 31.53 is less than fail-under=80.00


==================================== ERRORS ====================================
____ ERROR at setup of TestDTEValidationEndpoint.test_validate_dte_success _____
tests/integration/test_critical_endpoints.py:26: in client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
__ ERROR at setup of TestDTEValidationEndpoint.test_validate_dte_invalid_tipo __
tests/integration/test_critical_endpoints.py:26: in client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
_ ERROR at setup of TestDTEValidationEndpoint.test_validate_dte_negative_company_id _
tests/integration/test_critical_endpoints.py:26: in client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
__ ERROR at setup of TestDTEValidationEndpoint.test_validate_dte_unauthorized __
tests/integration/test_critical_endpoints.py:26: in client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
____ ERROR at setup of TestPOMatchingEndpoint.test_match_po_endpoint_exists ____
tests/integration/test_critical_endpoints.py:26: in client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
______ ERROR at setup of TestPOMatchingEndpoint.test_match_po_invalid_rut ______
tests/integration/test_critical_endpoints.py:26: in client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
_____ ERROR at setup of TestPOMatchingEndpoint.test_match_po_invalid_monto _____
tests/integration/test_critical_endpoints.py:26: in client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
_____ ERROR at setup of TestAnalyticsEndpoint.test_suggest_project_success _____
tests/integration/test_critical_endpoints.py:26: in client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
___________ ERROR at setup of TestChatEndpoints.test_create_session ____________
tests/integration/test_critical_endpoints.py:26: in client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
______ ERROR at setup of TestChatEndpoints.test_send_message_invalid_long ______
tests/integration/test_critical_endpoints.py:26: in client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
____________ ERROR at setup of TestHealthEndpoint.test_health_check ____________
tests/integration/test_critical_endpoints.py:26: in client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
____ ERROR at setup of TestRateLimiting.test_rate_limit_validation_endpoint ____
tests/integration/test_critical_endpoints.py:26: in client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
_ ERROR at setup of TestPromptCachingIntegration.test_caching_endpoint_exists __
tests/integration/test_prompt_caching.py:36: in test_client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
_ ERROR at setup of TestPromptCachingIntegration.test_caching_creates_cache_on_first_call _
tests/integration/test_prompt_caching.py:36: in test_client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
_ ERROR at setup of TestPromptCachingIntegration.test_caching_reads_cache_on_second_call _
tests/integration/test_prompt_caching.py:36: in test_client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
__ ERROR at setup of TestPromptCachingIntegration.test_caching_reduces_costs ___
tests/integration/test_prompt_caching.py:36: in test_client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
_ ERROR at setup of TestPromptCachingIntegration.test_caching_with_multiple_validations _
tests/integration/test_prompt_caching.py:36: in test_client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
_ ERROR at setup of TestPromptCachingIntegration.test_cache_different_contexts _
tests/integration/test_prompt_caching.py:36: in test_client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
_ ERROR at setup of TestPromptCachingIntegration.test_caching_preserves_validation_quality _
tests/integration/test_prompt_caching.py:36: in test_client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
___ ERROR at setup of TestPromptCachingIntegration.test_caching_with_history ___
tests/integration/test_prompt_caching.py:36: in test_client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
__ ERROR at setup of TestPromptCachingIntegration.test_caching_error_handling __
tests/integration/test_prompt_caching.py:36: in test_client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
_ ERROR at setup of TestStreamingSSEIntegration.test_streaming_endpoint_exists _
tests/integration/test_streaming_sse.py:41: in test_client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
_ ERROR at setup of TestStreamingSSEIntegration.test_streaming_returns_sse_format _
tests/integration/test_streaming_sse.py:41: in test_client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
_ ERROR at setup of TestStreamingSSEIntegration.test_streaming_progressive_tokens _
tests/integration/test_streaming_sse.py:41: in test_client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
_ ERROR at setup of TestStreamingSSEIntegration.test_streaming_handles_errors_gracefully _
tests/integration/test_streaming_sse.py:41: in test_client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
_ ERROR at setup of TestStreamingSSEIntegration.test_streaming_sends_done_event _
tests/integration/test_streaming_sse.py:41: in test_client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
_ ERROR at setup of TestStreamingSSEIntegration.test_streaming_maintains_session_context _
tests/integration/test_streaming_sse.py:41: in test_client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
_ ERROR at setup of TestStreamingSSEIntegration.test_streaming_with_knowledge_base_injection _
tests/integration/test_streaming_sse.py:41: in test_client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
_ ERROR at setup of TestStreamingSSEIntegration.test_streaming_with_caching_metrics _
tests/integration/test_streaming_sse.py:41: in test_client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
_ ERROR at setup of TestStreamingSSEIntegration.test_streaming_with_empty_response _
tests/integration/test_streaming_sse.py:41: in test_client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
_ ERROR at setup of TestStreamingSSEIntegration.test_streaming_large_response __
tests/integration/test_streaming_sse.py:41: in test_client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
_ ERROR at setup of TestStreamingSSEIntegration.test_streaming_respects_rate_limiting _
tests/integration/test_streaming_sse.py:41: in test_client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
_______ ERROR at setup of TestDTEValidationEndpoint.test_endpoint_exists _______
/usr/local/lib/python3.11/site-packages/pytest_asyncio/plugin.py:733: in pytest_fixture_setup
    return (yield)
            ^^^^^
tests/conftest.py:32: in client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
___ ERROR at setup of TestDTEValidationEndpoint.test_endpoint_requires_auth ____
/usr/local/lib/python3.11/site-packages/pytest_asyncio/plugin.py:733: in pytest_fixture_setup
    return (yield)
            ^^^^^
tests/conftest.py:32: in client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
_______ ERROR at setup of TestDTEValidationEndpoint.test_response_format _______
/usr/local/lib/python3.11/site-packages/pytest_asyncio/plugin.py:733: in pytest_fixture_setup
    return (yield)
            ^^^^^
tests/conftest.py:32: in client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
____ ERROR at setup of TestDTEValidationEndpoint.test_handles_invalid_data _____
/usr/local/lib/python3.11/site-packages/pytest_asyncio/plugin.py:733: in pytest_fixture_setup
    return (yield)
            ^^^^^
tests/conftest.py:32: in client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
_ ERROR at setup of TestDTEValidationEndpoint.test_preserves_history_parameter _
/usr/local/lib/python3.11/site-packages/pytest_asyncio/plugin.py:733: in pytest_fixture_setup
    return (yield)
            ^^^^^
tests/conftest.py:32: in client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
___________ ERROR at setup of TestChatEndpoint.test_endpoint_exists ____________
/usr/local/lib/python3.11/site-packages/pytest_asyncio/plugin.py:733: in pytest_fixture_setup
    return (yield)
            ^^^^^
tests/conftest.py:32: in client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
________ ERROR at setup of TestChatEndpoint.test_endpoint_requires_auth ________
/usr/local/lib/python3.11/site-packages/pytest_asyncio/plugin.py:733: in pytest_fixture_setup
    return (yield)
            ^^^^^
tests/conftest.py:32: in client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
_______ ERROR at setup of TestChatEndpoint.test_dte_knowledge_preserved ________
/usr/local/lib/python3.11/site-packages/pytest_asyncio/plugin.py:733: in pytest_fixture_setup
    return (yield)
            ^^^^^
tests/conftest.py:32: in client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
__________ ERROR at setup of TestChatEndpoint.test_session_management __________
/usr/local/lib/python3.11/site-packages/pytest_asyncio/plugin.py:733: in pytest_fixture_setup
    return (yield)
            ^^^^^
tests/conftest.py:32: in client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
____________ ERROR at setup of TestHealthEndpoint.test_health_check ____________
/usr/local/lib/python3.11/site-packages/pytest_asyncio/plugin.py:733: in pytest_fixture_setup
    return (yield)
            ^^^^^
tests/conftest.py:32: in client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
_____ ERROR at setup of TestSIIMonitoring.test_sii_monitor_endpoint_exists _____
/usr/local/lib/python3.11/site-packages/pytest_asyncio/plugin.py:733: in pytest_fixture_setup
    return (yield)
            ^^^^^
tests/conftest.py:32: in client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
_ ERROR at setup of TestBackwardCompatibility.test_all_critical_endpoints_exist _
/usr/local/lib/python3.11/site-packages/pytest_asyncio/plugin.py:733: in pytest_fixture_setup
    return (yield)
            ^^^^^
tests/conftest.py:32: in client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
___ ERROR at setup of TestPerformanceBaseline.test_validation_response_time ____
/usr/local/lib/python3.11/site-packages/pytest_asyncio/plugin.py:733: in pytest_fixture_setup
    return (yield)
            ^^^^^
tests/conftest.py:32: in client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
______ ERROR at setup of TestPerformanceBaseline.test_chat_response_time _______
/usr/local/lib/python3.11/site-packages/pytest_asyncio/plugin.py:733: in pytest_fixture_setup
    return (yield)
            ^^^^^
tests/conftest.py:32: in client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
_______________ ERROR at setup of test_send_message_stream_basic _______________
file /app/tests/unit/test_chat_engine.py, line 509
  @pytest.mark.unit
  @pytest.mark.asyncio
  async def test_send_message_stream_basic(chat_engine, sample_user_context, mock_settings):
      """Test streaming message sending"""
      mock_settings.enable_streaming = True

      with patch('chat.engine.settings', mock_settings):
          # Mock streaming
          stream_context = AsyncMock()
          stream_context.__aenter__ = AsyncMock(return_value=stream_context)
          stream_context.__aexit__ = AsyncMock(return_value=None)
          stream_context.text_stream = AsyncMock()

          async def async_text_stream():
              yield "This "
              yield "is "
              yield "a "
              yield "streaming "
              yield "response"

          stream_context.text_stream.__aiter__ = lambda self: async_text_stream()

          # Mock final message
          final_msg = MagicMock()
          final_msg.usage = MagicMock()
          final_msg.usage.input_tokens = 100
          final_msg.usage.output_tokens = 50
          final_msg.usage.cache_read_input_tokens = 0
          final_msg.usage.cache_creation_input_tokens = 0

          stream_context.get_final_message = AsyncMock(return_value=final_msg)

          chat_engine.anthropic_client.client.messages.stream = MagicMock(return_value=stream_context)

          # Collect streamed chunks
          chunks = []
          async for chunk in chat_engine.send_message_stream(
              session_id="stream-1",
              user_message="Test",
              user_context=sample_user_context
          ):
              chunks.append(chunk)

          # Should have text chunks + done chunk
          assert len(chunks) > 0
          assert any(c.get("type") == "done" for c in chunks)
E       fixture 'mock_settings' not found
>       available fixtures: _class_scoped_runner, _function_scoped_runner, _module_scoped_runner, _package_scoped_runner, _session_scoped_runner, anyio_backend, anyio_backend_name, anyio_backend_options, auth_headers, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, capteesys, chat_engine, client, cov, doctest_namespace, event_loop_policy, mock_anthropic_client, mock_anthropic_response, mock_context_manager, mock_knowledge_base, mock_plugin, mock_plugin_registry, monkeypatch, no_cover, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, sample_chat_message, sample_dte_data, sample_user_context, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, unused_tcp_port, unused_tcp_port_factory, unused_udp_port, unused_udp_port_factory, valid_api_key
>       use 'pytest --fixtures [testpath]' for help on them.

/app/tests/unit/test_chat_engine.py:509
_____________ ERROR at setup of test_send_message_stream_disabled ______________
file /app/tests/unit/test_chat_engine.py, line 557
  @pytest.mark.unit
  @pytest.mark.asyncio
  async def test_send_message_stream_disabled(chat_engine, sample_user_context, mock_anthropic_response, mock_settings):
      """Test fallback when streaming is disabled"""
      mock_settings.enable_streaming = False

      with patch('chat.engine.settings', mock_settings):
          chat_engine.anthropic_client.client.messages.create = AsyncMock(return_value=mock_anthropic_response)

          chunks = []
          async for chunk in chat_engine.send_message_stream(
              session_id="no-stream",
              user_message="Test",
              user_context=sample_user_context
          ):
              chunks.append(chunk)

          # Should fall back to non-streaming
          assert len(chunks) >= 2
          assert chunks[0]["type"] == "text"
          assert chunks[-1]["type"] == "done"
E       fixture 'mock_settings' not found
>       available fixtures: _class_scoped_runner, _function_scoped_runner, _module_scoped_runner, _package_scoped_runner, _session_scoped_runner, anyio_backend, anyio_backend_name, anyio_backend_options, auth_headers, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, capteesys, chat_engine, client, cov, doctest_namespace, event_loop_policy, mock_anthropic_client, mock_anthropic_response, mock_context_manager, mock_knowledge_base, mock_plugin, mock_plugin_registry, monkeypatch, no_cover, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, sample_chat_message, sample_dte_data, sample_user_context, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, unused_tcp_port, unused_tcp_port_factory, unused_udp_port, unused_udp_port_factory, valid_api_key
>       use 'pytest --fixtures [testpath]' for help on them.

/app/tests/unit/test_chat_engine.py:557
_____ ERROR at setup of test_send_message_stream_confidence_hardcoded_todo _____
file /app/tests/unit/test_chat_engine.py, line 618
  @pytest.mark.unit
  @pytest.mark.asyncio
  async def test_send_message_stream_confidence_hardcoded_todo(chat_engine, sample_user_context, mock_settings):
      """
      TEST FOR TODO: confidence=95.0 is hardcoded in send_message_stream (line 629)

      Current Implementation in streaming:
          "confidence": 95.0,

      Same TODO as send_message - confidence should be calculated properly.
      """
      mock_settings.enable_streaming = True

      with patch('chat.engine.settings', mock_settings):
          stream_context = AsyncMock()
          stream_context.__aenter__ = AsyncMock(return_value=stream_context)
          stream_context.__aexit__ = AsyncMock(return_value=None)

          async def async_text_stream():
              yield "Test response"

          stream_context.text_stream = AsyncMock()
          stream_context.text_stream.__aiter__ = lambda self: async_text_stream()

          final_msg = MagicMock()
          final_msg.usage = MagicMock()
          final_msg.usage.input_tokens = 100
          final_msg.usage.output_tokens = 50
          final_msg.usage.cache_read_input_tokens = 0
          final_msg.usage.cache_creation_input_tokens = 0

          stream_context.get_final_message = AsyncMock(return_value=final_msg)

          chat_engine.anthropic_client.client.messages.stream = MagicMock(return_value=stream_context)

          chunks = []
          async for chunk in chat_engine.send_message_stream(
              session_id="stream-confidence",
              user_message="Test",
              user_context=sample_user_context
          ):
              chunks.append(chunk)

          # Find done chunk
          done_chunk = next((c for c in chunks if c.get("type") == "done"), None)
          assert done_chunk is not None
          # CURRENT: Hardcoded to 95.0
          assert done_chunk["metadata"]["confidence"] == 95.0
E       fixture 'mock_settings' not found
>       available fixtures: _class_scoped_runner, _function_scoped_runner, _module_scoped_runner, _package_scoped_runner, _session_scoped_runner, anyio_backend, anyio_backend_name, anyio_backend_options, auth_headers, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, capteesys, chat_engine, client, cov, doctest_namespace, event_loop_policy, mock_anthropic_client, mock_anthropic_response, mock_context_manager, mock_knowledge_base, mock_plugin, mock_plugin_registry, monkeypatch, no_cover, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, sample_chat_message, sample_dte_data, sample_user_context, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, unused_tcp_port, unused_tcp_port_factory, unused_udp_port, unused_udp_port_factory, valid_api_key
>       use 'pytest --fixtures [testpath]' for help on them.

/app/tests/unit/test_chat_engine.py:618
___________________ ERROR at setup of test_api_health_check ____________________
/usr/local/lib/python3.11/site-packages/pytest_asyncio/plugin.py:733: in pytest_fixture_setup
    return (yield)
            ^^^^^
tests/conftest.py:32: in client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
_________________ ERROR at setup of test_api_with_auth_headers _________________
/usr/local/lib/python3.11/site-packages/pytest_asyncio/plugin.py:733: in pytest_fixture_setup
    return (yield)
            ^^^^^
tests/conftest.py:32: in client
    return TestClient(app)
           ^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:399: in __init__
    super().__init__(
E   TypeError: Client.__init__() got an unexpected keyword argument 'app'
=================================== FAILURES ===================================
__ TestPromptCachingIntegration.test_cache_control_header_in_system_messages ___
tests/integration/test_prompt_caching.py:291: in test_cache_control_header_in_system_messages
    result = asyncio.run(client.validate_dte(
/usr/local/lib/python3.11/asyncio/runners.py:186: in run
    raise RuntimeError(
E   RuntimeError: asyncio.run() cannot be called from a running event loop
_ TestTokenPrecountingIntegration.test_precounting_validates_against_model_limits _
tests/integration/test_token_precounting.py:217: in test_precounting_validates_against_model_limits
    result = await client.estimate_tokens(
clients/anthropic_client.py:127: in estimate_tokens
    raise ValueError(
E   ValueError: Request too large: 130000 tokens (max 100000)
_ TestTokenPrecountingIntegration.test_precounting_prevents_expensive_requests _
tests/integration/test_token_precounting.py:368: in test_precounting_prevents_expensive_requests
    result = await client.estimate_tokens(
clients/anthropic_client.py:127: in estimate_tokens
    raise ValueError(
E   ValueError: Request too large: 130000 tokens (max 100000)

During handling of the above exception, another exception occurred:
tests/integration/test_token_precounting.py:378: in test_precounting_prevents_expensive_requests
    assert "expensive" in str(e).lower() or \
E   AssertionError: assert ('expensive' in 'request too large: 130000 tokens (max 100000)' or 'cost' in 'request too large: 130000 tokens (max 100000)')
E    +  where 'request too large: 130000 tokens (max 100000)' = <built-in method lower of str object at 0xffff9123b0f0>()
E    +    where <built-in method lower of str object at 0xffff9123b0f0> = 'Request too large: 130000 tokens (max 100000)'.lower
E    +      where 'Request too large: 130000 tokens (max 100000)' = str(ValueError('Request too large: 130000 tokens (max 100000)'))
E    +  and   'request too large: 130000 tokens (max 100000)' = <built-in method lower of str object at 0xffff9123b0f0>()
E    +    where <built-in method lower of str object at 0xffff9123b0f0> = 'Request too large: 130000 tokens (max 100000)'.lower
E    +      where 'Request too large: 130000 tokens (max 100000)' = str(ValueError('Request too large: 130000 tokens (max 100000)'))
___________ TestTokenPrecountingIntegration.test_precounting_logging ___________
tests/integration/test_token_precounting.py:474: in test_precounting_logging
    assert "token_estimation" in caplog.text or \
E   AssertionError: assert ('token_estimation' in '' or 'estimate' in '')
E    +  where '' = <_pytest.logging.LogCaptureFixture object at 0xffff911f3210>.text
E    +  and   '' = <built-in method lower of str object at 0xffff964f1188>()
E    +    where <built-in method lower of str object at 0xffff964f1188> = ''.lower
E    +      where '' = <_pytest.logging.LogCaptureFixture object at 0xffff911f3210>.text
______ TestTokenPrecountingIntegration.test_validate_dte_uses_precounting ______
tests/integration/test_token_precounting.py:516: in test_validate_dte_uses_precounting
    result = await client.validate_dte(dte_data, [])
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/tenacity/asyncio/__init__.py:189: in async_wrapped
    return await copy(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/tenacity/asyncio/__init__.py:111: in __call__
    do = await self.iter(retry_state=retry_state)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/tenacity/asyncio/__init__.py:153: in iter
    result = await action(retry_state)
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/tenacity/_utils.py:99: in inner
    return call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/tenacity/__init__.py:400: in <lambda>
    self._add_action_func(lambda rs: rs.outcome.result())
                                     ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/tenacity/asyncio/__init__.py:114: in __call__
    result = await fn(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^
clients/anthropic_client.py:223: in validate_dte
    message = await self.client.messages.create(
E   TypeError: object MagicMock can't be used in 'await' expression
_____ TestTokenPrecountingIntegration.test_precounting_handles_api_errors ______
tests/integration/test_token_precounting.py:567: in test_precounting_handles_api_errors
    mock_ct.side_effect = anthropic.APIError("API error")
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   TypeError: APIError.__init__() missing 1 required positional argument: 'request'
_________________________ test_estimate_tokens_success _________________________
tests/unit/test_anthropic_client.py:148: in test_estimate_tokens_success
    with patch('clients.anthropic_client.settings', mock_settings):
/usr/local/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/unittest/mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
__________________ test_estimate_tokens_without_system_prompt __________________
tests/unit/test_anthropic_client.py:177: in test_estimate_tokens_without_system_prompt
    with patch('clients.anthropic_client.settings', mock_settings):
/usr/local/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/unittest/mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
___________________ test_estimate_tokens_exceeds_max_tokens ____________________
tests/unit/test_anthropic_client.py:200: in test_estimate_tokens_exceeds_max_tokens
    with patch('clients.anthropic_client.settings', mock_settings):
/usr/local/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/unittest/mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
____________________ test_estimate_tokens_exceeds_max_cost _____________________
tests/unit/test_anthropic_client.py:222: in test_estimate_tokens_exceeds_max_cost
    with patch('clients.anthropic_client.settings', mock_settings):
/usr/local/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/unittest/mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
________________________ test_estimate_tokens_api_error ________________________
tests/unit/test_anthropic_client.py:242: in test_estimate_tokens_api_error
    side_effect=anthropic.APIError("API Error")
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   TypeError: APIError.__init__() missing 1 required positional argument: 'request'
__________________________ test_validate_dte_success ___________________________
tests/unit/test_anthropic_client.py:260: in test_validate_dte_success
    with patch('clients.anthropic_client.settings', mock_settings):
/usr/local/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/unittest/mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
________________________ test_validate_dte_with_caching ________________________
tests/unit/test_anthropic_client.py:299: in test_validate_dte_with_caching
    with patch('clients.anthropic_client.settings', mock_settings):
/usr/local/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/unittest/mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
_______________________ test_validate_dte_cost_exceeded ________________________
tests/unit/test_anthropic_client.py:335: in test_validate_dte_cost_exceeded
    with patch('clients.anthropic_client.settings', mock_settings):
/usr/local/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/unittest/mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
____________________ test_validate_dte_circuit_breaker_open ____________________
tests/unit/test_anthropic_client.py:354: in test_validate_dte_circuit_breaker_open
    with patch('clients.anthropic_client.settings', mock_settings):
/usr/local/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/unittest/mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
______________________ test_validate_dte_json_parse_error ______________________
tests/unit/test_anthropic_client.py:377: in test_validate_dte_json_parse_error
    with patch('clients.anthropic_client.settings', mock_settings):
/usr/local/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/unittest/mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
________________________ test_validate_dte_with_history ________________________
tests/unit/test_anthropic_client.py:417: in test_validate_dte_with_history
    with patch('clients.anthropic_client.settings', mock_settings):
/usr/local/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/unittest/mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
_______________________ test_call_with_caching_no_cache ________________________
tests/unit/test_anthropic_client.py:493: in test_call_with_caching_no_cache
    with patch('clients.anthropic_client.settings', mock_settings):
/usr/local/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/unittest/mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
_____________________ test_call_with_caching_with_context ______________________
tests/unit/test_anthropic_client.py:514: in test_call_with_caching_with_context
    with patch('clients.anthropic_client.settings', mock_settings):
/usr/local/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/unittest/mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
__________________ test_call_with_caching_custom_tokens_temp ___________________
tests/unit/test_anthropic_client.py:540: in test_call_with_caching_custom_tokens_temp
    with patch('clients.anthropic_client.settings', mock_settings):
/usr/local/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/unittest/mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
______________________ test_validate_dte_rate_limit_error ______________________
tests/unit/test_anthropic_client.py:591: in test_validate_dte_rate_limit_error
    with patch('clients.anthropic_client.settings', mock_settings):
/usr/local/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/unittest/mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
________________ test_build_validation_user_prompt_long_history ________________
tests/unit/test_anthropic_client.py:624: in test_build_validation_user_prompt_long_history
    assert prompt.count("E") <= 5  # Only last 3 error codes
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   assert 8 <= 5
E    +  where 8 = <built-in method count of str object at 0xaaaaf398eac0>('E')
E    +    where <built-in method count of str object at 0xaaaaf398eac0> = 'Analiza este DTE:\n\nDTE:\n{"tipo_dte": "33", "folio": "12345", "fecha_emision": "2025-10-22", "rut_emisor": "12345678-9", "rut_receptor": "98765432-1", "monto_total": 119000, "monto_neto": 100000, "monto_iva": 19000, "items": [{"nombre": "Producto Test", "cantidad": 1, "precio_unitario": 100000}]}\n\nHISTORIAL (\xfaltimos 3 rechazos):\n[{"err": "E000", "msg": "Error message 0"}, {"err": "E001", "msg": "Error message 1"}, {"err": "E002", "msg": "Error message 2"}]\n\nResponde SOLO JSON compacto.'.count
__________________ test_estimate_tokens_precounting_disabled ___________________
tests/unit/test_anthropic_client.py:633: in test_estimate_tokens_precounting_disabled
    with patch('clients.anthropic_client.settings', mock_settings):
/usr/local/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/unittest/mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
_____________________ test_validate_dte_cache_hit_tracking _____________________
tests/unit/test_anthropic_client.py:659: in test_validate_dte_cache_hit_tracking
    with patch('clients.anthropic_client.settings', mock_settings):
/usr/local/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/unittest/mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
___________________________ test_send_message_basic ____________________________
tests/unit/test_chat_engine.py:194: in test_send_message_basic
    with patch('chat.engine.settings') as mock_settings:
/usr/local/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/unittest/mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <module 'chat.engine' from '/app/chat/engine.py'> does not have the attribute 'settings'
____________________ test_send_message_without_user_context ____________________
tests/unit/test_chat_engine.py:217: in test_send_message_without_user_context
    with patch('chat.engine.settings') as mock_settings:
/usr/local/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/unittest/mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <module 'chat.engine' from '/app/chat/engine.py'> does not have the attribute 'settings'
_________________ test_send_message_with_conversation_history __________________
tests/unit/test_chat_engine.py:249: in test_send_message_with_conversation_history
    with patch('chat.engine.settings') as mock_settings:
/usr/local/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/unittest/mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <module 'chat.engine' from '/app/chat/engine.py'> does not have the attribute 'settings'
______________________ test_send_message_plugin_selection ______________________
tests/unit/test_chat_engine.py:273: in test_send_message_plugin_selection
    with patch('chat.engine.settings') as mock_settings:
/usr/local/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/unittest/mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <module 'chat.engine' from '/app/chat/engine.py'> does not have the attribute 'settings'
___________________ test_send_message_knowledge_base_search ____________________
tests/unit/test_chat_engine.py:302: in test_send_message_knowledge_base_search
    with patch('chat.engine.settings') as mock_settings:
/usr/local/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/unittest/mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <module 'chat.engine' from '/app/chat/engine.py'> does not have the attribute 'settings'
____________________ test_send_message_anthropic_api_error _____________________
tests/unit/test_chat_engine.py:326: in test_send_message_anthropic_api_error
    with patch('chat.engine.settings') as mock_settings:
/usr/local/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/unittest/mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <module 'chat.engine' from '/app/chat/engine.py'> does not have the attribute 'settings'
_________________________ test_call_anthropic_success __________________________
tests/unit/test_chat_engine.py:443: in test_call_anthropic_success
    with patch('chat.engine.settings') as mock_settings:
/usr/local/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/unittest/mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <module 'chat.engine' from '/app/chat/engine.py'> does not have the attribute 'settings'
________________________ test_call_anthropic_api_error _________________________
tests/unit/test_chat_engine.py:465: in test_call_anthropic_api_error
    with patch('chat.engine.settings') as mock_settings:
/usr/local/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/unittest/mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <module 'chat.engine' from '/app/chat/engine.py'> does not have the attribute 'settings'
_________________ test_call_anthropic_filters_system_messages __________________
tests/unit/test_chat_engine.py:481: in test_call_anthropic_filters_system_messages
    with patch('chat.engine.settings') as mock_settings:
/usr/local/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/unittest/mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <module 'chat.engine' from '/app/chat/engine.py'> does not have the attribute 'settings'
_________________ test_send_message_confidence_hardcoded_todo __________________
tests/unit/test_chat_engine.py:601: in test_send_message_confidence_hardcoded_todo
    with patch('chat.engine.settings') as mock_settings:
/usr/local/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/unittest/mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <module 'chat.engine' from '/app/chat/engine.py'> does not have the attribute 'settings'
____________________ test_send_message_max_context_messages ____________________
tests/unit/test_chat_engine.py:749: in test_send_message_max_context_messages
    with patch('chat.engine.settings') as mock_settings:
/usr/local/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/unittest/mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <module 'chat.engine' from '/app/chat/engine.py'> does not have the attribute 'settings'
_______________________ test_send_message_empty_response _______________________
tests/unit/test_chat_engine.py:776: in test_send_message_empty_response
    with patch('chat.engine.settings') as mock_settings:
/usr/local/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/unittest/mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <module 'chat.engine' from '/app/chat/engine.py'> does not have the attribute 'settings'
_______________________ TestExtractJSON.test_json_array ________________________
utils/llm_helpers.py:74: in extract_json_from_llm_response
    result = json.loads(json_str)
             ^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/json/__init__.py:346: in loads
    return _default_decoder.decode(s)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/json/decoder.py:340: in decode
    raise JSONDecodeError("Extra data", s, end)
E   json.decoder.JSONDecodeError: Extra data: line 1 column 10 (char 9)

During handling of the above exception, another exception occurred:
tests/unit/test_llm_helpers.py:58: in test_json_array
    result = extract_json_from_llm_response(text)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
utils/llm_helpers.py:83: in extract_json_from_llm_response
    raise ValueError(
E   ValueError: Invalid JSON in LLM response: Extra data: line 1 column 10 (char 9)
E   Position: 9
E   JSON preview: {"id": 1}, {"id": 2}
_____________ test_rut_validation_parametrized[12.345.678-0-False] _____________
tests/unit/test_markers_example.py:167: in test_rut_validation_parametrized
    assert result == expected
E   assert True == False
__________________ TestRUTValidation.test_valid_rut_with_dots __________________
tests/unit/test_validators.py:31: in test_valid_rut_with_dots
    assert validate_rut("12.345.678-9") is True
E   AssertionError: assert False is True
E    +  where False = validate_rut('12.345.678-9')
________________ TestRUTValidation.test_valid_rut_without_dots _________________
tests/unit/test_validators.py:35: in test_valid_rut_without_dots
    assert validate_rut("12345678-9") is True
E   AssertionError: assert False is True
E    +  where False = validate_rut('12345678-9')
___________________ TestRUTValidation.test_valid_rut_with_k ____________________
tests/unit/test_validators.py:39: in test_valid_rut_with_k
    assert validate_rut("12345678-K") is True
E   AssertionError: assert False is True
E    +  where False = validate_rut('12345678-K')
_____________________ TestRUTValidation.test_sanitize_rut ______________________
tests/unit/test_validators.py:56: in test_sanitize_rut
    assert sanitize_rut("invalid") is None
E   AssertionError: assert 'INVALI-D' is None
E    +  where 'INVALI-D' = sanitize_rut('invalid')
________________ TestDTEValidation.test_validate_dte_data_valid ________________
tests/unit/test_validators.py:97: in test_validate_dte_data_valid
    assert is_valid is True
E   assert False is True
_____________ TestDTEValidation.test_validate_dte_data_invalid_rut _____________
tests/unit/test_validators.py:120: in test_validate_dte_data_invalid_rut
    assert is_valid is False
E   assert True is False
=============================== warnings summary ===============================
../usr/local/lib/python3.11/site-packages/pydantic/_internal/_config.py:268
  /usr/local/lib/python3.11/site-packages/pydantic/_internal/_config.py:268: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

../usr/local/lib/python3.11/site-packages/pydantic/fields.py:774
../usr/local/lib/python3.11/site-packages/pydantic/fields.py:774
../usr/local/lib/python3.11/site-packages/pydantic/fields.py:774
  /usr/local/lib/python3.11/site-packages/pydantic/fields.py:774: PydanticDeprecatedSince20: `max_items` is deprecated and will be removed, use `max_length` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    warn('`max_items` is deprecated and will be removed, use `max_length` instead', DeprecationWarning)

main.py:132
  /app/main.py:132: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator('dte_data')

main.py:149
  /app/main.py:149: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator('history')

main.py:181
  /app/main.py:181: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator('pending_pos')

../usr/local/lib/python3.11/site-packages/pydantic/fields.py:768
  /usr/local/lib/python3.11/site-packages/pydantic/fields.py:768: PydanticDeprecatedSince20: `min_items` is deprecated and will be removed, use `min_length` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    warn('`min_items` is deprecated and will be removed, use `min_length` instead', DeprecationWarning)

main.py:202
  /app/main.py:202: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator('lines')

main.py:1083
  /app/main.py:1083: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("startup")

../usr/local/lib/python3.11/site-packages/fastapi/applications.py:4547
../usr/local/lib/python3.11/site-packages/fastapi/applications.py:4547
  /usr/local/lib/python3.11/site-packages/fastapi/applications.py:4547: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    return self.router.on_event(event_type)

main.py:1090
  /app/main.py:1090: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("shutdown")

main.py:1113
  /app/main.py:1113: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator('session_id')

main.py:1124
  /app/main.py:1124: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator('message')

tests/unit/test_anthropic_client.py: 18 warnings
  /usr/local/lib/python3.11/unittest/mock.py:515: PydanticDeprecatedSince20: The `__fields__` attribute is deprecated, use `model_fields` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    if iscoroutinefunction(getattr(spec, attr, None)):

tests/unit/test_anthropic_client.py: 18 warnings
  /usr/local/lib/python3.11/site-packages/pydantic/_internal/_model_construction.py:248: PydanticDeprecatedSince20: The `__fields__` attribute is deprecated, use `model_fields` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    warnings.warn('The `__fields__` attribute is deprecated, use `model_fields` instead.', DeprecationWarning)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.11.14-final-0 _______________

Name                                  Stmts   Miss Branch BrPart   Cover   Missing
----------------------------------------------------------------------------------
analytics/project_matcher_claude.py      85     69     18      0  15.53%   40-42, 74-129, 157-206, 218, 280-319
chat/context_manager.py                  82     67      8      0  16.67%   49-51, 64-88, 102-123, 134-144, 158-175, 185-199, 210-222, 236-256
chat/engine.py                          187    120     40      1  33.48%   136-258, 347->355, 389-424, 441-478, 499-646, 665-694
chat/knowledge_base.py                   86     76     40      0   7.94%   41-42, 56-65, 93-169, 190-231, 235-238, 242-245
clients/anthropic_client.py             104     39     16      4  60.83%   125->138, 133, 199->219, 209-211, 238, 247-248, 258-346, 445-471
main.py                                 471    318     62      0  28.71%   87-91, 107-120, 135-147, 152-156, 184-186, 205-212, 259-432, 453-483, 503, 524-535, 554-577, 593-618, 636-640, 686-719, 771-808, 852-889, 921-949, 983-999, 1025-1078, 1086, 1093, 1116-1122, 1127-1136, 1158-1206, 1243-1268, 1333-1363, 1391-1407, 1428-1446, 1467-1485, 1507-1523
middleware/observability.py              49     36      4      0  24.53%   42, 55-118, 130, 133-161
payroll/__init__.py                       3      3      0      0   0.00%   10-13
payroll/payroll_validator.py             64     64     12      0   0.00%   9-252
payroll/previred_scraper.py             100    100     16      0   0.00%   10-348
plugins/account/__init__.py               2      2      0      0   0.00%   3-5
plugins/account/plugin.py                32     12      2      0  58.82%   36, 79-110
plugins/base.py                          13      4      0      0  69.23%   88, 97, 106, 115
plugins/dte/plugin.py                    34     13      2      0  58.33%   82-111
plugins/loader.py                        98     33     34      8  64.39%   53->58, 78-82, 97-102, 107->86, 116-117, 155-160, 174-183, 213-218, 239-244, 277-278, 304-332, 347-349
plugins/payroll/__init__.py               2      2      0      0   0.00%   5-7
plugins/payroll/plugin.py                37     15      2      0  56.41%   122-163, 175
plugins/registry.py                      98     25     30      6  72.66%   49->52, 68-69, 81-82, 108-111, 121, 146-162, 180->184, 215->224, 338-343, 361, 382, 415-423
plugins/stock/__init__.py                 2      2      0      0   0.00%   5-7
plugins/stock/plugin.py                  49     27     12      0  36.07%   129-188, 200
routes/analytics.py                      76     31     10      0  52.33%   24-25, 96-123, 150-184, 193-195, 214
sii_monitor/__init__.py                   2      2      0      0   0.00%   16-17
sii_monitor/analyzer.py                  56     56      2      0   0.00%   7-207
sii_monitor/classifier.py                40     40     18      0   0.00%   7-84
sii_monitor/extractor.py                 71     71     24      0   0.00%   7-157
sii_monitor/notifier.py                  55     55     12      0   0.00%   7-169
sii_monitor/orchestrator.py              82     82     12      0   0.00%   7-178
sii_monitor/scraper.py                   61     61      6      0   0.00%   7-181
sii_monitor/storage.py                   51     51      2      0   0.00%   7-140
test_dependencies.py                     90     90      6      0   0.00%   7-142
utils/cache.py                          110     94     20      0  12.31%   38-101, 130-194, 205-218, 238-268, 281-313
utils/circuit_breaker.py                 99     40     20      6  54.62%   99, 104, 109, 113-116, 122-125, 130-134, 142-146, 150-161, 173, 175, 181, 185-188, 199, 216-221, 225
utils/cost_tracker.py                    96     49     20      0  40.52%   183-184, 208-288, 303-305
utils/llm_helpers.py                     52      3     26      6  88.46%   48, 65->70, 126->145, 128->127, 140, 164
utils/metrics.py                         54     54      4      0   0.00%   19-316
utils/redis_helper.py                    64     36     12      2  42.11%   68, 143-152, 156, 170-215, 226-241
utils/validators.py                      78     16     44      9  74.59%   66, 73-74, 152, 157, 162, 165->170, 171->174, 197, 242, 261, 280-291
----------------------------------------------------------------------------------
TOTAL                                  2791   1858    536     42  31.53%

8 files skipped due to complete coverage.
Coverage HTML written to dir htmlcov
Coverage JSON written to file .coverage.json
FAIL Required test coverage of 80% not reached. Total coverage: 31.53%
=========================== short test summary info ============================
FAILED tests/integration/test_prompt_caching.py::TestPromptCachingIntegration::test_cache_control_header_in_system_messages - RuntimeError: asyncio.run() cannot be called from a running event loop
FAILED tests/integration/test_token_precounting.py::TestTokenPrecountingIntegration::test_precounting_validates_against_model_limits - ValueError: Request too large: 130000 tokens (max 100000)
FAILED tests/integration/test_token_precounting.py::TestTokenPrecountingIntegration::test_precounting_prevents_expensive_requests - AssertionError: assert ('expensive' in 'request too large: 130000 tokens (max 100000)' or 'cost' in 'request too large: 130000 tokens (max 100000)')
 +  where 'request too large: 130000 tokens (max 100000)' = <built-in method lower of str object at 0xffff9123b0f0>()
 +    where <built-in method lower of str object at 0xffff9123b0f0> = 'Request too large: 130000 tokens (max 100000)'.lower
 +      where 'Request too large: 130000 tokens (max 100000)' = str(ValueError('Request too large: 130000 tokens (max 100000)'))
 +  and   'request too large: 130000 tokens (max 100000)' = <built-in method lower of str object at 0xffff9123b0f0>()
 +    where <built-in method lower of str object at 0xffff9123b0f0> = 'Request too large: 130000 tokens (max 100000)'.lower
 +      where 'Request too large: 130000 tokens (max 100000)' = str(ValueError('Request too large: 130000 tokens (max 100000)'))
FAILED tests/integration/test_token_precounting.py::TestTokenPrecountingIntegration::test_precounting_logging - AssertionError: assert ('token_estimation' in '' or 'estimate' in '')
 +  where '' = <_pytest.logging.LogCaptureFixture object at 0xffff911f3210>.text
 +  and   '' = <built-in method lower of str object at 0xffff964f1188>()
 +    where <built-in method lower of str object at 0xffff964f1188> = ''.lower
 +      where '' = <_pytest.logging.LogCaptureFixture object at 0xffff911f3210>.text
FAILED tests/integration/test_token_precounting.py::TestTokenPrecountingIntegration::test_validate_dte_uses_precounting - TypeError: object MagicMock can't be used in 'await' expression
FAILED tests/integration/test_token_precounting.py::TestTokenPrecountingIntegration::test_precounting_handles_api_errors - TypeError: APIError.__init__() missing 1 required positional argument: 'request'
FAILED tests/unit/test_anthropic_client.py::test_estimate_tokens_success - AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
FAILED tests/unit/test_anthropic_client.py::test_estimate_tokens_without_system_prompt - AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
FAILED tests/unit/test_anthropic_client.py::test_estimate_tokens_exceeds_max_tokens - AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
FAILED tests/unit/test_anthropic_client.py::test_estimate_tokens_exceeds_max_cost - AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
FAILED tests/unit/test_anthropic_client.py::test_estimate_tokens_api_error - TypeError: APIError.__init__() missing 1 required positional argument: 'request'
FAILED tests/unit/test_anthropic_client.py::test_validate_dte_success - AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
FAILED tests/unit/test_anthropic_client.py::test_validate_dte_with_caching - AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
FAILED tests/unit/test_anthropic_client.py::test_validate_dte_cost_exceeded - AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
FAILED tests/unit/test_anthropic_client.py::test_validate_dte_circuit_breaker_open - AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
FAILED tests/unit/test_anthropic_client.py::test_validate_dte_json_parse_error - AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
FAILED tests/unit/test_anthropic_client.py::test_validate_dte_with_history - AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
FAILED tests/unit/test_anthropic_client.py::test_call_with_caching_no_cache - AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
FAILED tests/unit/test_anthropic_client.py::test_call_with_caching_with_context - AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
FAILED tests/unit/test_anthropic_client.py::test_call_with_caching_custom_tokens_temp - AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
FAILED tests/unit/test_anthropic_client.py::test_validate_dte_rate_limit_error - AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
FAILED tests/unit/test_anthropic_client.py::test_build_validation_user_prompt_long_history - assert 8 <= 5
 +  where 8 = <built-in method count of str object at 0xaaaaf398eac0>('E')
 +    where <built-in method count of str object at 0xaaaaf398eac0> = 'Analiza este DTE:\n\nDTE:\n{"tipo_dte": "33", "folio": "12345", "fecha_emision": "2025-10-22", "rut_emisor": "12345678-9", "rut_receptor": "98765432-1", "monto_total": 119000, "monto_neto": 100000, "monto_iva": 19000, "items": [{"nombre": "Producto Test", "cantidad": 1, "precio_unitario": 100000}]}\n\nHISTORIAL (\xfaltimos 3 rechazos):\n[{"err": "E000", "msg": "Error message 0"}, {"err": "E001", "msg": "Error message 1"}, {"err": "E002", "msg": "Error message 2"}]\n\nResponde SOLO JSON compacto.'.count
FAILED tests/unit/test_anthropic_client.py::test_estimate_tokens_precounting_disabled - AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
FAILED tests/unit/test_anthropic_client.py::test_validate_dte_cache_hit_tracking - AttributeError: <module 'clients.anthropic_client' from '/app/clients/anthropic_client.py'> does not have the attribute 'settings'
FAILED tests/unit/test_chat_engine.py::test_send_message_basic - AttributeError: <module 'chat.engine' from '/app/chat/engine.py'> does not have the attribute 'settings'
FAILED tests/unit/test_chat_engine.py::test_send_message_without_user_context - AttributeError: <module 'chat.engine' from '/app/chat/engine.py'> does not have the attribute 'settings'
FAILED tests/unit/test_chat_engine.py::test_send_message_with_conversation_history - AttributeError: <module 'chat.engine' from '/app/chat/engine.py'> does not have the attribute 'settings'
FAILED tests/unit/test_chat_engine.py::test_send_message_plugin_selection - AttributeError: <module 'chat.engine' from '/app/chat/engine.py'> does not have the attribute 'settings'
FAILED tests/unit/test_chat_engine.py::test_send_message_knowledge_base_search - AttributeError: <module 'chat.engine' from '/app/chat/engine.py'> does not have the attribute 'settings'
FAILED tests/unit/test_chat_engine.py::test_send_message_anthropic_api_error - AttributeError: <module 'chat.engine' from '/app/chat/engine.py'> does not have the attribute 'settings'
FAILED tests/unit/test_chat_engine.py::test_call_anthropic_success - AttributeError: <module 'chat.engine' from '/app/chat/engine.py'> does not have the attribute 'settings'
FAILED tests/unit/test_chat_engine.py::test_call_anthropic_api_error - AttributeError: <module 'chat.engine' from '/app/chat/engine.py'> does not have the attribute 'settings'
FAILED tests/unit/test_chat_engine.py::test_call_anthropic_filters_system_messages - AttributeError: <module 'chat.engine' from '/app/chat/engine.py'> does not have the attribute 'settings'
FAILED tests/unit/test_chat_engine.py::test_send_message_confidence_hardcoded_todo - AttributeError: <module 'chat.engine' from '/app/chat/engine.py'> does not have the attribute 'settings'
FAILED tests/unit/test_chat_engine.py::test_send_message_max_context_messages - AttributeError: <module 'chat.engine' from '/app/chat/engine.py'> does not have the attribute 'settings'
FAILED tests/unit/test_chat_engine.py::test_send_message_empty_response - AttributeError: <module 'chat.engine' from '/app/chat/engine.py'> does not have the attribute 'settings'
FAILED tests/unit/test_llm_helpers.py::TestExtractJSON::test_json_array - ValueError: Invalid JSON in LLM response: Extra data: line 1 column 10 (char 9)
Position: 9
JSON preview: {"id": 1}, {"id": 2}
FAILED tests/unit/test_markers_example.py::test_rut_validation_parametrized[12.345.678-0-False] - assert True == False
FAILED tests/unit/test_validators.py::TestRUTValidation::test_valid_rut_with_dots - AssertionError: assert False is True
 +  where False = validate_rut('12.345.678-9')
FAILED tests/unit/test_validators.py::TestRUTValidation::test_valid_rut_without_dots - AssertionError: assert False is True
 +  where False = validate_rut('12345678-9')
FAILED tests/unit/test_validators.py::TestRUTValidation::test_valid_rut_with_k - AssertionError: assert False is True
 +  where False = validate_rut('12345678-K')
FAILED tests/unit/test_validators.py::TestRUTValidation::test_sanitize_rut - AssertionError: assert 'INVALI-D' is None
 +  where 'INVALI-D' = sanitize_rut('invalid')
FAILED tests/unit/test_validators.py::TestDTEValidation::test_validate_dte_data_valid - assert False is True
FAILED tests/unit/test_validators.py::TestDTEValidation::test_validate_dte_data_invalid_rut - assert True is False
ERROR tests/integration/test_critical_endpoints.py::TestDTEValidationEndpoint::test_validate_dte_success - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_critical_endpoints.py::TestDTEValidationEndpoint::test_validate_dte_invalid_tipo - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_critical_endpoints.py::TestDTEValidationEndpoint::test_validate_dte_negative_company_id - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_critical_endpoints.py::TestDTEValidationEndpoint::test_validate_dte_unauthorized - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_critical_endpoints.py::TestPOMatchingEndpoint::test_match_po_endpoint_exists - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_critical_endpoints.py::TestPOMatchingEndpoint::test_match_po_invalid_rut - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_critical_endpoints.py::TestPOMatchingEndpoint::test_match_po_invalid_monto - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_critical_endpoints.py::TestAnalyticsEndpoint::test_suggest_project_success - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_critical_endpoints.py::TestChatEndpoints::test_create_session - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_critical_endpoints.py::TestChatEndpoints::test_send_message_invalid_long - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_critical_endpoints.py::TestHealthEndpoint::test_health_check - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_critical_endpoints.py::TestRateLimiting::test_rate_limit_validation_endpoint - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_prompt_caching.py::TestPromptCachingIntegration::test_caching_endpoint_exists - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_prompt_caching.py::TestPromptCachingIntegration::test_caching_creates_cache_on_first_call - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_prompt_caching.py::TestPromptCachingIntegration::test_caching_reads_cache_on_second_call - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_prompt_caching.py::TestPromptCachingIntegration::test_caching_reduces_costs - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_prompt_caching.py::TestPromptCachingIntegration::test_caching_with_multiple_validations - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_prompt_caching.py::TestPromptCachingIntegration::test_cache_different_contexts - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_prompt_caching.py::TestPromptCachingIntegration::test_caching_preserves_validation_quality - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_prompt_caching.py::TestPromptCachingIntegration::test_caching_with_history - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_prompt_caching.py::TestPromptCachingIntegration::test_caching_error_handling - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_streaming_sse.py::TestStreamingSSEIntegration::test_streaming_endpoint_exists - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_streaming_sse.py::TestStreamingSSEIntegration::test_streaming_returns_sse_format - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_streaming_sse.py::TestStreamingSSEIntegration::test_streaming_progressive_tokens - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_streaming_sse.py::TestStreamingSSEIntegration::test_streaming_handles_errors_gracefully - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_streaming_sse.py::TestStreamingSSEIntegration::test_streaming_sends_done_event - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_streaming_sse.py::TestStreamingSSEIntegration::test_streaming_maintains_session_context - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_streaming_sse.py::TestStreamingSSEIntegration::test_streaming_with_knowledge_base_injection - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_streaming_sse.py::TestStreamingSSEIntegration::test_streaming_with_caching_metrics - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_streaming_sse.py::TestStreamingSSEIntegration::test_streaming_with_empty_response - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_streaming_sse.py::TestStreamingSSEIntegration::test_streaming_large_response - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/integration/test_streaming_sse.py::TestStreamingSSEIntegration::test_streaming_respects_rate_limiting - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/test_dte_regression.py::TestDTEValidationEndpoint::test_endpoint_exists - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/test_dte_regression.py::TestDTEValidationEndpoint::test_endpoint_requires_auth - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/test_dte_regression.py::TestDTEValidationEndpoint::test_response_format - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/test_dte_regression.py::TestDTEValidationEndpoint::test_handles_invalid_data - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/test_dte_regression.py::TestDTEValidationEndpoint::test_preserves_history_parameter - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/test_dte_regression.py::TestChatEndpoint::test_endpoint_exists - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/test_dte_regression.py::TestChatEndpoint::test_endpoint_requires_auth - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/test_dte_regression.py::TestChatEndpoint::test_dte_knowledge_preserved - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/test_dte_regression.py::TestChatEndpoint::test_session_management - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/test_dte_regression.py::TestHealthEndpoint::test_health_check - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/test_dte_regression.py::TestSIIMonitoring::test_sii_monitor_endpoint_exists - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/test_dte_regression.py::TestBackwardCompatibility::test_all_critical_endpoints_exist - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/test_dte_regression.py::TestPerformanceBaseline::test_validation_response_time - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/test_dte_regression.py::TestPerformanceBaseline::test_chat_response_time - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/unit/test_chat_engine.py::test_send_message_stream_basic
ERROR tests/unit/test_chat_engine.py::test_send_message_stream_disabled
ERROR tests/unit/test_chat_engine.py::test_send_message_stream_confidence_hardcoded_todo
ERROR tests/unit/test_markers_example.py::test_api_health_check - TypeError: Client.__init__() got an unexpected keyword argument 'app'
ERROR tests/unit/test_markers_example.py::test_api_with_auth_headers - TypeError: Client.__init__() got an unexpected keyword argument 'app'
======= 44 failed, 88 passed, 2 skipped, 51 warnings, 51 errors in 4.44s =======
