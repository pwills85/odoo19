2025-11-09 06:33:25 [info     ] circuit_breaker_initialized    failure_threshold=5 name=anthropic_api recovery_timeout=60.0
============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-8.4.2, pluggy-1.6.0
rootdir: /app
configfile: pyproject.toml
testpaths: tests
plugins: asyncio-1.2.0, cov-7.0.0, anyio-3.7.1
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 185 items

<Dir app>
  <Package tests>
    <Package integration>
      <Module test_critical_endpoints.py>
        <Class TestDTEValidationEndpoint>
          <Function test_validate_dte_success>
          <Function test_validate_dte_invalid_tipo>
          <Function test_validate_dte_negative_company_id>
          <Function test_validate_dte_unauthorized>
        <Class TestPOMatchingEndpoint>
          <Function test_match_po_endpoint_exists>
          <Function test_match_po_invalid_rut>
          <Function test_match_po_invalid_monto>
        <Class TestAnalyticsEndpoint>
          <Function test_suggest_project_success>
        <Class TestChatEndpoints>
          <Function test_create_session>
          <Function test_send_message_invalid_long>
        <Class TestHealthEndpoint>
          <Function test_health_check>
        <Class TestRateLimiting>
          <Function test_rate_limit_validation_endpoint>
      <Module test_prompt_caching.py>
        <Class TestPromptCachingIntegration>
          <Coroutine test_caching_endpoint_exists>
          <Coroutine test_caching_creates_cache_on_first_call>
          <Coroutine test_caching_reads_cache_on_second_call>
          <Coroutine test_caching_reduces_costs>
          <Coroutine test_cache_control_header_in_system_messages>
          <Coroutine test_caching_with_multiple_validations>
          <Coroutine test_cache_different_contexts>
          <Coroutine test_caching_preserves_validation_quality>
          <Coroutine test_caching_with_history>
          <Coroutine test_caching_error_handling>
      <Module test_streaming_sse.py>
        <Class TestStreamingSSEIntegration>
          <Coroutine test_streaming_endpoint_exists>
          <Coroutine test_streaming_returns_sse_format>
          <Coroutine test_streaming_progressive_tokens>
          <Coroutine test_streaming_handles_errors_gracefully>
          <Coroutine test_streaming_sends_done_event>
          <Coroutine test_streaming_maintains_session_context>
          <Coroutine test_streaming_with_knowledge_base_injection>
          <Coroutine test_streaming_with_caching_metrics>
          <Coroutine test_streaming_with_empty_response>
          <Coroutine test_streaming_large_response>
          <Coroutine test_streaming_respects_rate_limiting>
      <Module test_token_precounting.py>
        <Class TestTokenPrecountingIntegration>
          <Coroutine test_estimate_tokens_returns_valid_format>
          <Coroutine test_token_estimation_accuracy>
          <Coroutine test_precounting_prevents_oversized_requests>
          <Coroutine test_precounting_validates_against_model_limits>
          <Coroutine test_estimate_includes_system_prompt_overhead>
          <Coroutine test_cost_estimation_accuracy>
          <Coroutine test_precounting_with_conversation_history>
          <Coroutine test_precounting_prevents_expensive_requests>
          <Coroutine test_token_counting_with_special_characters>
          <Coroutine test_token_counting_empty_messages>
          <Coroutine test_precounting_logging>
          <Coroutine test_validate_dte_uses_precounting>
          <Coroutine test_token_counting_model_differences>
          <Coroutine test_precounting_handles_api_errors>
          <Coroutine test_token_estimation_consistency>
    <Module test_dte_regression.py>
      <Class TestDTEValidationEndpoint>
        <Function test_endpoint_exists>
        <Function test_endpoint_requires_auth>
        <Function test_response_format>
        <Function test_handles_invalid_data>
        <Function test_preserves_history_parameter>
      <Class TestChatEndpoint>
        <Function test_endpoint_exists>
        <Function test_endpoint_requires_auth>
        <Function test_dte_knowledge_preserved>
        <Function test_session_management>
      <Class TestHealthEndpoint>
        <Function test_health_check>
      <Class TestSIIMonitoring>
        <Function test_sii_monitor_endpoint_exists>
      <Class TestBackwardCompatibility>
        <Function test_all_critical_endpoints_exist>
        <Function test_pydantic_models_unchanged>
      <Class TestPerformanceBaseline>
        <Function test_validation_response_time>
        <Function test_chat_response_time>
    <Package unit>
      <Module test_anthropic_client.py>
        <Function test_anthropic_client_init>
        <Function test_anthropic_client_init_default_model>
        <Coroutine test_estimate_tokens_success>
        <Coroutine test_estimate_tokens_without_system_prompt>
        <Coroutine test_estimate_tokens_exceeds_max_tokens>
        <Coroutine test_estimate_tokens_exceeds_max_cost>
        <Coroutine test_estimate_tokens_api_error>
        <Coroutine test_validate_dte_success>
        <Coroutine test_validate_dte_with_caching>
        <Coroutine test_validate_dte_cost_exceeded>
        <Coroutine test_validate_dte_circuit_breaker_open>
        <Coroutine test_validate_dte_json_parse_error>
        <Coroutine test_validate_dte_with_history>
        <Function test_build_validation_system_prompt>
        <Function test_build_validation_user_prompt_compact>
        <Function test_build_validation_user_prompt_empty_history>
        <Coroutine test_call_with_caching_no_cache>
        <Coroutine test_call_with_caching_with_context>
        <Coroutine test_call_with_caching_custom_tokens_temp>
        <Function test_get_anthropic_client_singleton>
        <Coroutine test_validate_dte_rate_limit_error>
        <Function test_build_validation_user_prompt_long_history>
        <Coroutine test_estimate_tokens_precounting_disabled>
        <Coroutine test_validate_dte_cache_hit_tracking>
      <Module test_chat_engine.py>
        <Function test_chat_engine_init>
        <Function test_chat_engine_init_with_plugins>
        <Function test_chat_engine_init_custom_parameters>
        <Coroutine test_send_message_basic>
        <Coroutine test_send_message_without_user_context>
        <Coroutine test_send_message_with_conversation_history>
        <Coroutine test_send_message_plugin_selection>
        <Coroutine test_send_message_knowledge_base_search>
        <Coroutine test_send_message_anthropic_api_error>
        <Function test_build_system_prompt_with_context>
        <Function test_build_system_prompt_without_context>
        <Function test_build_system_prompt_no_docs>
        <Function test_build_system_prompt_empty_docs>
        <Function test_build_plugin_system_prompt>
        <Function test_build_plugin_system_prompt_long_doc_content>
        <Coroutine test_call_anthropic_success>
        <Coroutine test_call_anthropic_api_error>
        <Coroutine test_call_anthropic_filters_system_messages>
        <Coroutine test_send_message_stream_basic>
        <Coroutine test_send_message_stream_disabled>
        <Coroutine test_send_message_confidence_hardcoded_todo>
        <Coroutine test_send_message_stream_confidence_hardcoded_todo>
        <Function test_get_conversation_stats>
        <Function test_chat_message_creation>
        <Function test_chat_response_creation>
        <Coroutine test_send_message_max_context_messages>
        <Coroutine test_send_message_empty_response>
      <Module test_cost_tracker.py>
        <Class TestCostTracker>
          <Function test_record_usage_calculation>
          <Function test_record_usage_unknown_model>
          <Function test_token_usage_dataclass>
        <Class TestPricing>
          <Function test_pricing_structure>
          <Function test_cost_calculation_accuracy>
      <Module test_llm_helpers.py>
        <Class TestExtractJSON>
          <Function test_plain_json>
          <Function test_json_in_markdown>
          <Function test_json_with_text_before_after>
          <Function test_json_array>
          <Function test_invalid_no_json>
          <Function test_invalid_malformed_json>
        <Class TestValidateJSONSchema>
          <Function test_valid_schema>
          <Function test_missing_required_field>
          <Function test_wrong_field_type>
        <Class TestSanitizeResponse>
          <Function test_normal_text>
          <Function test_multiple_spaces>
          <Function test_truncate_long_text>
          <Function test_remove_control_chars>
      <Module test_markers_example.py>
        <Function test_simple_function>
        <Function test_string_validation>
        <Function test_with_fixture>
        <Function test_multiple_assertions>
        <Function test_exception_handling>
        <Function test_api_health_check>
        <Function test_api_with_auth_headers>
        <Function test_rut_validation_parametrized[12.345.678-9-True]>
        <Function test_rut_validation_parametrized[12.345.678-0-False]>
        <Function test_rut_validation_parametrized[invalid-False]>
        <Function test_rut_validation_parametrized[-False]>
        <Function test_not_yet_implemented>
        <Function test_requires_feature>
        <Function test_with_multiple_markers>
        <Function test_coverage_demonstration>
        <Function test_clear_descriptive_name>
        <Function test_arrange_act_assert_pattern>
        <Function test_one_thing_per_test>
      <Module test_plugin_system.py>
        <Class TestPluginLoader>
          <Function test_loader_initialization>
          <Function test_discover_plugins>
          <Function test_load_all_plugins>
        <Class TestPluginRegistry>
          <Function test_registry_auto_discover>
          <Function test_get_plugin>
          <Function test_plugin_selection_explicit_context>
          <Function test_plugin_selection_keyword_matching_dte>
          <Function test_plugin_selection_keyword_matching_payroll>
          <Function test_plugin_selection_keyword_matching_stock>
          <Function test_plugin_selection_fallback>
          <Function test_usage_stats_tracking>
          <Function test_get_stats>
          <Function test_singleton_registry>
        <Class TestPluginInterface>
          <Function test_dte_plugin_interface>
          <Function test_payroll_plugin_interface>
          <Function test_stock_plugin_interface>
      <Module test_validators.py>
        <Class TestRUTValidation>
          <Function test_valid_rut_with_dots>
          <Function test_valid_rut_without_dots>
          <Function test_valid_rut_with_k>
          <Function test_invalid_rut_checksum>
          <Function test_invalid_rut_format>
          <Function test_sanitize_rut>
        <Class TestDTEValidation>
          <Function test_valid_dte_types>
          <Function test_invalid_dte_types>
          <Function test_valid_dte_amounts>
          <Function test_invalid_dte_amounts>
          <Function test_validate_dte_data_valid>
          <Function test_validate_dte_data_missing_field>
          <Function test_validate_dte_data_invalid_rut>
        <Class TestStringValidation>
          <Function test_sanitize_normal_string>
          <Function test_sanitize_string_max_length>
          <Function test_sanitize_control_characters>
        <Class TestNumericValidation>
          <Function test_validate_positive_number>
          <Function test_validate_percentage>
          <Function test_validate_company_id>

=============================== warnings summary ===============================
../usr/local/lib/python3.11/site-packages/pydantic/_internal/_config.py:268
  /usr/local/lib/python3.11/site-packages/pydantic/_internal/_config.py:268: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

../usr/local/lib/python3.11/site-packages/pydantic/fields.py:774
../usr/local/lib/python3.11/site-packages/pydantic/fields.py:774
../usr/local/lib/python3.11/site-packages/pydantic/fields.py:774
  /usr/local/lib/python3.11/site-packages/pydantic/fields.py:774: PydanticDeprecatedSince20: `max_items` is deprecated and will be removed, use `max_length` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    warn('`max_items` is deprecated and will be removed, use `max_length` instead', DeprecationWarning)

main.py:132
  /app/main.py:132: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator('dte_data')

main.py:149
  /app/main.py:149: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator('history')

main.py:181
  /app/main.py:181: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator('pending_pos')

../usr/local/lib/python3.11/site-packages/pydantic/fields.py:768
  /usr/local/lib/python3.11/site-packages/pydantic/fields.py:768: PydanticDeprecatedSince20: `min_items` is deprecated and will be removed, use `min_length` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    warn('`min_items` is deprecated and will be removed, use `min_length` instead', DeprecationWarning)

main.py:202
  /app/main.py:202: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator('lines')

main.py:1083
  /app/main.py:1083: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("startup")

../usr/local/lib/python3.11/site-packages/fastapi/applications.py:4547
../usr/local/lib/python3.11/site-packages/fastapi/applications.py:4547
  /usr/local/lib/python3.11/site-packages/fastapi/applications.py:4547: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    return self.router.on_event(event_type)

main.py:1090
  /app/main.py:1090: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("shutdown")

main.py:1113
  /app/main.py:1113: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator('session_id')

main.py:1124
  /app/main.py:1124: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator('message')

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.11.14-final-0 _______________

Name                                  Stmts   Miss Branch BrPart   Cover   Missing
----------------------------------------------------------------------------------
analytics/project_matcher_claude.py      85     69     18      0  15.53%   40-42, 74-129, 157-206, 218, 280-319
chat/context_manager.py                  82     67      8      0  16.67%   49-51, 64-88, 102-123, 134-144, 158-175, 185-199, 210-222, 236-256
chat/engine.py                          187    154     40      0  14.54%   96-108, 136-258, 276-309, 332-372, 389-424, 441-478, 499-646, 665-694, 706
chat/knowledge_base.py                   86     76     40      0   7.94%   41-42, 56-65, 93-169, 190-231, 235-238, 242-245
clients/anthropic_client.py             104     87     16      0  14.17%   45-48, 86-142, 187-356, 364, 400-418, 445-471, 481-483
main.py                                 471    318     62      0  28.71%   87-91, 107-120, 135-147, 152-156, 184-186, 205-212, 259-432, 453-483, 503, 524-535, 554-577, 593-618, 636-640, 686-719, 771-808, 852-889, 921-949, 983-999, 1025-1078, 1086, 1093, 1116-1122, 1127-1136, 1158-1206, 1243-1268, 1333-1363, 1391-1407, 1428-1446, 1467-1485, 1507-1523
middleware/observability.py              49     36      4      0  24.53%   42, 55-118, 130, 133-161
payroll/__init__.py                       3      3      0      0   0.00%   10-13
payroll/payroll_validator.py             64     64     12      0   0.00%   9-252
payroll/previred_scraper.py             100    100     16      0   0.00%   10-348
plugins/account/__init__.py               2      2      0      0   0.00%   3-5
plugins/account/plugin.py                32     32      2      0   0.00%   10-132
plugins/base.py                          13      4      0      0  69.23%   88, 97, 106, 115
plugins/dte/plugin.py                    34     34      2      0   0.00%   9-125
plugins/loader.py                        98     81     34      0  12.88%   53-60, 75-130, 147-183, 200-218, 230-250, 259-292, 304-332, 347-349
plugins/payroll/__init__.py               2      2      0      0   0.00%   5-7
plugins/payroll/plugin.py                37     37      2      0   0.00%   17-178
plugins/registry.py                      98     79     30      0  14.84%   43-52, 60-82, 98-127, 146-162, 178-184, 206-343, 352, 361, 382, 391, 415-423, 442-444
plugins/stock/__init__.py                 2      2      0      0   0.00%   5-7
plugins/stock/plugin.py                  49     49     12      0   0.00%   17-203
routes/analytics.py                      76     31     10      0  52.33%   24-25, 96-123, 150-184, 193-195, 214
sii_monitor/__init__.py                   2      2      0      0   0.00%   16-17
sii_monitor/analyzer.py                  56     56      2      0   0.00%   7-207
sii_monitor/classifier.py                40     40     18      0   0.00%   7-84
sii_monitor/extractor.py                 71     71     24      0   0.00%   7-157
sii_monitor/notifier.py                  55     55     12      0   0.00%   7-169
sii_monitor/orchestrator.py              82     82     12      0   0.00%   7-178
sii_monitor/scraper.py                   61     61      6      0   0.00%   7-181
sii_monitor/storage.py                   51     51      2      0   0.00%   7-140
test_dependencies.py                     90     90      6      0   0.00%   7-142
utils/cache.py                          110     94     20      0  12.31%   38-101, 130-194, 205-218, 238-268, 281-313
utils/circuit_breaker.py                 99     53     20      0  38.66%   99, 104, 109, 113-116, 122-125, 130-134, 139-146, 150-161, 165-175, 180-193, 197-205, 216-221, 225
utils/cost_tracker.py                    96     72     20      0  20.69%   88, 114-149, 160-184, 208-288, 303-305
utils/llm_helpers.py                     52     44     26      0  10.26%   47-83, 118-145, 163-182
utils/metrics.py                         54     54      4      0   0.00%   19-316
utils/redis_helper.py                    64     51     12      0  17.11%   63-68, 80-158, 170-215, 226-241
utils/validators.py                      78     62     44      0  13.11%   47-50, 65-74, 107, 122-125, 138-174, 196-207, 220-223, 241-247, 260-263, 280-291
----------------------------------------------------------------------------------
TOTAL                                  2791   2265    536      0  15.81%

8 files skipped due to complete coverage.
Coverage HTML written to dir htmlcov
Coverage JSON written to file .coverage.json
FAIL Required test coverage of 80% not reached. Total coverage: 15.81%
========================= 185 tests collected in 1.33s =========================
