<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ══════════════════════════════════════════════════════════════════════
         CONTINGENCY MODE WIZARD - VIEWS
         ══════════════════════════════════════════════════════════════════════
         Migration from: odoo-eergy-services/routes/contingency.py (2025-10-24)

         OBLIGATORIO por normativa SII chilena:
         - Permite operar cuando SII no está disponible
         - Almacena DTEs localmente para envío posterior
         - Upload masivo cuando SII vuelve
    -->

    <!-- Form View -->
    <record id="view_contingency_wizard_form" model="ir.ui.view">
        <field name="name">contingency.wizard.form</field>
        <field name="model">contingency.wizard</field>
        <field name="arch" type="xml">
            <form string="Contingency Mode Management">
                <div class="alert alert-warning" role="alert" invisible="current_status == False">
                    <strong>⚠️ CONTINGENCY MODE ACTIVE</strong>
                    <p>DTEs are being stored locally. They will be sent to SII when you disable contingency mode.</p>
                </div>

                <div class="alert alert-success" role="alert" invisible="current_status == True">
                    <strong>✅ Normal Operation</strong>
                    <p>DTEs are being sent directly to SII.</p>
                </div>

                <group>
                    <group name="status_info" string="Current Status">
                        <field name="current_status" string="Contingency Enabled" readonly="1" widget="boolean_toggle"/>
                        <field name="pending_dtes_count" string="Pending DTEs" readonly="1"/>
                    </group>

                    <group name="action_selection" string="Action">
                        <field name="action" widget="radio" required="1"/>
                    </group>
                </group>

                <group invisible="action not in ['enable', 'disable']">
                    <group name="enable_options" string="Details" invisible="action != 'enable'">
                        <field name="reason" string="Reason" required="1"/>
                        <field name="comment" string="Comment" placeholder="Optional: Describe the reason for enabling contingency mode"/>
                    </group>

                    <group name="disable_warning" string="Warning" invisible="action != 'disable'">
                        <div class="alert alert-info" role="alert" invisible="pending_dtes_count == 0">
                            <strong>Note:</strong>
                            <p>
                                You have <field name="pending_dtes_count" readonly="1" nolabel="1"/> pending DTE(s).
                                You must upload them before disabling contingency mode.
                            </p>
                        </div>
                    </group>
                </group>

                <group invisible="action != 'upload_pending'">
                    <group name="upload_options" string="Upload Options">
                        <field name="batch_size" string="Batch Size (DTEs per run)" required="1"/>
                        <div class="alert alert-info" role="alert">
                            <strong>Upload Process:</strong>
                            <p>
                                • Total pending DTEs: <field name="pending_dtes_count" readonly="1" nolabel="1"/><br/>
                                • DTEs will be uploaded in batches<br/>
                                • SII will validate each DTE<br/>
                                • Failed DTEs will be reported
                            </p>
                        </div>
                    </group>
                </group>

                <footer>
                    <button name="execute_action"
                            string="Execute"
                            type="object"
                            class="btn-primary"
                            invisible="action == False"/>
                    <button string="Cancel" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <!-- Action to open wizard -->
    <record id="action_contingency_wizard" model="ir.actions.act_window">
        <field name="name">Contingency Mode Management</field>
        <field name="res_model">contingency.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="binding_model_id" ref="model_dte_contingency"/>
        <field name="binding_view_types">form,list</field>
    </record>

    <!-- Menu item in Settings > DTE -->
    <menuitem id="menu_contingency_wizard"
              name="Contingency Mode"
              parent="account.menu_finance_configuration"
              action="action_contingency_wizard"
              sequence="50"
              groups="account.group_account_manager"/>
</odoo>
