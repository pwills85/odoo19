<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ============================================================ -->
    <!-- RCV PERIOD - TREE VIEW -->
    <!-- ============================================================ -->
    <record id="view_l10n_cl_rcv_period_tree" model="ir.ui.view">
        <field name="name">l10n_cl.rcv.period.tree</field>
        <field name="model">l10n_cl.rcv.period</field>
        <field name="arch" type="xml">
            <list string="Per√≠odos RCV"
                  decoration-info="state == 'open'"
                  decoration-success="state == 'declared'"
                  decoration-muted="state == 'closed'">

                <field name="display_name"/>
                <field name="period_date"/>
                <field name="state" widget="badge"
                       decoration-info="state == 'open'"
                       decoration-success="state == 'declared'"
                       decoration-muted="state == 'closed'"/>

                <field name="sale_entry_count"/>
                <field name="total_sales" sum="Total Ventas"/>
                <field name="purchase_entry_count"/>
                <field name="total_purchases" sum="Total Compras"/>

                <field name="vat_debit" sum="Total IVA D√©bito"/>
                <field name="vat_credit" sum="Total IVA Cr√©dito"/>
                <field name="vat_balance" sum="Saldo IVA"
                       decoration-danger="vat_balance &gt; 0"
                       decoration-success="vat_balance &lt; 0"/>

                <field name="sii_discrepancy_count"
                       decoration-danger="sii_discrepancy_count &gt; 0"/>

                <field name="company_id" groups="base.group_multi_company" optional="show"/>
            </list>
        </field>
    </record>

    <!-- ============================================================ -->
    <!-- RCV PERIOD - FORM VIEW -->
    <!-- ============================================================ -->
    <record id="view_l10n_cl_rcv_period_form" model="ir.ui.view">
        <field name="name">l10n_cl.rcv.period.form</field>
        <field name="model">l10n_cl.rcv.period</field>
        <field name="arch" type="xml">
            <form string="Per√≠odo RCV">
                <header>
                    <field name="state" widget="statusbar" statusbar_visible="open,closed,declared"/>

                    <button name="action_sync_with_sii"
                            string="Sincronizar con SII"
                            type="object"
                            class="oe_highlight"
                            invisible="state == 'declared'"
                            icon="fa-refresh"
                            confirm="¬øSincronizar este per√≠odo con el RCV del SII?"/>

                    <button name="action_fetch_f29_proposal"
                            string="Obtener Propuesta F29"
                            type="object"
                            class="btn-info"
                            icon="fa-file-text-o"/>

                    <button name="action_close_period"
                            string="Cerrar Per√≠odo"
                            type="object"
                            invisible="state != 'open'"
                            confirm="¬øCerrar este per√≠odo? No se podr√°n agregar m√°s entradas."/>

                    <button name="action_reopen_period"
                            string="Reabrir Per√≠odo"
                            type="object"
                            invisible="state != 'closed'"
                            groups="account.group_account_manager"
                            confirm="¬øReabrir este per√≠odo?"/>
                </header>

                <sheet>
                    <!-- Alert for discrepancies -->
                    <div class="alert alert-warning" role="alert" invisible="sii_discrepancy_count == 0">
                        <strong>‚ö†Ô∏è Hay <field name="sii_discrepancy_count"/> discrepancias con el SII</strong>
                        <p>
                            <button name="action_view_discrepancies"
                                    string="Ver Discrepancias"
                                    type="object"
                                    class="btn-link"/>
                        </p>
                    </div>

                    <div class="oe_title">
                        <h1>
                            <field name="display_name"/>
                        </h1>
                    </div>

                    <group>
                        <group>
                            <field name="company_id" groups="base.group_multi_company"/>
                            <field name="period_date"/>
                            <field name="currency_id" invisible="1"/>
                        </group>
                        <group>
                            <field name="sii_last_sync_date"/>
                            <field name="sii_f29_fetched_date"/>
                        </group>
                    </group>

                    <!-- Statistics Cards -->
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h5 class="card-title">üìä Ventas</h5>
                                    <p class="card-text">
                                        <strong><field name="sale_entry_count"/> documentos</strong><br/>
                                        Total: <field name="total_sales" widget="monetary"/><br/>
                                        IVA D√©bito: <field name="vat_debit" widget="monetary"/>
                                    </p>
                                    <button name="action_view_entries"
                                            string="Ver Ventas"
                                            type="object"
                                            context="{'default_entry_type': 'sale'}"
                                            class="btn btn-sm btn-primary"/>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h5 class="card-title">üìä Compras</h5>
                                    <p class="card-text">
                                        <strong><field name="purchase_entry_count"/> documentos</strong><br/>
                                        Total: <field name="total_purchases" widget="monetary"/><br/>
                                        IVA Cr√©dito: <field name="vat_credit" widget="monetary"/>
                                    </p>
                                    <button name="action_view_entries"
                                            string="Ver Compras"
                                            type="object"
                                            context="{'default_entry_type': 'purchase'}"
                                            class="btn btn-sm btn-primary"/>
                                </div>
                            </div>
                        </div>
                    </div>

                    <group string="Resumen IVA">
                        <group>
                            <field name="vat_debit" widget="monetary"/>
                            <field name="vat_credit" widget="monetary"/>
                            <field name="vat_balance" widget="monetary" class="oe_subtotal_footer_separator"
                                   decoration-danger="vat_balance &gt; 0"
                                   decoration-success="vat_balance &lt; 0"/>
                        </group>
                        <group>
                            <label for="vat_balance" string=""/>
                            <div>
                                <span invisible="vat_balance &lt;= 0">
                                    <i class="fa fa-arrow-up text-danger"/> IVA a Pagar al SII
                                </span>
                                <span invisible="vat_balance &gt; 0">
                                    <i class="fa fa-arrow-down text-success"/> IVA a Favor del Contribuyente
                                </span>
                            </div>
                        </group>
                    </group>

                    <group string="Declaraci√≥n F29">
                        <field name="tax_return_move_id"/>
                        <field name="f29_declaration_date"/>
                    </group>

                    <notebook>
                        <page string="Propuesta F29 (SII)" invisible="not sii_f29_proposal">
                            <group>
                                <field name="sii_f29_proposal" nolabel="1" widget="text"/>
                            </group>
                        </page>

                        <page string="Entradas RCV" name="entries">
                            <field name="entry_ids" nolabel="1">
                                <list string="Entradas" create="false" edit="false" delete="false">
                                    <field name="date"/>
                                    <field name="entry_type"/>
                                    <field name="document_type_id"/>
                                    <field name="folio"/>
                                    <field name="partner_name"/>
                                    <field name="amount_total"/>
                                    <field name="sii_state"/>
                                </list>
                            </field>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- ============================================================ -->
    <!-- RCV PERIOD - SEARCH VIEW -->
    <!-- ============================================================ -->
    <record id="view_l10n_cl_rcv_period_search" model="ir.ui.view">
        <field name="name">l10n_cl.rcv.period.search</field>
        <field name="model">l10n_cl.rcv.period</field>
        <field name="arch" type="xml">
            <search string="Buscar Per√≠odos RCV">
                <!-- Search fields -->
                <field name="period_date" string="Per√≠odo"/>

                <!-- Filters -->
                <filter string="Abiertos" name="filter_open" domain="[('state', '=', 'open')]"/>
                <filter string="Cerrados" name="filter_closed" domain="[('state', '=', 'closed')]"/>
                <filter string="Declarados" name="filter_declared" domain="[('state', '=', 'declared')]"/>

                <separator/>

                <filter string="Con Discrepancias" name="filter_with_discrepancies"
                        domain="[('sii_discrepancy_count', '&gt;', 0)]"/>

                <separator/>

                <filter string="A√±o Actual" name="filter_current_year"
                        domain="[('period_date', '&gt;=', (context_today() + relativedelta(month=1, day=1)).strftime('%Y-%m-%d')),
                                 ('period_date', '&lt;=', (context_today() + relativedelta(month=12, day=31)).strftime('%Y-%m-%d'))]"/>

                <!-- Group by -->
                <separator/>
                <filter string="Estado" name="group_state" context="{'group_by': 'state'}"/>
                <filter string="A√±o" name="group_year" context="{'group_by': 'period_date:year'}"/>
            </search>
        </field>
    </record>

    <!-- ============================================================ -->
    <!-- RCV PERIOD - KANBAN VIEW -->
    <!-- ============================================================ -->
    <record id="view_l10n_cl_rcv_period_kanban" model="ir.ui.view">
        <field name="name">l10n_cl.rcv.period.kanban</field>
        <field name="model">l10n_cl.rcv.period</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile">
                <field name="display_name"/>
                <field name="period_date"/>
                <field name="state"/>
                <field name="vat_balance"/>
                <field name="total_sales"/>
                <field name="total_purchases"/>
                <field name="sii_discrepancy_count"/>
                <field name="currency_id"/>

                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_global_click">
                            <div class="o_kanban_record_top">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title">
                                        <field name="display_name"/>
                                    </strong>
                                </div>
                                <span class="float-end badge" t-attf-class="badge-#{record.state.raw_value == 'open' ? 'info' : record.state.raw_value == 'declared' ? 'success' : 'secondary'}">
                                    <field name="state"/>
                                </span>
                            </div>

                            <div class="o_kanban_record_body">
                                <div class="row">
                                    <div class="col-6">
                                        <strong>Ventas:</strong> <field name="total_sales" widget="monetary"/><br/>
                                        <strong>Compras:</strong> <field name="total_purchases" widget="monetary"/>
                                    </div>
                                    <div class="col-6">
                                        <strong>IVA:</strong>
                                        <span t-attf-class="#{record.vat_balance.raw_value > 0 ? 'text-danger' : 'text-success'}">
                                            <field name="vat_balance" widget="monetary"/>
                                        </span>
                                    </div>
                                </div>

                                <div class="mt-2" t-if="record.sii_discrepancy_count.raw_value > 0">
                                    <span class="badge badge-warning">
                                        ‚ö†Ô∏è <t t-out="record.sii_discrepancy_count.value"/> discrepancias
                                    </span>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- ============================================================ -->
    <!-- RCV PERIOD - ACTION -->
    <!-- ============================================================ -->
    <record id="action_l10n_cl_rcv_period" model="ir.actions.act_window">
        <field name="name">Per√≠odos RCV</field>
        <field name="res_model">l10n_cl.rcv.period</field>
        <field name="view_mode">kanban,list,form</field>
        <field name="context">{
            'search_default_filter_current_year': 1,
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No hay per√≠odos RCV
            </p>
            <p>
                Los per√≠odos RCV se crean autom√°ticamente al confirmar la primera factura del mes.<br/>
                <strong>Resoluci√≥n SII 61/2017:</strong> Registro obligatorio mensual.
            </p>
        </field>
    </record>

</odoo>
