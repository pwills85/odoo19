<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Extensión de Vista Form de Purchase Order para DTE 34 -->
    <record id="view_purchase_order_form_dte" model="ir.ui.view">
        <field name="name">purchase.order.form.dte</field>
        <field name="model">purchase.order</field>
        <field name="inherit_id" ref="purchase.purchase_order_form"/>
        <field name="arch" type="xml">
            
            <!-- ⭐ NUEVO: Smart button Dashboard Cuenta Analítica -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button name="action_view_analytic_dashboard" type="object"
                        class="oe_stat_button" icon="fa-dashboard"
                        invisible="not analytic_account_id">
                    <div class="o_stat_info">
                        <span class="o_stat_text">Ver Dashboard</span>
                        <span class="o_stat_value">
                            <field name="analytic_account_id" readonly="1" nolabel="1"/>
                        </span>
                    </div>
                </button>
            </xpath>

            <!-- Agregar botón en header -->
            <xpath expr="//header/button[@name='button_confirm']" position="after">
                <button name="action_generar_liquidacion_dte34" string="Generar DTE 34" type="object"
                        class="btn-primary"
                        invisible="not es_liquidacion_honorarios or state != 'purchase'"/>
            </xpath>

            <!-- Agregar estado DTE 34 en header -->
            <xpath expr="//field[@name='state']" position="after">
                <field name="dte_34_status" widget="statusbar"
                       invisible="not es_liquidacion_honorarios"/>
            </xpath>
            
            <!-- ⭐ NUEVO: Agregar campo analytic_account_id en grupo principal -->
            <xpath expr="//field[@name='partner_id']" position="after">
                <field name="analytic_account_id"
                       options="{'no_create': True, 'no_open': True}"
                       placeholder="Seleccionar cuenta analítica para trazabilidad de costos..."/>
            </xpath>

            <!-- Agregar página Liquidación Honorarios -->
            <xpath expr="//notebook" position="inside">
                <page string="Liquidación Honorarios (DTE 34)" name="dte_34_page">
                    <group>
                        <group>
                            <field name="es_liquidacion_honorarios"/>
                        </group>
                    </group>
                    
                    <group string="Datos del Profesional"
                           invisible="not es_liquidacion_honorarios">
                        <group>
                            <field name="profesional_rut" placeholder="12.345.678-9"/>
                            <field name="profesional_nombre"/>
                        </group>
                        <group>
                            <field name="periodo_servicio_inicio"/>
                            <field name="periodo_servicio_fin"/>
                        </group>
                    </group>

                    <group string="Retención IUE"
                           invisible="not es_liquidacion_honorarios">
                        <group>
                            <field name="monto_bruto_honorarios" readonly="1"/>
                            <field name="retencion_iue_porcentaje"/>
                            <field name="monto_retencion_iue" readonly="1"/>
                        </group>
                        <group>
                            <field name="monto_neto_a_pagar" readonly="1" class="oe_subtotal_footer_separator"/>
                            <field name="retencion_iue_id" readonly="1"/>
                        </group>
                    </group>

                    <group string="DTE 34"
                           invisible="not dte_34_folio">
                        <group>
                            <field name="dte_34_folio" readonly="1"/>
                            <field name="dte_34_xml" filename="dte_34_filename" readonly="1"/>
                        </group>
                    </group>
                </page>
            </xpath>
            
        </field>
    </record>
</odoo>
