<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Extensión de Vista Form de Facturas -->
    <record id="view_move_form_dte" model="ir.ui.view">
        <field name="name">account.move.form.dte</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="arch" type="xml">
            
            <!-- Agregar botones en header -->
            <xpath expr="//header/button[@name='action_post']" position="after">
                <!-- ✅ ACTIVADO ETAPA 2: Botón Professional Wizard -->
                <button name="%(action_dte_generate_wizard)d"
                        string="Generar DTE"
                        type="action"
                        class="oe_highlight"
                        invisible="state != 'posted' or not dte_code"/>

                <!-- Botón Envío Síncrono (Legacy) -->
                <button name="action_send_to_sii" string="Enviar a SII" type="object"
                        class="btn-secondary"
                        invisible="dte_status not in ('draft', 'to_send', 'rejected') or state != 'posted'"/>

                <!-- Botón Envío Asíncrono (RabbitMQ) -->
                <button name="action_send_dte_async" string="Enviar DTE (Async)" type="object"
                        class="oe_highlight"
                        icon="fa-paper-plane"
                        invisible="state != 'posted' or not dte_code or dte_async_status in ('queued', 'processing')"/>

                <button name="action_download_dte_xml" string="Descargar XML" type="object"
                        class="btn-secondary"
                        invisible="not dte_xml"/>
            </xpath>
            
            <!-- Agregar campos de estado DTE en header -->
            <xpath expr="//field[@name='state']" position="after">
                <!-- Estado DTE Síncrono -->
                <field name="dte_status" widget="statusbar"
                       statusbar_visible="draft,to_send,sent,accepted"
                       invisible="not dte_code"/>
                
                <!-- Estado DTE Asíncrono (RabbitMQ) -->
                <field name="dte_async_status" widget="statusbar"
                       statusbar_visible="draft,queued,processing,sent,accepted"
                       invisible="dte_async_status == 'draft'"/>
            </xpath>
            
            <!-- Agregar página DTE en notebook -->
            <xpath expr="//notebook" position="inside">
                <page string="DTE" name="dte_page"
                      invisible="not dte_code">
                    <group>
                        <group>
                            <field name="dte_code" readonly="1"/>
                            <field name="dte_folio" readonly="1"/>
                            <field name="dte_timestamp" readonly="1"/>
                        </group>
                        <group>
                            <field name="dte_track_id" readonly="1"/>
                            <button name="action_view_communications" string="Ver Comunicaciones SII"
                                    type="object" class="oe_link"
                                    invisible="not dte_communication_ids"/>
                        </group>
                    </group>
                    
                    <group string="Respuesta SII" invisible="not dte_response_xml">
                        <field name="dte_response_xml" readonly="1"/>
                    </group>

                    <group string="Errores" invisible="not dte_error_message">
                        <field name="dte_error_message" readonly="1" class="text-danger"/>
                    </group>

                    <group string="XML DTE" invisible="not dte_xml">
                        <field name="dte_xml" filename="dte_xml_filename"/>
                        <field name="dte_xml_filename" invisible="1"/>
                    </group>
                </page>
                
                <!-- ⭐ NUEVO: Página DTE Information (Professional) -->
                <page string="DTE Information" name="dte_info_page"
                      invisible="not dte_code">
                    <group>
                        <group string="DTE Status" col="2">
                            <field name="dte_code" readonly="1"/>
                            <field name="dte_folio" readonly="1"/>
                            <field name="dte_track_id" readonly="1"/>
                            <field name="dte_status" readonly="1" invisible="1"/>
                            <field name="dte_timestamp" readonly="1"/>
                            <field name="dte_accepted_date" readonly="1"
                                   invisible="not dte_accepted_date"/>
                            <field name="is_contingency" readonly="1"/>
                        </group>

                        <group string="DTE Configuration" col="2">
                            <field name="dte_certificate_id" readonly="1"/>
                            <field name="dte_caf_id" readonly="1"/>
                            <field name="dte_environment" readonly="1"/>
                        </group>
                    </group>

                    <!-- Error Message (if any) -->
                    <group invisible="not dte_error_message">
                        <div class="alert alert-danger" role="alert">
                            <i class="fa fa-exclamation-triangle" title="Advertencia DTE" aria-label="Advertencia"/>
                            <strong>DTE Error:</strong><br/>
                            <field name="dte_error_message" readonly="1" nolabel="1"/>
                        </div>
                    </group>

                    <!-- QR Code Display -->
                    <group invisible="not dte_qr_image">
                        <label for="dte_qr_image" string="QR Code"/>
                        <field name="dte_qr_image" widget="image" readonly="1" nolabel="1"/>
                    </group>

                    <!-- DTE XML (Technical) -->
                    <group string="Technical Information" groups="base.group_no_one">
                        <field name="dte_xml" readonly="1" widget="ace" options="{'mode': 'xml'}"/>
                        <field name="dte_response_xml" readonly="1" widget="ace" options="{'mode': 'xml'}"/>
                    </group>
                </page>

                <!-- Guía de Despacho (DTE 52) -->
                <page string="Guía de Despacho (DTE 52)" name="dte_52_page"
                      invisible="dte_code != '52'">
                    <group string="Datos del Traslado" col="4">
                        <field name="l10n_cl_dte_tipo_traslado" required="1"/>
                        <field name="l10n_cl_dte_tipo_despacho"/>
                        <field name="l10n_cl_dte_transporte"/>
                    </group>
                    <group string="Transporte" invisible="not l10n_cl_dte_transporte" col="4">
                        <field name="l10n_cl_dte_patente"/>
                        <field name="l10n_cl_dte_rut_transportista"/>
                    </group>
                    <group>
                        <div class="alert alert-info" role="alert">
                            <ul class="mb-0">
                                <li>Tipo de traslado es obligatorio y debe estar entre 1 y 8 (SII).</li>
                                <li>Si marca "Informar transporte", debe indicar Patente y RUT transportista.</li>
                                <li>La dirección de destino se toma desde el cliente (calle/ciudad/comuna).</li>
                            </ul>
                        </div>
                    </group>
                </page>

                <!-- Nueva página: Procesamiento Asíncrono -->
                <page string="Procesamiento Asíncrono" name="dte_async_page"
                      invisible="dte_async_status == 'draft'">
                    <group>
                        <group string="Estado Asíncrono">
                            <field name="dte_async_status" readonly="1" widget="badge"
                                   decoration-info="dte_async_status == 'queued'"
                                   decoration-warning="dte_async_status == 'processing'"
                                   decoration-success="dte_async_status in ['sent', 'accepted']"
                                   decoration-danger="dte_async_status in ['rejected', 'error']"/>
                            <field name="dte_queue_date" readonly="1"/>
                            <field name="dte_processing_date" readonly="1"/>
                            <field name="dte_retry_count" readonly="1"/>
                        </group>
                        <group string="Resultado">
                            <field name="dte_track_id" readonly="1"/>
                            <field name="dte_error_message" readonly="1"
                                   class="text-danger"
                                   invisible="not dte_error_message"/>
                        </group>
                    </group>

                    <group string="Información RabbitMQ">
                        <div class="alert alert-info" role="alert">
                            <p><strong>Procesamiento Asíncrono:</strong></p>
                            <ul>
                                <li>El DTE se procesa en segundo plano vía RabbitMQ</li>
                                <li>Recibirás notificaciones automáticas del progreso</li>
                                <li>Puedes continuar trabajando mientras se procesa</li>
                            </ul>
                        </div>
                    </group>
                </page>
            </xpath>
            
            <!-- Smart Buttons en button_box -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <!-- ⭐ NUEVO: DTE XML Download Smart Button -->
                <button name="action_download_dte_xml"
                        type="object"
                        class="oe_stat_button"
                        icon="fa-file-code-o"
                        invisible="not dte_xml">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_text">DTE XML</span>
                    </div>
                </button>
            </xpath>
            
        </field>
    </record>

    <!-- Filtros de búsqueda para estados async -->
    <record id="view_move_search_dte_async" model="ir.ui.view">
        <field name="name">account.move.search.dte.async</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_account_invoice_filter"/>
        <field name="arch" type="xml">
            <xpath expr="//filter[@name='draft']" position="after">
                <!-- Filtros DTE Async -->
                <separator/>
                <filter string="En Cola RabbitMQ" name="dte_queued" 
                        domain="[('dte_async_status', '=', 'queued')]"/>
                <filter string="Procesando Async" name="dte_processing" 
                        domain="[('dte_async_status', '=', 'processing')]"/>
                <filter string="Enviados Async" name="dte_sent_async" 
                        domain="[('dte_async_status', '=', 'sent')]"/>
                <filter string="Aceptados Async" name="dte_accepted_async" 
                        domain="[('dte_async_status', '=', 'accepted')]"/>
                <filter string="Con Errores Async" name="dte_error_async" 
                        domain="[('dte_async_status', 'in', ['rejected', 'error'])]"/>
            </xpath>
            
            <!-- Agrupar por estado async -->
            <xpath expr="//filter[@name='invoice_date']" position="after">
                <filter string="Estado Async" name="group_async_status" 
                        context="{'group_by': 'dte_async_status'}"/>
            </xpath>
        </field>
    </record>
</odoo>
