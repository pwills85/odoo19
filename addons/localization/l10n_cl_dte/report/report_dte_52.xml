<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!--
    =========================================================================
    DTE 52 Report - Guía de Despacho Electrónica
    =========================================================================

    Professional PDF report template for Chilean DTE 52 (Electronic Dispatch Guide).
    Complies with SII official format requirements for Guía de Despacho.

    Features:
    - Company logo and header
    - DTE 52 specific layout
    - Transport information
    - Product details
    - TED barcode (PDF417)
    - SII compliance footer

    Compliance:
    - Resolución SII 3.419/2000 (Guías de Despacho)
    - Resolución SII 1.514/2003 (Firma digital)

    Created: 2025-11-08 - FASE 1 DTE 52 Implementation
    Author: EERGYGROUP - Ing. Pedro Troncoso Willz
    License: LGPL-3
    =========================================================================
    -->

    <!-- Report Action Definition -->
    <record id="action_report_dte_52" model="ir.actions.report">
        <field name="name">Guía de Despacho Electrónica (DTE 52)</field>
        <field name="model">stock.picking</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">l10n_cl_dte.report_dte_52_document</field>
        <field name="report_file">l10n_cl_dte.report_dte_52_document</field>
        <field name="print_report_name">'DTE_52_%s_%s' % (object.company_id.name, object.dte_52_folio or object.name)</field>
        <field name="binding_model_id" ref="stock.model_stock_picking"/>
        <field name="binding_type">report</field>
    </record>

    <!-- Main Document Template -->
    <template id="report_dte_52_document">
        <t t-call="web.external_layout">
            <t t-set="o" t-value="o.with_context(lang=o.partner_id.lang)"/>

            <div class="page">
                <!-- ===== HEADER SECTION ===== -->
                <div class="row mb-4">
                    <div class="col-6">
                        <!-- Company Logo -->
                        <img t-if="o.company_id.logo"
                             t-att-src="image_data_uri(o.company_id.logo)"
                             style="max-height: 80px; max-width: 200px;"
                             alt="Logo Empresa"/>
                    </div>
                    <div class="col-6 text-end">
                        <!-- DTE 52 Header Box -->
                        <div class="border border-dark p-3 d-inline-block text-center"
                             style="min-width: 250px; background-color: #f8f9fa;">
                            <h4 class="mb-2">
                                <strong>GUÍA DE DESPACHO ELECTRÓNICA</strong>
                            </h4>
                            <p class="mb-1">
                                <strong>DTE N°</strong>
                                <t t-out="o.dte_52_folio or 'Sin Folio'"/>
                            </p>
                            <p class="mb-0 small">
                                <strong>SII - <t t-out="o.company_id.name"/></strong>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- ===== COMPANY INFORMATION ===== -->
                <div class="row mb-3 border-bottom pb-2">
                    <div class="col-6">
                        <h5><strong>EMISOR</strong></h5>
                        <p class="mb-1">
                            <strong><t t-out="o.company_id.name"/></strong>
                        </p>
                        <p class="mb-1" t-if="o.company_id.street">
                            <t t-out="o.company_id.street"/>
                        </p>
                        <p class="mb-1" t-if="o.company_id.city">
                            <t t-out="o.company_id.city"/>
                            <t t-if="o.company_id.state_id">
                                , <t t-out="o.company_id.state_id.name"/>
                            </t>
                        </p>
                        <p class="mb-1" t-if="o.company_id.vat">
                            <strong>RUT:</strong>
                            <t t-out="o.company_id.vat"/>
                        </p>
                        <p class="mb-1" t-if="o.company_id.phone">
                            <strong>Teléfono:</strong>
                            <t t-out="o.company_id.phone"/>
                        </p>
                    </div>

                    <div class="col-6">
                        <h5><strong>DESTINATARIO</strong></h5>
                        <p class="mb-1">
                            <strong><t t-out="o.partner_id.name"/></strong>
                        </p>
                        <p class="mb-1" t-if="o.partner_id.street">
                            <t t-out="o.partner_id.street"/>
                        </p>
                        <p class="mb-1" t-if="o.partner_id.city">
                            <t t-out="o.partner_id.city"/>
                            <t t-if="o.partner_id.state_id">
                                , <t t-out="o.partner_id.state_id.name"/>
                            </t>
                        </p>
                        <p class="mb-1" t-if="o.partner_id.vat">
                            <strong>RUT:</strong>
                            <t t-out="o.partner_id.vat"/>
                        </p>
                        <p class="mb-1" t-if="o.partner_id.phone">
                            <strong>Teléfono:</strong>
                            <t t-out="o.partner_id.phone"/>
                        </p>
                    </div>
                </div>

                <!-- ===== DOCUMENT INFORMATION ===== -->
                <div class="row mb-3">
                    <div class="col-6">
                        <table class="table table-sm table-bordered">
                            <tr>
                                <th style="width: 40%;">Fecha Emisión:</th>
                                <td><t t-out="o.scheduled_date.strftime('%d-%m-%Y') if o.scheduled_date else ''"/></td>
                            </tr>
                            <tr>
                                <th>Tipo de Traslado:</th>
                                <td><t t-out="dict(o._fields['tipo_traslado'].selection).get(o.tipo_traslado, 'N/A')"/></td>
                            </tr>
                            <tr t-if="o.patente_vehiculo">
                                <th>Patente Vehículo:</th>
                                <td><t t-out="o.patente_vehiculo"/></td>
                            </tr>
                            <tr t-if="o.invoice_id">
                                <th>Factura Relacionada:</th>
                                <td><t t-out="o.invoice_id.name"/></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-6">
                        <table class="table table-sm table-bordered">
                            <tr>
                                <th style="width: 40%;">N° Guía Interna:</th>
                                <td><t t-out="o.name"/></td>
                            </tr>
                            <tr t-if="o.origin">
                                <th>Origen:</th>
                                <td><t t-out="o.origin"/></td>
                            </tr>
                            <tr>
                                <th>Estado:</th>
                                <td>
                                    <span class="badge badge-success" t-if="o.state == 'done'">Validado</span>
                                    <span class="badge badge-warning" t-else="">Borrador</span>
                                </td>
                            </tr>
                            <tr>
                                <th>Estado DTE:</th>
                                <td>
                                    <span class="badge badge-success" t-if="o.dte_52_status == 'accepted'">Aceptado SII</span>
                                    <span class="badge badge-warning" t-elif="o.dte_52_status == 'sent'">Enviado SII</span>
                                    <span class="badge badge-info" t-elif="o.dte_52_status == 'to_send'">Por Enviar</span>
                                    <span class="badge badge-secondary" t-else="">Borrador</span>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- ===== PRODUCT DETAILS TABLE ===== -->
                <h5 class="mt-4 mb-3"><strong>DETALLE DE PRODUCTOS</strong></h5>
                <table class="table table-sm table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 5%;" class="text-center">#</th>
                            <th style="width: 15%;">Código</th>
                            <th style="width: 40%;">Descripción</th>
                            <th style="width: 10%;" class="text-center">Cantidad</th>
                            <th style="width: 15%;">Unidad</th>
                            <th style="width: 15%;" class="text-end">Precio Unit.</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-set="line_num" t-value="0"/>
                        <t t-foreach="o.move_ids_without_package" t-as="move">
                            <t t-if="move.quantity_done > 0">
                                <t t-set="line_num" t-value="line_num + 1"/>
                                <tr>
                                    <td class="text-center"><t t-out="line_num"/></td>
                                    <td><t t-out="move.product_id.default_code or 'N/A'"/></td>
                                    <td>
                                        <strong><t t-out="move.product_id.name"/></strong>
                                        <t t-if="move.description_picking">
                                            <br/><small class="text-muted"><t t-out="move.description_picking"/></small>
                                        </t>
                                    </td>
                                    <td class="text-center"><t t-out="'%.2f' % move.quantity_done"/></td>
                                    <td><t t-out="move.product_uom.name"/></td>
                                    <td class="text-end">
                                        <t t-if="move.sale_line_id">
                                            <t t-out="'${:,.0f}'.format(move.sale_line_id.price_unit)"/>
                                        </t>
                                        <t t-else="">
                                            -
                                        </t>
                                    </td>
                                </tr>
                            </t>
                        </t>
                    </tbody>
                </table>

                <!-- ===== TOTALS SECTION (if applicable) ===== -->
                <t t-set="has_prices" t-value="any(move.sale_line_id for move in o.move_ids_without_package)"/>
                <div class="row mt-4" t-if="has_prices">
                    <div class="col-7">
                        <!-- Observations or notes -->
                        <t t-if="o.note">
                            <h6><strong>Observaciones:</strong></h6>
                            <p t-out="o.note"/>
                        </t>
                    </div>
                    <div class="col-5">
                        <table class="table table-sm">
                            <t t-set="total_neto" t-value="0"/>
                            <t t-set="total_iva" t-value="0"/>
                            <t t-foreach="o.move_ids_without_package" t-as="move">
                                <t t-if="move.sale_line_id and move.quantity_done > 0">
                                    <t t-set="line_total" t-value="move.quantity_done * move.sale_line_id.price_unit"/>
                                    <t t-set="total_neto" t-value="total_neto + line_total"/>
                                    <t t-if="move.sale_line_id.tax_id">
                                        <t t-set="total_iva" t-value="total_iva + line_total * 0.19"/>
                                    </t>
                                </t>
                            </t>
                            <tr t-if="total_neto > 0">
                                <th class="text-end">Neto:</th>
                                <td class="text-end"><t t-out="'${:,.0f}'.format(total_neto)"/></td>
                            </tr>
                            <tr t-if="total_iva > 0">
                                <th class="text-end">IVA (19%):</th>
                                <td class="text-end"><t t-out="'${:,.0f}'.format(total_iva)"/></td>
                            </tr>
                            <tr t-if="total_neto > 0" class="border-top">
                                <th class="text-end"><h5>TOTAL:</h5></th>
                                <td class="text-end"><h5><strong><t t-out="'${:,.0f}'.format(total_neto + total_iva)"/></strong></h5></td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- ===== TED BARCODE SECTION ===== -->
                <div class="row mt-5 border-top pt-3" t-if="o.dte_52_pdf417">
                    <div class="col-12 text-center">
                        <h6><strong>TIMBRE ELECTRÓNICO (TED)</strong></h6>
                        <p class="small text-muted">
                            Verifique la autenticidad de este documento en www.sii.cl
                        </p>
                        <!-- PDF417 Barcode would go here -->
                        <!-- In production, use python-barcode library or external service -->
                        <div class="border p-3 d-inline-block" style="min-width: 300px; min-height: 100px; background-color: #f8f9fa;">
                            <p class="mb-0 small font-monospace" t-out="o.dte_52_pdf417[:50] + '...' if o.dte_52_pdf417 else 'No disponible'"/>
                            <p class="mb-0 small text-muted mt-2">[PDF417 Barcode Image]</p>
                        </div>
                    </div>
                </div>

                <!-- ===== FOOTER INFORMATION ===== -->
                <div class="row mt-4">
                    <div class="col-12">
                        <p class="small text-muted text-center">
                            Este documento es una representación impresa de un Documento Tributario Electrónico (DTE).
                            <br/>
                            Para verificar su validez, ingrese a www.sii.cl con el código de barcode PDF417 presente en este documento.
                            <br/>
                            <strong>Folio DTE 52:</strong> <t t-out="o.dte_52_folio or 'Sin asignar'"/> |
                            <strong>Fecha Generación:</strong> <t t-out="o.dte_52_timestamp.strftime('%d-%m-%Y %H:%M') if o.dte_52_timestamp else 'N/A'"/>
                        </p>
                    </div>
                </div>

            </div>
        </t>
    </template>

    <!-- Simplified Report for Multiple Pickings -->
    <template id="report_dte_52">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-call="l10n_cl_dte.report_dte_52_document" t-lang="o.partner_id.lang"/>
            </t>
        </t>
    </template>

</odoo>
