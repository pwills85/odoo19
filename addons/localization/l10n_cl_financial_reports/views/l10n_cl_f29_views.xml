<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ========== VISTA DE FORMULARIO F29 ========== -->
    <record id="view_l10n_cl_f29_form" model="ir.ui.view">
        <field name="name">l10n_cl.f29.form</field>
        <field name="model">l10n_cl.f29</field>
        <field name="arch" type="xml">
            <form string="Formulario 29 - Declaración Mensual IVA">
                <!-- Header con botones de acción y statusbar -->
                <header>
                    <!-- Botones contextuales -->
                    <button name="action_calculate" type="object" string="Calcular desde Contabilidad" 
                            class="btn-primary" 
                            attrs="{'invisible': [('state', 'not in', ('draft', 'review'))]}"/>
                    
                    <button name="action_to_review" type="object" string="Pasar a Revisión" 
                            class="btn-secondary"
                            attrs="{'invisible': [('state', '!=', 'draft')]}"/>
                    
                    <button name="action_validate" type="object" string="Validar F29" 
                            class="btn-success"
                            attrs="{'invisible': [('state', 'not in', ('draft', 'review'))]}"/>
                    
                    <button name="action_send_sii" type="object" string="Enviar al SII" 
                            class="btn-warning"
                            attrs="{'invisible': [('state', '!=', 'validated')]}"/>
                    
                    <button name="action_check_status" type="object" string="Consultar Estado SII" 
                            class="btn-info"
                            attrs="{'invisible': [('state', 'not in', ('sent', 'accepted', 'rejected'))]}"/>
                    
                    <button name="action_replace" type="object" string="Crear Reemplazo" 
                            class="btn-danger"
                            attrs="{'invisible': [('state', 'not in', ('sent', 'accepted', 'rejected'))]}"/>
                    
                    <!-- Barra de estado -->
                    <field name="state" widget="statusbar" 
                           statusbar_visible="draft,review,validated,sent,accepted"/>
                </header>

                <sheet>
                    <!-- Título principal -->
                    <div class="oe_title">
                        <h1>
                            <field name="display_name" placeholder="F29 - Declaración IVA"/>
                        </h1>
                        <h3 class="text-muted">
                            Formulario 29 - Declaración Mensual de IVA
                        </h3>
                    </div>

                    <!-- Smart buttons -->
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_moves" type="object" 
                                class="oe_stat_button" icon="fa-file-text-o">
                            <field name="move_ids" string="Facturas" widget="statinfo"/>
                        </button>
                        
                        <button name="%(account.action_move_journal_line)d" type="action" 
                                class="oe_stat_button" icon="fa-book"
                                context="{'search_default_posted': 1}"
                                attrs="{'invisible': [('provision_move_id', '=', False)]}">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Asiento</span>
                                <span class="o_stat_text">Provisión</span>
                            </div>
                        </button>
                    </div>

                    <!-- Información básica -->
                    <group>
                        <group name="basic_info" string="Información Básica">
                            <field name="company_id" readonly="1"/>
                            <field name="period_date" attrs="{'readonly': [('state', '!=', 'draft')]}"/>
                            <field name="period_string" readonly="1"/>
                            <field name="folio" readonly="1" placeholder="Asignado automáticamente por SII"/>
                        </group>
                        <group name="sii_info" string="Información SII">
                            <field name="sii_track_id" readonly="1" placeholder="Generado al enviar"/>
                            <field name="sii_send_date" readonly="1"/>
                            <field name="currency_id" invisible="1"/>
                        </group>
                    </group>

                    <!-- Contenido principal en pestañas -->
                    <notebook>
                        <!-- Pestaña: Datos Principales -->
                        <page string="Datos IVA" name="iva_data">
                            <!-- Ventas -->
                            <group string="VENTAS DEL PERÍODO">
                                <group>
                                    <field name="ventas_gravadas" widget="monetary"
                                           attrs="{'readonly': [('readonly_state', '=', True)]}"/>
                                    <field name="ventas_exentas" widget="monetary"
                                           attrs="{'readonly': [('readonly_state', '=', True)]}"/>
                                    <field name="ventas_total" widget="monetary" readonly="1" 
                                           class="oe_subtotal_footer"/>
                                </group>
                                <group>
                                    <field name="iva_debito" widget="monetary"
                                           attrs="{'readonly': [('readonly_state', '=', True)]}"/>
                                </group>
                            </group>

                            <!-- Compras -->
                            <group string="COMPRAS DEL PERÍODO">
                                <group>
                                    <field name="compras_gravadas" widget="monetary"
                                           attrs="{'readonly': [('readonly_state', '=', True)]}"/>
                                    <field name="compras_exentas" widget="monetary"
                                           attrs="{'readonly': [('readonly_state', '=', True)]}"/>
                                    <field name="compras_total" widget="monetary" readonly="1" 
                                           class="oe_subtotal_footer"/>
                                </group>
                                <group>
                                    <field name="iva_credito" widget="monetary"
                                           attrs="{'readonly': [('readonly_state', '=', True)]}"/>
                                </group>
                            </group>

                            <!-- Ajustes manuales -->
                            <group string="AJUSTES MANUALES" 
                                   attrs="{'invisible': [('state', 'in', ('draft', 'review'))]}">
                                <group>
                                    <field name="ajuste_debito" widget="monetary"
                                           attrs="{'readonly': [('readonly_partial', '=', True)]}"/>
                                    <field name="ajuste_credito" widget="monetary"
                                           attrs="{'readonly': [('readonly_partial', '=', True)]}"/>
                                </group>
                                <group>
                                    <field name="remanente_anterior" widget="monetary" readonly="1"/>
                                </group>
                            </group>

                            <!-- Observaciones de ajuste -->
                            <group string="OBSERVACIONES DE AJUSTE"
                                   attrs="{'invisible': ['|', ('ajuste_debito', '=', 0), ('ajuste_credito', '=', 0)]}">
                                <field name="observaciones_ajuste" nolabel="1" 
                                       placeholder="Explique los ajustes manuales realizados..."
                                       attrs="{'readonly': [('readonly_partial', '=', True)]}"/>
                            </group>
                        </page>

                        <!-- Pestaña: Cálculos Finales -->
                        <page string="Cálculos" name="calculations">
                            <div class="alert alert-info" role="alert">
                                <strong>Información:</strong> Los cálculos se actualizan automáticamente 
                                cuando modificas los valores base.
                            </div>

                            <!-- Totales con ajustes -->
                            <group string="TOTALES CON AJUSTES">
                                <group>
                                    <field name="total_debito" widget="monetary" readonly="1"/>
                                    <field name="total_credito" widget="monetary" readonly="1"/>
                                </group>
                                <group>
                                    <div class="o_td_label">
                                        <label for="iva_a_pagar" class="fw-bold text-primary"/>
                                    </div>
                                    <field name="iva_a_pagar" widget="monetary" readonly="1" 
                                           class="oe_subtotal_footer fw-bold"/>
                                    
                                    <div class="o_td_label">
                                        <label for="remanente_siguiente" class="fw-bold text-success"/>
                                    </div>
                                    <field name="remanente_siguiente" widget="monetary" readonly="1" 
                                           class="fw-bold"/>
                                </group>
                            </group>

                            <!-- Resumen visual -->
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="card border-primary">
                                        <div class="card-header bg-primary text-white">
                                            <h5 class="mb-0">Resumen IVA</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-6">
                                                    <small class="text-muted">Ventas Gravadas:</small><br/>
                                                    <span class="fw-bold" 
                                                          t-field="ventas_gravadas" 
                                                          t-options='{"widget": "monetary"}'/>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">IVA Débito:</small><br/>
                                                    <span class="fw-bold" 
                                                          t-field="iva_debito" 
                                                          t-options='{"widget": "monetary"}'/>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border-success">
                                        <div class="card-header bg-success text-white">
                                            <h5 class="mb-0">Resultado Final</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="text-center">
                                                <h4 class="fw-bold text-primary" 
                                                    t-field="iva_a_pagar" 
                                                    t-options='{"widget": "monetary"}'/>
                                                <small class="text-muted">IVA a Pagar</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </page>

                        <!-- Pestaña: SII Integration -->
                        <page string="SII" name="sii_integration" 
                              attrs="{'invisible': [('state', 'in', ('draft', 'review'))]}">
                            
                            <div class="alert alert-warning" role="alert"
                                 attrs="{'invisible': [('sii_track_id', '!=', False)]}">
                                <strong>Pendiente:</strong> Este F29 aún no ha sido enviado al SII.
                            </div>

                            <div class="alert alert-success" role="alert"
                                 attrs="{'invisible': [('state', '!=', 'accepted')]}">
                                <strong>Aceptado:</strong> El F29 ha sido aceptado por el SII.
                            </div>

                            <div class="alert alert-danger" role="alert"
                                 attrs="{'invisible': [('state', '!=', 'rejected')]}">
                                <strong>Rechazado:</strong> El F29 ha sido rechazado por el SII. 
                                Revise la respuesta para más detalles.
                            </div>

                            <group string="ESTADO SII">
                                <field name="sii_track_id" readonly="1" 
                                       placeholder="Se genera automáticamente al enviar"/>
                                <field name="sii_send_date" readonly="1"/>
                                <field name="state" widget="badge"
                                       decoration-success="state == 'accepted'"
                                       decoration-warning="state == 'sent'"
                                       decoration-danger="state == 'rejected'"
                                       decoration-info="state == 'validated'"/>
                            </group>

                            <group string="RESPUESTA SII" 
                                   attrs="{'invisible': [('sii_response', '=', False)]}">
                                <field name="sii_response" nolabel="1" readonly="1" 
                                       widget="text" placeholder="La respuesta del SII aparecerá aquí..."/>
                            </group>
                        </page>

                        <!-- Pestaña: Documentos Incluidos -->
                        <page string="Documentos" name="documents">
                            <field name="move_ids" readonly="1">
                                <tree decoration-info="move_type in ('out_invoice', 'out_refund')"
                                      decoration-muted="move_type in ('in_invoice', 'in_refund')">
                                    <field name="name"/>
                                    <field name="move_type" widget="badge"/>
                                    <field name="partner_id"/>
                                    <field name="invoice_date"/>
                                    <field name="amount_untaxed" sum="Total Neto"/>
                                    <field name="amount_tax" sum="Total IVA"/>
                                    <field name="amount_total" sum="Total"/>
                                </tree>
                            </field>
                        </page>
                    </notebook>

                    <!-- Campos invisibles para cálculos -->
                    <group invisible="1">
                        <field name="readonly_state"/>
                        <field name="readonly_partial"/>
                        <field name="provision_move_id"/>
                        <field name="payment_id"/>
                    </group>
                </sheet>

                <!-- Chatter para seguimiento -->
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- ========== VISTA DE LISTA F29 ========== -->
    <record id="view_l10n_cl_f29_tree" model="ir.ui.view">
        <field name="name">l10n_cl.f29.tree</field>
        <field name="model">l10n_cl.f29</field>
        <field name="arch" type="xml">
            <tree string="Formularios F29" 
                  decoration-success="state == 'accepted'"
                  decoration-info="state in ('validated', 'sent')"
                  decoration-muted="state == 'draft'"
                  decoration-warning="state == 'review'"
                  decoration-danger="state == 'rejected'">
                
                <field name="period_string" string="Período"/>
                <field name="company_id" groups="base.group_multi_company"/>
                <field name="ventas_total" sum="Total Ventas" widget="monetary"/>
                <field name="iva_debito" sum="Total IVA Débito" widget="monetary"/>
                <field name="iva_credito" sum="Total IVA Crédito" widget="monetary"/>
                <field name="iva_a_pagar" sum="Total IVA a Pagar" widget="monetary"/>
                <field name="sii_send_date" string="Enviado SII" optional="hide"/>
                <field name="state" widget="badge" 
                       decoration-success="state == 'accepted'"
                       decoration-info="state in ('validated', 'sent')"
                       decoration-warning="state == 'review'"
                       decoration-danger="state == 'rejected'"/>
                <field name="folio" optional="hide"/>
            </tree>
        </field>
    </record>

    <!-- ========== VISTA DE BÚSQUEDA F29 ========== -->
    <record id="view_l10n_cl_f29_search" model="ir.ui.view">
        <field name="name">l10n_cl.f29.search</field>
        <field name="model">l10n_cl.f29</field>
        <field name="arch" type="xml">
            <search string="Buscar F29">
                <field name="period_string" string="Período" 
                       filter_domain="[('period_string', 'ilike', self)]"/>
                <field name="company_id" groups="base.group_multi_company"/>
                <field name="folio"/>
                <field name="sii_track_id"/>
                
                <separator/>
                <filter string="Borradores" name="draft" 
                        domain="[('state', '=', 'draft')]"/>
                <filter string="En Revisión" name="review" 
                        domain="[('state', '=', 'review')]"/>
                <filter string="Validados" name="validated" 
                        domain="[('state', '=', 'validated')]"/>
                <filter string="Enviados SII" name="sent" 
                        domain="[('state', '=', 'sent')]"/>
                <filter string="Aceptados" name="accepted" 
                        domain="[('state', '=', 'accepted')]"/>
                <filter string="Rechazados" name="rejected" 
                        domain="[('state', '=', 'rejected')]"/>
                
                <separator/>
                <filter string="Con IVA a Pagar" name="has_tax" 
                        domain="[('iva_a_pagar', '>', 0)]"/>
                <filter string="Con Remanente" name="has_remanente" 
                        domain="[('remanente_siguiente', '>', 0)]"/>
                
                <separator/>
                <filter string="Año Actual" name="current_year" 
                        domain="[('period_date', '>=', (context_today() - relativedelta(years=1)).strftime('%Y-01-01'))]"/>
                <filter string="Último Trimestre" name="last_quarter" 
                        domain="[('period_date', '>=', (context_today() - relativedelta(months=3)).strftime('%Y-%m-01'))]"/>
                
                <group expand="0" string="Agrupar por">
                    <filter string="Estado" name="group_state" 
                            context="{'group_by': 'state'}"/>
                    <filter string="Período" name="group_period" 
                            context="{'group_by': 'period_string'}"/>
                    <filter string="Compañía" name="group_company" 
                            context="{'group_by': 'company_id'}" groups="base.group_multi_company"/>
                </group>
            </search>
        </field>
    </record>

    <!-- ========== VISTA KANBAN F29 ========== -->
    <record id="view_l10n_cl_f29_kanban" model="ir.ui.view">
        <field name="name">l10n_cl.f29.kanban</field>
        <field name="model">l10n_cl.f29</field>
        <field name="arch" type="xml">
            <kanban default_group_by="state" class="o_kanban_mobile" quick_create="false">
                <field name="id"/>
                <field name="display_name"/>
                <field name="period_string"/>
                <field name="iva_a_pagar"/>
                <field name="state"/>
                <field name="company_id"/>
                <field name="activity_ids"/>
                <field name="activity_state"/>
                
                <progressbar field="activity_state" 
                            colors='{"planned": "success", "today": "warning", "overdue": "danger"}'/>
                
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_card oe_kanban_global_click">
                            <!-- Card header -->
                            <div class="o_kanban_record_top">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title">
                                        <field name="period_string"/>
                                    </strong>
                                    <small class="o_kanban_record_subtitle text-muted">
                                        <field name="company_id"/>
                                    </small>
                                </div>
                                <div class="o_kanban_record_top_right">
                                    <field name="activity_ids" widget="kanban_activity"/>
                                </div>
                            </div>
                            
                            <!-- Card content -->
                            <div class="o_kanban_record_body">
                                <div class="row">
                                    <div class="col-12 text-center">
                                        <span class="fa fa-calculator" title="IVA a Pagar"/> 
                                        <strong><field name="iva_a_pagar" widget="monetary"/></strong>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Card footer -->
                            <div class="o_kanban_record_bottom">
                                <div class="oe_kanban_bottom_right">
                                    <field name="state" widget="label_selection" 
                                           options="{'classes': {
                                               'draft': 'secondary',
                                               'review': 'warning', 
                                               'validated': 'info',
                                               'sent': 'primary',
                                               'accepted': 'success',
                                               'rejected': 'danger'
                                           }}"/>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- ========== ACCIÓN DE VENTANA F29 ========== -->
    <record id="action_l10n_cl_f29" model="ir.actions.act_window">
        <field name="name">Formulario F29</field>
        <field name="res_model">l10n_cl.f29</field>
        <field name="view_mode">tree,form,kanban</field>
        <field name="context">{
            'search_default_current_year': 1
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Crear su primer Formulario F29
            </p>
            <p>
                El Formulario F29 es la declaración mensual de IVA que debe presentarse 
                mensualmente al SII. El sistema calculará automáticamente los valores 
                desde su contabilidad.
            </p>
            <p>
                <strong>Características:</strong>
            </p>
            <ul>
                <li>Cálculo automático desde movimientos contables</li>
                <li>Integración directa con SII</li>
                <li>Seguimiento del estado en tiempo real</li>
                <li>Generación automática de provisiones contables</li>
            </ul>
        </field>
    </record>
</odoo>