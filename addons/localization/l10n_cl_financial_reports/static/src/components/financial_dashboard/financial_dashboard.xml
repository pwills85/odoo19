<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="account_financial_report.FinancialDashboard" owl="1">
        <div class="o_financial_dashboard" t-ref="dashboard_root">
            <!-- Loading state -->
            <div t-if="state.isLoading" class="o_dashboard_loading">
                <div class="d-flex flex-column align-items-center justify-content-center h-100">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h4>Loading Dashboard...</h4>
                </div>
            </div>
            
            <!-- Dashboard content -->
            <div t-else="" class="o_dashboard_content">
                <!-- Control Panel -->
                <div class="o_control_panel">
                    <div class="o_control_panel_main">
                        <div class="o_control_panel_breadcrumbs">
                            <h2>
                                <span t-out="dashboardTitle"/>
                                <span t-if="websocketConnected" 
                                      class="badge bg-success ms-2" 
                                      title="Real-time updates active">
                                    <i class="fa fa-wifi"/> Live
                                </span>
                                <span t-else="" 
                                      class="badge bg-secondary ms-2" 
                                      title="Real-time updates inactive">
                                    <i class="fa fa-refresh"/> Manual
                                </span>
                            </h2>
                        </div>
                        <div class="o_control_panel_actions">
                            <!-- Dashboard actions -->
                            <button class="btn btn-light" 
                                    t-on-click="onSelectTemplate"
                                    title="Load Template">
                                <i class="fa fa-th-large"/>
                            </button>
                            <button class="btn btn-light" 
                                    t-on-click="onSaveAsTemplate"
                                    title="Save as Template">
                                <i class="fa fa-save"/>
                            </button>
                            <button class="btn btn-light" 
                                    t-on-click="onExportDashboard"
                                    title="Export Dashboard">
                                <i class="fa fa-download"/>
                            </button>
                            <button class="btn btn-light" 
                                    t-on-click="onToggleFullscreen"
                                    title="Fullscreen">
                                <i class="fa fa-expand"/>
                            </button>
                            <button class="btn btn-primary" 
                                    t-on-click="onAddWidget">
                                <i class="fa fa-plus me-1"/>
                                Add Widget
                            </button>
                        </div>
                    </div>
                    
                </div>
                
                <!-- Filter Panel -->
                <div class="o_dashboard_filter_container">
                    <FilterPanel 
                        filters="state.filters"
                        onFiltersChanged.bind="onFiltersChanged"
                        expanded="false"/>
                </div>
                
                <!-- Dashboard Grid -->
                <div class="o_dashboard_grid_container">
                    <div t-if="!hasWidgets" class="o_dashboard_empty">
                        <div class="text-center py-5">
                            <i class="fa fa-chart-line fa-5x text-muted mb-3"/>
                            <h3 class="text-muted">No widgets added yet</h3>
                            <p class="text-muted">Click "Add Widget" to start building your dashboard</p>
                            <button class="btn btn-primary mt-3" t-on-click="onAddWidget">
                                <i class="fa fa-plus me-1"/>
                                Add Your First Widget
                            </button>
                        </div>
                    </div>
                    
                    <!-- GridStack container -->
                    <div t-else="" class="grid-stack" t-ref="grid_container">
                        <!-- Widgets are dynamically rendered -->
                        <t t-foreach="state.widgets" t-as="widget" t-key="widget.user_widget_id">
                            <div class="grid-stack-item"
                                 t-att-data-gs-id="widget.user_widget_id"
                                 t-att-data-gs-x="widget.grid_data.x"
                                 t-att-data-gs-y="widget.grid_data.y"
                                 t-att-data-gs-w="widget.grid_data.w"
                                 t-att-data-gs-h="widget.grid_data.h"
                                 t-att-data-gs-min-w="widget.min_width"
                                 t-att-data-gs-min-h="widget.min_height">
                                <div class="grid-stack-item-content">
                                    <div class="widget-header">
                                        <i t-att-class="widget.icon" class="me-1"/>
                                        <span t-out="widget.name"/>
                                    </div>
                                    <div class="widget-body">
                                        <!-- Render appropriate widget component -->
                                        <t t-component="getWidgetComponent(widget.widget_type)"
                                           t-props="{
                                               widgetData: widget.real_time_data ? Object.assign({}, widget, widget.real_time_data) : widget,
                                               config: widget.custom_config || {},
                                               filters: Object.assign({}, state.filters, widget.custom_filters || {}),
                                               size: {
                                                   width: widget.grid_data.w,
                                                   height: widget.grid_data.h
                                               },
                                               websocketService: websocketService
                                           }"/>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </div>
                </div>
            </div>
        </div>
    </t>
</templates>