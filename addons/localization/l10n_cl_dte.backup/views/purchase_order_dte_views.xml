<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Extensión de Vista Form de Purchase Order para DTE 34 -->
    <record id="view_purchase_order_form_dte" model="ir.ui.view">
        <field name="name">purchase.order.form.dte</field>
        <field name="model">purchase.order</field>
        <field name="inherit_id" ref="purchase.purchase_order_form"/>
        <field name="arch" type="xml">
            
            <!-- Agregar botón en header -->
            <xpath expr="//header/button[@name='button_confirm']" position="after">
                <button name="action_generar_liquidacion_dte34" string="Generar DTE 34" type="object" 
                        class="btn-primary" 
                        attrs="{'invisible': ['|', ('es_liquidacion_honorarios', '=', False), ('state', '!=', 'purchase')]}"/>
            </xpath>
            
            <!-- Agregar estado DTE 34 en header -->
            <xpath expr="//field[@name='state']" position="after">
                <field name="dte_34_status" widget="statusbar" 
                       attrs="{'invisible': [('es_liquidacion_honorarios', '=', False)]}"/>
            </xpath>
            
            <!-- Agregar página Liquidación Honorarios -->
            <xpath expr="//notebook" position="inside">
                <page string="Liquidación Honorarios (DTE 34)" name="dte_34_page">
                    <group>
                        <group>
                            <field name="es_liquidacion_honorarios"/>
                        </group>
                    </group>
                    
                    <group string="Datos del Profesional" 
                           attrs="{'invisible': [('es_liquidacion_honorarios', '=', False)]}">
                        <group>
                            <field name="profesional_rut" placeholder="12.345.678-9"/>
                            <field name="profesional_nombre"/>
                        </group>
                        <group>
                            <field name="periodo_servicio_inicio"/>
                            <field name="periodo_servicio_fin"/>
                        </group>
                    </group>
                    
                    <group string="Retención IUE" 
                           attrs="{'invisible': [('es_liquidacion_honorarios', '=', False)]}">
                        <group>
                            <field name="monto_bruto_honorarios" readonly="1"/>
                            <field name="retencion_iue_porcentaje"/>
                            <field name="monto_retencion_iue" readonly="1"/>
                        </group>
                        <group>
                            <field name="monto_neto_a_pagar" readonly="1" class="oe_subtotal_footer_separator"/>
                            <field name="retencion_iue_id" readonly="1"/>
                        </group>
                    </group>
                    
                    <group string="DTE 34" 
                           attrs="{'invisible': [('dte_34_folio', '=', False)]}">
                        <group>
                            <field name="dte_34_folio" readonly="1"/>
                            <field name="dte_34_xml" filename="dte_34_filename" readonly="1"/>
                        </group>
                    </group>
                </page>
            </xpath>
            
        </field>
    </record>
</odoo>
