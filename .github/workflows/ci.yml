name: CI - l10n_cl_dte

on:
  push:
    branches: [ main, develop, feature/*, bugfix/* ]
    paths:
      - 'addons/localization/l10n_cl_dte/**'
      - '.github/workflows/ci.yml'
      - 'docker-compose.yml'
      - 'requirements.txt'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'addons/localization/l10n_cl_dte/**'

env:
  ODOO_VERSION: '19.0'
  PYTHON_VERSION: '3.11'
  POSTGRES_VERSION: '15'

jobs:
  # ==================================================================
  # JOB 1: Code Quality
  # ==================================================================
  code-quality:
    name: ğŸ“Š Code Quality (Linting)
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Install linting tools
        run: |
          pip install flake8 pylint black isort

      - name: ğŸ” Run Flake8
        run: |
          flake8 addons/localization/l10n_cl_dte/ \
            --count --select=E9,F63,F7,F82 \
            --show-source --statistics \
            --max-line-length=120 \
            --exclude=__pycache__,migrations

      - name: ğŸ” Run Pylint (fail under 8.0)
        run: |
          pylint addons/localization/l10n_cl_dte/ \
            --fail-under=8.0 \
            --max-line-length=120 \
            --disable=C0114,C0115,C0116 \
            --ignore=migrations,__pycache__
        continue-on-error: true

  # ==================================================================
  # JOB 2: Security
  # ==================================================================
  security:
    name: ğŸ”’ Security Checks
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install security tools
        run: pip install bandit safety

      - name: ğŸ” Run Bandit
        run: |
          bandit -r addons/localization/l10n_cl_dte/ \
            --exclude=*/tests/*,*/migrations/* \
            --skip=B101
        continue-on-error: true

  # ==================================================================
  # JOB 3: Module Installation
  # ==================================================================
  install-test:
    name: ğŸ—ï¸ Module Installation
    runs-on: ubuntu-latest
    needs: [code-quality]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build and start services
        run: |
          docker-compose up -d db redis
          sleep 10
          docker-compose build odoo

      - name: ğŸ“¦ Install module
        run: |
          docker-compose run --rm odoo \
            odoo -c /etc/odoo/odoo.conf \
            -d ci_test_db \
            -i l10n_cl_dte \
            --stop-after-init \
            --log-level=info

      - name: âœ… Verify installation
        run: |
          docker-compose exec -T db psql -U odoo -d ci_test_db -c \
            "SELECT name, state, latest_version FROM ir_module_module WHERE name='l10n_cl_dte';"

      - name: ğŸ§¹ Cleanup
        run: docker-compose down -v
        if: always()

  # ==================================================================
  # JOB 4: Build Success
  # ==================================================================
  build-success:
    name: âœ… Build Success
    runs-on: ubuntu-latest
    needs: [code-quality, security, install-test]
    if: always()

    steps:
      - name: âœ… Summary
        run: |
          echo "## CI Pipeline Summary"
          echo "Code Quality: ${{ needs.code-quality.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Installation: ${{ needs.install-test.result }}"
