name: PR Quality Gates

on:
  pull_request:
    branches: [ develop, main ]

env:
  PYTHON_VERSION: '3.10'
  MIN_COVERAGE: '85'
  MIN_PYLINT_SCORE: '8.0'

jobs:
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pylint flake8 black mypy bandit
          pip install -r odoo-docker/localization/chile/requirements.txt || true

      - name: ğŸ¨ Code Formatting (Black)
        id: black
        run: |
          black --check addons/localization/l10n_cl_dte/
          echo "status=âœ… Passed" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ğŸ” Linting (Flake8)
        id: flake8
        run: |
          flake8 addons/localization/l10n_cl_dte/ --max-line-length=127 --count --statistics
          echo "status=âœ… Passed" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ğŸ“Š Linting (Pylint)
        id: pylint
        run: |
          SCORE=$(pylint addons/localization/l10n_cl_dte/ --exit-zero | grep "Your code has been rated at" | awk '{print $7}' | cut -d'/' -f1)
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          if (( $(echo "$SCORE >= ${{ env.MIN_PYLINT_SCORE }}" | bc -l) )); then
            echo "status=âœ… Passed ($SCORE/10)" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "status=âŒ Failed ($SCORE/10 < ${{ env.MIN_PYLINT_SCORE }})" >> $GITHUB_OUTPUT
            exit 1
          fi
        continue-on-error: true

      - name: ğŸ”’ Type Checking (MyPy)
        id: mypy
        run: |
          mypy addons/localization/l10n_cl_dte/libs/ --ignore-missing-imports
          echo "status=âœ… Passed" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ğŸ›¡ï¸ Security (Bandit)
        id: bandit
        run: |
          bandit -r addons/localization/l10n_cl_dte/ -ll
          echo "status=âœ… Passed" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ğŸ§ª Unit Tests
        id: tests
        run: |
          pytest addons/localization/l10n_cl_dte/tests/ -v --cov=addons/localization/l10n_cl_dte --cov-report=term --cov-report=xml
          COVERAGE=$(coverage report | grep TOTAL | awk '{print $4}' | sed 's/%//')
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          if (( $(echo "$COVERAGE >= ${{ env.MIN_COVERAGE }}" | bc -l) )); then
            echo "status=âœ… Passed ($COVERAGE%)" >> $GITHUB_OUTPUT
          else
            echo "status=âš ï¸ Warning ($COVERAGE% < ${{ env.MIN_COVERAGE }}%)" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: ğŸ“ Generate PR Comment
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `
            ## ğŸ¯ Quality Gates Report

            | Check | Status |
            |-------|--------|
            | ğŸ¨ Code Formatting | ${{ steps.black.outputs.status || 'â­ï¸ Skipped' }} |
            | ğŸ” Linting (Flake8) | ${{ steps.flake8.outputs.status || 'â­ï¸ Skipped' }} |
            | ğŸ“Š Linting (Pylint) | ${{ steps.pylint.outputs.status || 'â­ï¸ Skipped' }} |
            | ğŸ”’ Type Checking | ${{ steps.mypy.outputs.status || 'â­ï¸ Skipped' }} |
            | ğŸ›¡ï¸ Security Scan | ${{ steps.bandit.outputs.status || 'â­ï¸ Skipped' }} |
            | ğŸ§ª Unit Tests | ${{ steps.tests.outputs.status || 'â­ï¸ Skipped' }} |

            ### ğŸ“Š Metrics
            - **Pylint Score:** ${{ steps.pylint.outputs.score || 'N/A' }}/10 (min: ${{ env.MIN_PYLINT_SCORE }})
            - **Coverage:** ${{ steps.tests.outputs.coverage || 'N/A' }}% (min: ${{ env.MIN_COVERAGE }}%)

            ---

            **Module:** l10n_cl_dte v19.0.4.0.0
            **Sprint:** Sprint 1 - Critical Fixes & Foundation
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  merge-requirements:
    name: Merge Requirements Check
    runs-on: ubuntu-latest
    needs: quality-gates

    steps:
      - name: Check PR requirements
        run: |
          echo "âœ… All quality gates passed"
          echo "âœ… Code review approved (manual check required)"
          echo "âœ… No merge conflicts"
          echo "âœ… All conversations resolved (manual check required)"
          echo ""
          echo "PR is ready for merge! ğŸ‰"
