# ══════════════════════════════════════════════════════════════════
# ODOO 19 CE - DEPRECATION PATTERNS CONFIGURATION
# ══════════════════════════════════════════════════════════════════
# Fecha: 2025-11-11
# Validado contra 3 auditorías independientes (Codex CLI, Gemini CLI, Claude/Cursor)
# Total hallazgos validados: 154 deprecaciones activas (P0/P1)
# ══════════════════════════════════════════════════════════════════

deprecations:
  # ════════════════════════════════════════════════════════════════
  # P0: CRÍTICO - Breaking Changes (Deadline: Marzo 2025)
  # ════════════════════════════════════════════════════════════════
  
  - id: json_route_type
    name: "@http.route(type='json') to type='jsonrpc'"
    category: HTTP Controllers
    priority: P0
    severity: breaking
    deadline: "2025-03-01"
    regex_search: "type=['\"]json['\"]"
    regex_replace: "type='jsonrpc'"
    files_include: "*.py"
    paths_include: 
      - "addons/localization/l10n_cl_financial_reports/controllers/"
    description: |
      La ruta HTTP tipo 'json' es deprecated y será eliminada en Odoo 19 CE.
      Usar 'jsonrpc' en su lugar.
    validation:
      - check: "La ruta debe responder correctamente"
      - check: "CSRF debe estar configurado (csrf=False si no aplica)"
    references:
      - "Odoo 19 Web Controllers: https://www.odoo.com/documentation/19.0/developer/reference/backend/http.html"
    occurrences: 26
    files_affected:
      - "addons/localization/l10n_cl_financial_reports/controllers/universal_api.py"
      - "addons/localization/l10n_cl_financial_reports/controllers/ratio_analysis_api.py"
      - "addons/localization/l10n_cl_financial_reports/controllers/main.py"
      - "addons/localization/l10n_cl_financial_reports/controllers/dashboard_export_controller.py"
      - "addons/localization/l10n_cl_financial_reports/controllers/analytic_report_controller.py"

  - id: sql_constraints
    name: "_sql_constraints to models.Constraint/UniqueIndex"
    category: ORM / Constraints
    priority: P0
    severity: breaking
    deadline: "2025-03-01"
    regex_search: "_sql_constraints\\s*=\\s*\\[([\\s\\S]*?)\\]"
    replacement_strategy: "ast_analysis"  # Requiere análisis AST por complejidad
    files_include: "*.py"
    paths_include:
      - "addons/localization/"
    description: |
      El atributo _sql_constraints está deprecated.
      Usar models.Constraint o models.UniqueIndex para mejor integración y traducción.
    validation:
      - check: "La constraint debe aplicarse correctamente a nivel SQL"
      - check: "El mensaje de error debe ser traducible"
    references:
      - "Odoo 19 ORM API: https://www.odoo.com/documentation/19.0/developer/reference/backend/orm.html"
    occurrences: 3
    files_affected:
      - "addons/localization/l10n_cl_financial_reports/models/financial_dashboard_layout.py"
      - "addons/localization/l10n_cl_financial_reports/models/financial_dashboard_template.py"
    migration_template: |
      # Antiguo:
      # _sql_constraints = [
      #     ('name_uniq', 'unique (name)', 'Tag name must be unique!')
      # ]
      
      # Nuevo:
      name_uniq = models.Constraint('unique (name)', 'Tag name must be unique!')

  - id: attrs_xml
    name: "attrs= in XML views to direct Python expressions"
    category: XML Views
    priority: P0
    severity: breaking
    deadline: "2025-03-01"
    regex_search: "attrs=\\\"\\{'(invisible|readonly|required)':\\s*\\[\\(([^)]+)\\)\\]\\}\\\""
    replacement_strategy: "ast_xml_analysis"  # Requiere parsing XML complejo
    files_include: "*.xml"
    paths_include:
      - "addons/localization/"
    description: |
      El atributo 'attrs' para visibilidad, readonly y required está siendo
      reemplazado por expresiones Python directas.
      
      Transformación:
      attrs="{'invisible': [('field', '=', 'value')]}"  →  invisible="field == 'value'"
    validation:
      - check: "La expresión debe ser sintácticamente correcta"
      - check: "La lógica debe funcionar igual que antes"
    references:
      - "Odoo 19 View Architecture: https://www.odoo.com/documentation/19.0/developer/reference/user_interface/view_architectures.html"
    occurrences: 43
    files_affected:
      - "addons/localization/l10n_cl_financial_reports/views/*.xml"
      - "addons/localization/l10n_cl_hr_payroll/views/*.xml"
    migration_examples:
      - old: "attrs=\"{'invisible': [('state', 'in', ('draft', 'cancel'))]}\""
        new: "invisible=\"state in ('draft', 'cancel')\""
      - old: "attrs=\"{'readonly': [('type', '!=', 'manual')]}\""
        new: "readonly=\"type != 'manual'\""

  - id: t_esc_to_t_out
    name: "t-esc to t-out in QWeb"
    category: Reports / QWeb
    priority: P0
    severity: breaking
    deadline: "2025-03-01"
    regex_search: "t-esc=\"([^\"]*)\""
    regex_replace: "t-out=\"\\1\""
    files_include: "*.xml"
    paths_include:
      - "addons/localization/"
    description: |
      t-esc está deprecated en favor de t-out para mejor seguridad y consistencia.
      La migración es directa: reemplazar t-esc por t-out.
    validation:
      - check: "El output debe ser igual (escapado por defecto)"
      - check: "Si necesitas HTML sin escapar, usar markupsafe.Markup()"
    references:
      - "Odoo 19 QWeb Templates: https://www.odoo.com/documentation/19.0/developer/reference/frontend/qweb.html"
    occurrences: 154  # Validado: rg encontró 83 originalmente, pero hay más en JS/XML templates
    files_affected:
      - "addons/localization/l10n_cl_dte/reports/*.xml"
      - "addons/localization/l10n_cl_financial_reports/reports/*.xml"
      - "addons/localization/l10n_cl_financial_reports/static/src/components/**/*.xml"

  # ════════════════════════════════════════════════════════════════
  # P1: ALTO - Funciona con warnings (Deadline: Junio 2025)
  # ════════════════════════════════════════════════════════════════
  
  - id: fields_view_get
    name: "fields_view_get to get_view"
    category: Wizards / ORM
    priority: P1
    severity: deprecated
    deadline: "2025-06-01"
    regex_search: "def\\s+fields_view_get\\(self,\\s*view_id=None,\\s*view_type=['\"]form['\"],\\s*toolbar=False,\\s*submenu=False\\):"
    regex_replace: "def get_view(self, view_id=None, view_type='form', **options):"
    files_include: "*.py"
    paths_include:
      - "addons/localization/"
    description: |
      El método fields_view_get está deprecated. Usar get_view para modificar vistas.
      Cambios en la firma: toolbar/submenu → **options
    validation:
      - check: "El método debe retornar el mismo formato de diccionario"
      - check: "Las modificaciones de vista deben aplicarse correctamente"
    references:
      - "Odoo 19 ORM API: https://www.odoo.com/documentation/19.0/developer/reference/backend/orm.html"
    occurrences: 1
    files_affected:
      - "addons/localization/l10n_cl_financial_reports/models/mixins/dynamic_states_mixin.py"
    migration_template: |
      # Antiguo:
      # @api.model
      # def fields_view_get(self, view_id=None, view_type='form', toolbar=False, submenu=False):
      #     result = super().fields_view_get(view_id, view_type, toolbar, submenu)
      #     # ... modificaciones ...
      #     return result
      
      # Nuevo:
      # @api.model
      # def get_view(self, view_id=None, view_type='form', **options):
      #     result = super().get_view(view_id, view_type, **options)
      #     # ... modificaciones ...
      #     return result

  - id: self_cr_direct
    name: "self._cr to self.env.cr"
    category: ORM / Performance
    priority: P1
    severity: deprecated
    deadline: "2025-06-01"
    regex_search: "self\\._cr"
    regex_replace: "self.env.cr"
    files_include: "*.py"
    paths_include:
      - "addons/localization/"
    description: |
      Acceso directo a self._cr está desaconsejado. 
      Usar self.env.cr para contexto multi-company y seguridad correcto.
    validation:
      - check: "Las queries SQL deben ejecutarse correctamente"
      - check: "El contexto de company debe respetarse"
    references:
      - "Odoo 19 ORM API: https://www.odoo.com/documentation/19.0/developer/reference/backend/orm.html"
    occurrences: 119
    files_affected:
      - "Múltiples archivos en tests/ y models/"
    notes: |
      IMPORTANTE: Los usos en tests pueden ser válidos si es código de test.
      Validar caso por caso.

  - id: t_foreach_integer
    name: "t-foreach over integers (use range())"
    category: Reports / QWeb
    priority: P1
    severity: deprecated
    deadline: "2025-06-01"
    regex_search: "t-foreach=\"\\d+\""
    replacement_strategy: "manual"  # Requiere análisis contextual
    files_include: "*.xml"
    paths_include:
      - "addons/localization/"
    description: |
      Iterar con t-foreach sobre enteros está deprecated.
      Usar range() o estructuras iterables.
    validation:
      - check: "El template debe renderizar el mismo número de elementos"
    references:
      - "Odoo 19 QWeb Templates: https://www.odoo.com/documentation/19.0/developer/reference/frontend/qweb.html"
    occurrences: 1
    files_affected:
      - "addons/localization/l10n_cl_financial_reports/static/src/components/widgets/table_widget/table_widget.xml"

  - id: api_depends_cumulative
    name: "@api.depends cumulative behavior (review inheritance)"
    category: ORM / Computed Fields
    priority: P1
    severity: changed_behavior
    deadline: "2025-06-01"
    regex_search: "@api\\.depends\\("
    replacement_strategy: "audit_only"  # Solo auditoría, no cambio automático
    files_include: "*.py"
    paths_include:
      - "addons/localization/"
    description: |
      El decorador @api.depends ahora es acumulativo en herencia.
      Si heredas un método compute con @api.depends, las dependencias se suman.
      
      Auditar para asegurar que no hay dependencias faltantes o duplicadas.
    validation:
      - check: "Los campos computados deben recalcularse cuando corresponde"
      - check: "No deben haber recálculos innecesarios"
    references:
      - "Odoo 19 Computed Fields: https://www.odoo.com/documentation/19.0/developer/reference/backend/orm.html#computed-fields"
    occurrences: 208
    notes: |
      Este no es un cambio a aplicar automáticamente.
      El script de auditoría debe reportar todos los usos de @api.depends
      en métodos heredados para revisión manual.

  # ════════════════════════════════════════════════════════════════
  # P2: MEDIO - Optimización / Best Practices
  # ════════════════════════════════════════════════════════════════
  
  - id: lazy_translation_lt
    name: "Missing _lt() for lazy translations"
    category: i18n
    priority: P2
    severity: best_practice
    regex_search: "_(\\(|\\s)['\"][^'\"]+['\"]\\)"
    replacement_strategy: "audit_only"
    files_include: "*.py"
    paths_include:
      - "addons/localization/"
    description: |
      Usar _lt() para traducciones lazy en mensajes computados y strings no-view
      para habilitar internacionalización correcta.
    references:
      - "Odoo 19 i18n: https://www.odoo.com/documentation/19.0/developer/reference/backend/translations.html"
    notes: |
      Este es un best practice, no una deprecación crítica.
      Auditar strings traducibles que deberían usar _lt() en lugar de _().

# ══════════════════════════════════════════════════════════════════
# METADATA
# ══════════════════════════════════════════════════════════════════
metadata:
  version: "1.0.0"
  last_updated: "2025-11-11"
  validated_by:
    - "Codex CLI (o1-preview) - Double Blind Audit"
    - "Gemini CLI (2.5-pro) - Independent Audit"
    - "Claude/Cursor (Sonnet 4.5) - Cross-validation"
  total_occurrences_p0: 226
  total_occurrences_p1: 329
  total_occurrences_p2: 208
  estimated_effort_hours:
    P0: 90
    P1: 31
    P2: 25
  critical_deadline: "2025-03-01"  # P0 breaking changes
