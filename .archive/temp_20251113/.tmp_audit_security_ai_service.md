# Auditoría Security - AI Service Microservice

**ROL:** Agente Auditor Seguridad OWASP Expert

**OBJETIVO:** Auditar seguridad del microservicio ai-service contra OWASP Top 10, secrets management, input validation

**MÓDULO EN ALCANCE:**
- `/Users/pedro/Documents/odoo19/ai-service/`
- 20+ endpoints REST expuestos
- Integración con Anthropic API, Redis, Odoo

**CONTEXTO CRÍTICO:**
- Microservicio público con API key authentication
- Maneja datos sensibles: RUT, sueldos, DTEs
- Integración con servicios externos (Anthropic, Redis, Slack, Previred)

**CRITERIOS DE AUDITORÍA (OWASP Top 10 2021):**

## A01:2021 - Broken Access Control
- ✅ API key authentication implementado (`verify_api_key`)
- ✅ HTTPBearer security scheme
- ⚠️ Verificar que `/metrics` NO expone datos sensibles (permite scraping sin auth)
- ⚠️ Validar que todos los endpoints requieren auth (excepto health checks públicos)
- ⚠️ Verificar que NO hay bypass de auth vía headers alternativos

## A02:2021 - Cryptographic Failures
- ✅ **BUENO:** Timing-attack resistant comparison (`secrets.compare_digest`) en API key validation (main.py:142)
- ⚠️ Verificar que secrets NO están hardcoded (API keys, passwords)
- ⚠️ Validar que datos sensibles NO se loguean (RUT, nombres, sueldos, API keys)
- ⚠️ Verificar uso de HTTPS en producción (comunicación encriptada)

## A03:2021 - Injection
- ✅ **BUENO:** Validación XSS en chat messages (main.py:1542-1545)
- ✅ **BUENO:** Validación SQL injection patterns (main.py:1563-1567)
- ⚠️ Verificar que NO hay inyección SQL (ORM usage correctvalida)
- ⚠️ Validar sanitización de inputs en TODOS los endpoints
- ⚠️ Verificar que NO hay command injection (subprocess, os.system)

## A04:2021 - Insecure Design
- ✅ Rate limiting implementado (SlowAPI: 20-30 req/min por endpoint)
- ✅ User identifier combines API key + IP (previene bypass)
- ⚠️ Verificar circuit breaker para APIs externas (Anthropic, Redis)
- ⚠️ Validar timeouts configurados (prevenir DoS)

## A05:2021 - Security Misconfiguration
- ✅ Debug mode por defecto: False
- ✅ Swagger UI (/docs) solo en debug mode
- ⚠️ Verificar que CORS origins están limitados (no `"*"`)
- ⚠️ Validar que error stack traces NO se exponen en producción
- ⚠️ Verificar headers de seguridad (CSP, X-Frame-Options, etc.)

## A06:2021 - Vulnerable and Outdated Components
- ✅ **BUENO:** lxml >= 5.3.0 (CVE-2024-45590 fixed)
- ✅ **BUENO:** httpx pinned < 0.28.0 (compatibility)
- ✅ requests >= 2.32.3 (CVE-2023-32681 fixed)
- ⚠️ Verificar que todas las deps tienen versiones sin CVEs conocidos
- ⚠️ Validar que deps obsoletas fueron removidas (sentence-transformers, ollama)

## A07:2021 - Identification and Authentication Failures
- ✅ API key authentication
- ⚠️ Verificar que NO hay brute force protection en API key (rate limiting ayuda)
- ⚠️ Validar que session tokens (chat) tienen TTL razonable (3600s)
- ⚠️ Verificar que session IDs son UUID v4 (criptográficamente seguros)

## A08:2021 - Software and Data Integrity Failures
- ⚠️ Verificar que responses de APIs externas se validan (Anthropic, Previred)
- ⚠️ Validar que cache corruption NO compromete seguridad
- ⚠️ Verificar integridad de plugins cargados dinámicamente

## A09:2021 - Security Logging and Monitoring Failures
- ✅ Structlog para logging estructurado
- ✅ Prometheus metrics endpoint
- ⚠️ **CRÍTICO:** Verificar que PII NO se loguea (main.py warnings: RUT, sueldos)
- ⚠️ Validar que eventos de seguridad se loguean (invalid API key, rate limit exceeded)
- ⚠️ Verificar que logs tienen timestamp + context suficiente

## A10:2021 - Server-Side Request Forgery (SSRF)
- ⚠️ Verificar que URLs externas se validan (Previred PDF downloads)
- ⚠️ Validar que NO hay fetching de URLs user-controlled sin whitelist
- ⚠️ Verificar que integraciones externas tienen timeouts

## INPUT VALIDATION (Complemento Pydantic)
- ✅ **EXCELENTE:** P0-4 validators para RUT, montos, fechas (main.py:165-323)
- ✅ Validación DV de RUT chileno (módulo 11)
- ✅ Validación tipos DTE válidos según SII
- ⚠️ Verificar que TODOS los endpoints tienen Pydantic validators
- ⚠️ Validar que límites de tamaño están configurados (max_items, max_length)

**COMANDOS ÚTILES:**

```bash
cd /Users/pedro/Documents/odoo19/ai-service

# Buscar secrets hardcoded
grep -rn "sk-ant-\|password\|secret\|token" --include="*.py" --color=always | grep -v "\.env\|settings\|# Example"

# Buscar logging de PII
grep -rn "logger.*rut\|logger.*nombre\|logger.*sueldo" --include="*.py" -i --color=always

# Buscar command injection vectors
grep -rn "os\.system\|subprocess\|eval\|exec" --include="*.py" --color=always

# Buscar SQL raw queries
grep -rn "self\.env\.cr\.execute\|self\._cr\.execute" --include="*.py" --color=always
```

**ENTREGABLE:**

Generar `AUDIT_SECURITY_AI_SERVICE_2025-11-13.md` con:

1. **Resumen Ejecutivo** (3-5 vulnerabilidades críticas)

2. **Score Security:** [X]/100
   - OWASP Top 10 Compliance: [X]/40
   - Input Validation: [X]/20
   - Secrets Management: [X]/20
   - Logging Security: [X]/20

3. **Matriz de Hallazgos:**

| ID | Archivo:Línea | OWASP Category | Descripción | Criticidad | Recomendación |
|----|--------------|----------------|-------------|-----------|---------------|
| S1 | main.py:N | A01 - Access Control | ... | P0/P1/P2/P3 | ... |

4. **Métricas:**
   - Endpoints sin auth: [N]
   - Secrets hardcoded: [N]
   - PII logged: [N]
   - Vulnerable dependencies: [N]

**OUTPUT FORMAT (OBLIGATORIO):**

```markdown
**Score:** [N]/100

**Fecha:** 2025-11-13
**Auditor:** Copilot CLI (GPT-4o)
**Módulo:** ai-service
**Dimensión:** Security (OWASP Top 10)

## Hallazgos

[P0] Critical security issue (file.py:123)
[P1] High priority security risk (file.py:456)
[P2] Medium priority security concern (file.py:789)
```

**RESTRICCIONES:**
- Modo solo lectura
- Basar análisis en código real
- Priorizar vulnerabilidades P0/P1
- Incluir OWASP category para cada hallazgo
