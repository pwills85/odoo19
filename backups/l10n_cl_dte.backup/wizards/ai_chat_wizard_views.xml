<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- AI Chat Wizard Form View -->
    <record id="view_ai_chat_wizard_form" model="ir.ui.view">
        <field name="name">ai.chat.wizard.form</field>
        <field name="model">ai.chat.wizard</field>
        <field name="arch" type="xml">
            <form string="Asistente IA - Facturaci√≥n Electr√≥nica">
                <sheet>
                    <div class="oe_title">
                        <h1>
                            <span>ü§ñ Asistente IA - Soporte DTE</span>
                        </h1>
                        <p class="text-muted">
                            Asistente especializado en Facturaci√≥n Electr√≥nica Chilena
                        </p>
                    </div>

                    <group>
                        <group name="session_info" string="Informaci√≥n de Sesi√≥n">
                            <field name="session_id" readonly="1"/>
                            <field name="message_count" readonly="1"/>
                            <field name="llm_used" readonly="1"
                                   string="LLM"
                                   attrs="{'invisible': [('llm_used', '=', False)]}"/>
                        </group>
                        <group name="context_info" string="Contexto"
                               attrs="{'invisible': [('context_model', '=', False)]}">
                            <field name="context_model" readonly="1" invisible="1"/>
                            <field name="context_res_id" readonly="1" invisible="1"/>
                            <label for="context_model" string="Contexto DTE"/>
                            <div>
                                <span attrs="{'invisible': [('context_model', '!=', 'account.move')]}">
                                    üìÑ Factura/Nota de Cr√©dito/D√©bito
                                </span>
                                <span attrs="{'invisible': [('context_model', '!=', 'purchase.order')]}">
                                    üìã Liquidaci√≥n de Honorarios
                                </span>
                                <span attrs="{'invisible': [('context_model', '!=', 'stock.picking')]}">
                                    üì¶ Gu√≠a de Despacho
                                </span>
                            </div>
                        </group>
                    </group>

                    <notebook>
                        <page name="conversation" string="Conversaci√≥n">
                            <!-- Conversation Display -->
                            <group>
                                <field name="conversation_html"
                                       nolabel="1"
                                       readonly="1"
                                       widget="html"/>
                            </group>

                            <!-- Message Input -->
                            <group>
                                <field name="user_message"
                                       nolabel="1"
                                       placeholder="Escribe tu pregunta aqu√≠... (ej: ¬øC√≥mo genero un DTE 33? ¬øQu√© hago si el SII est√° ca√≠do?)"
                                       widget="text"
                                       options="{'rows': 3}"/>
                            </group>

                            <!-- Action Buttons -->
                            <footer>
                                <button name="action_send_message"
                                        string="üì§ Enviar Mensaje"
                                        type="object"
                                        class="btn-primary"
                                        attrs="{'invisible': [('user_message', '=', False)]}"/>
                                <button name="action_clear_session"
                                        string="üîÑ Nueva Conversaci√≥n"
                                        type="object"
                                        class="btn-secondary"
                                        confirm="¬øDesea iniciar una nueva conversaci√≥n? Se perder√° el historial actual."/>
                                <button name="action_close"
                                        string="Cerrar"
                                        type="object"
                                        class="btn-secondary"/>
                            </footer>
                        </page>

                        <page name="info" string="Informaci√≥n">
                            <group>
                                <group name="welcome" string="Mensaje de Bienvenida">
                                    <field name="welcome_message"
                                           nolabel="1"
                                           readonly="1"
                                           widget="text"/>
                                </group>

                                <group name="sources" string="Fuentes Consultadas"
                                       attrs="{'invisible': [('sources', '=', False)]}">
                                    <field name="sources"
                                           nolabel="1"
                                           readonly="1"
                                           widget="text"/>
                                </group>
                            </group>

                            <group>
                                <group name="help" string="üí° Ejemplos de Preguntas">
                                    <div class="text-muted" style="padding: 10px;">
                                        <p><strong>Generaci√≥n de DTEs:</strong></p>
                                        <ul>
                                            <li>¬øC√≥mo genero una factura electr√≥nica (DTE 33)?</li>
                                            <li>¬øQu√© pasos sigo para crear una nota de cr√©dito?</li>
                                            <li>¬øC√≥mo genero una gu√≠a de despacho?</li>
                                        </ul>

                                        <p><strong>Gesti√≥n de Folios y Certificados:</strong></p>
                                        <ul>
                                            <li>¬øC√≥mo solicito un CAF al SII?</li>
                                            <li>¬øD√≥nde configuro mi certificado digital?</li>
                                            <li>¬øQu√© hago si se me acaban los folios?</li>
                                        </ul>

                                        <p><strong>Operaci√≥n en Contingencia:</strong></p>
                                        <ul>
                                            <li>¬øQu√© es el modo contingencia?</li>
                                            <li>¬øC√≥mo opero si el SII est√° ca√≠do?</li>
                                            <li>¬øC√≥mo env√≠o DTEs de contingencia despu√©s?</li>
                                        </ul>

                                        <p><strong>Resoluci√≥n de Errores:</strong></p>
                                        <ul>
                                            <li>¬øQu√© significa el error "Firma inv√°lida"?</li>
                                            <li>¬øPor qu√© mi DTE fue rechazado?</li>
                                            <li>¬øC√≥mo consulto el estado de un DTE en el SII?</li>
                                        </ul>
                                    </div>
                                </group>

                                <group name="about" string="‚ÑπÔ∏è Acerca del Asistente">
                                    <div class="text-muted" style="padding: 10px;">
                                        <p><strong>Especializaci√≥n:</strong></p>
                                        <ul>
                                            <li>‚úÖ Facturaci√≥n Electr√≥nica Chilena (DTE)</li>
                                            <li>‚úÖ Normativa SII (Servicio de Impuestos Internos)</li>
                                            <li>‚úÖ Odoo 19 Community Edition</li>
                                            <li>‚úÖ 5 Tipos de DTEs (33, 34, 52, 56, 61)</li>
                                        </ul>

                                        <p><strong>Capacidades:</strong></p>
                                        <ul>
                                            <li>üîç B√∫squeda en base de conocimiento especializada</li>
                                            <li>üí¨ Conversaciones con contexto (m√∫ltiples turnos)</li>
                                            <li>ü§ñ Powered by Anthropic Claude 3.5 Sonnet</li>
                                            <li>üîÑ Fallback autom√°tico a OpenAI GPT-4</li>
                                        </ul>

                                        <p><strong>Limitaciones:</strong></p>
                                        <ul>
                                            <li>‚ö†Ô∏è Solo responde sobre facturaci√≥n electr√≥nica chilena</li>
                                            <li>‚ö†Ô∏è No puede ejecutar acciones directamente en Odoo</li>
                                            <li>‚ö†Ô∏è Sesi√≥n expira despu√©s de 1 hora de inactividad</li>
                                        </ul>
                                    </div>
                                </group>
                            </group>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- AI Chat Wizard Action -->
    <record id="action_ai_chat_wizard" model="ir.actions.act_window">
        <field name="name">Asistente IA DTE</field>
        <field name="res_model">ai.chat.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="context">{}</field>
    </record>

    <!-- Menu Item (under DTE menu) -->
    <menuitem id="menu_ai_chat_wizard"
              name="ü§ñ Asistente IA"
              parent="menu_l10n_cl_dte_root"
              action="action_ai_chat_wizard"
              sequence="5"/>

    <!-- Add AI Chat button to Invoice form view -->
    <!-- This extends the account.move form to add an AI Chat button in the header -->
    <record id="view_account_move_form_ai_chat" model="ir.ui.view">
        <field name="name">account.move.form.ai.chat</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="arch" type="xml">
            <xpath expr="//header" position="inside">
                <button name="%(action_ai_chat_wizard)d"
                        string="ü§ñ Ayuda IA"
                        type="action"
                        class="btn-secondary"
                        context="{'default_context_model': 'account.move', 'default_context_res_id': active_id}"
                        attrs="{'invisible': [('move_type', 'not in', ['out_invoice', 'out_refund', 'in_invoice', 'in_refund'])]}"/>
            </xpath>
        </field>
    </record>

</odoo>
