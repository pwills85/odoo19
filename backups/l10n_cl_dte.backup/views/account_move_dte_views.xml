<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Extensión de Vista Form de Facturas -->
    <record id="view_move_form_dte" model="ir.ui.view">
        <field name="name">account.move.form.dte</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="arch" type="xml">
            
            <!-- Agregar botones en header -->
            <xpath expr="//header/button[@name='action_post']" position="after">
                <!-- ⭐ NUEVO: Botón Professional Wizard -->
                <button name="%(l10n_cl_dte.action_dte_generate_wizard)d"
                        string="Generate DTE"
                        type="action"
                        class="btn-primary"
                        attrs="{'invisible': ['|', ('state', '!=', 'posted'),
                                              '|', ('dte_type', '=', False),
                                              ('dte_status', 'in', ['sent', 'accepted'])]}"/>

                <!-- Botón Envío Síncrono (Legacy) -->
                <button name="action_send_to_sii" string="Enviar a SII" type="object"
                        class="btn-secondary"
                        attrs="{'invisible': ['|', ('dte_status', 'not in', ['draft', 'to_send', 'rejected']), ('state', '!=', 'posted')]}"/>

                <!-- Botón Envío Asíncrono (RabbitMQ) -->
                <button name="action_send_dte_async" string="Enviar DTE (Async)" type="object"
                        class="oe_highlight"
                        icon="fa-paper-plane"
                        attrs="{'invisible': ['|', '|',
                                ('state', '!=', 'posted'),
                                ('dte_code', '=', False),
                                ('dte_async_status', 'in', ['queued', 'processing'])]}"/>

                <!-- ⭐ NUEVO: Query Status Button -->
                <button name="action_query_dte_status"
                        string="Query DTE Status"
                        type="object"
                        class="btn-secondary"
                        attrs="{'invisible': ['|', ('dte_track_id', '=', False),
                                              ('dte_status', 'in', ['accepted', 'rejected'])]}"/>

                <button name="action_download_dte_xml" string="Descargar XML" type="object"
                        class="btn-secondary"
                        attrs="{'invisible': [('dte_xml', '=', False)]}"/>
            </xpath>
            
            <!-- Agregar campos de estado DTE en header -->
            <xpath expr="//field[@name='state']" position="after">
                <!-- Estado DTE Síncrono -->
                <field name="dte_status" widget="statusbar" 
                       statusbar_visible="draft,to_send,sent,accepted"
                       attrs="{'invisible': [('dte_code', '=', False)]}"/>
                
                <!-- Estado DTE Asíncrono (RabbitMQ) -->
                <field name="dte_async_status" widget="statusbar"
                       statusbar_visible="draft,queued,processing,sent,accepted"
                       attrs="{'invisible': [('dte_async_status', '=', 'draft')]}"/>
            </xpath>
            
            <!-- Agregar página DTE en notebook -->
            <xpath expr="//notebook" position="inside">
                <page string="DTE" name="dte_page" 
                      attrs="{'invisible': [('dte_code', '=', False)]}">
                    <group>
                        <group>
                            <field name="dte_code" readonly="1"/>
                            <field name="dte_folio" readonly="1"/>
                            <field name="dte_timestamp" readonly="1"/>
                        </group>
                        <group>
                            <field name="dte_track_id" readonly="1"/>
                            <button name="action_view_communications" string="Ver Comunicaciones SII" 
                                    type="object" class="oe_link" 
                                    attrs="{'invisible': [('dte_communication_ids', '=', [])]}"/>
                        </group>
                    </group>
                    
                    <group string="Respuesta SII" attrs="{'invisible': [('dte_response_xml', '=', False)]}">
                        <field name="dte_response_xml" readonly="1"/>
                    </group>
                    
                    <group string="Errores" attrs="{'invisible': [('dte_error_message', '=', False)]}">
                        <field name="dte_error_message" readonly="1" class="text-danger"/>
                    </group>
                    
                    <group string="XML DTE" attrs="{'invisible': [('dte_xml', '=', False)]}">
                        <field name="dte_xml" filename="dte_xml_filename"/>
                        <field name="dte_xml_filename" invisible="1"/>
                    </group>
                </page>
                
                <!-- ⭐ NUEVO: Página DTE Information (Professional) -->
                <page string="DTE Information" name="dte_info_page"
                      attrs="{'invisible': [('dte_type', '=', False)]}">
                    <group>
                        <group string="DTE Status" col="2">
                            <field name="dte_type" readonly="1"/>
                            <field name="dte_folio" readonly="1"/>
                            <field name="dte_track_id" readonly="1"/>
                            <field name="dte_status" readonly="1" invisible="1"/>
                            <field name="dte_sent_date" readonly="1"/>
                            <field name="dte_accepted_date" readonly="1"
                                   attrs="{'invisible': [('dte_accepted_date', '=', False)]}"/>
                            <field name="is_contingency" readonly="1"/>
                        </group>

                        <group string="DTE Configuration" col="2">
                            <field name="dte_certificate_id" readonly="1"/>
                            <field name="dte_caf_id" readonly="1"/>
                            <field name="dte_environment" readonly="1"/>
                        </group>
                    </group>

                    <!-- Error Message (if any) -->
                    <group attrs="{'invisible': [('dte_error_message', '=', False)]}">
                        <div class="alert alert-danger" role="alert">
                            <i class="fa fa-exclamation-triangle"/>
                            <strong>DTE Error:</strong><br/>
                            <field name="dte_error_message" readonly="1" nolabel="1"/>
                        </div>
                    </group>

                    <!-- QR Code Display -->
                    <group attrs="{'invisible': [('dte_qr_image', '=', False)]}">
                        <label for="dte_qr_image" string="QR Code"/>
                        <field name="dte_qr_image" widget="image" readonly="1" nolabel="1"/>
                    </group>

                    <!-- DTE XML (Technical) -->
                    <group string="Technical Information" groups="base.group_no_one">
                        <field name="dte_xml" readonly="1" widget="ace" options="{'mode': 'xml'}"/>
                        <field name="dte_response_xml" readonly="1" widget="ace" options="{'mode': 'xml'}"/>
                    </group>
                </page>

                <!-- Nueva página: Procesamiento Asíncrono -->
                <page string="Procesamiento Asíncrono" name="dte_async_page"
                      attrs="{'invisible': [('dte_async_status', '=', 'draft')]}">
                    <group>
                        <group string="Estado Asíncrono">
                            <field name="dte_async_status" readonly="1" widget="badge"
                                   decoration-info="dte_async_status == 'queued'"
                                   decoration-warning="dte_async_status == 'processing'"
                                   decoration-success="dte_async_status in ['sent', 'accepted']"
                                   decoration-danger="dte_async_status in ['rejected', 'error']"/>
                            <field name="dte_queue_date" readonly="1"/>
                            <field name="dte_processing_date" readonly="1"/>
                            <field name="dte_retry_count" readonly="1"/>
                        </group>
                        <group string="Resultado">
                            <field name="dte_track_id" readonly="1"/>
                            <field name="dte_error_message" readonly="1"
                                   class="text-danger"
                                   attrs="{'invisible': [('dte_error_message', '=', False)]}"/>
                        </group>
                    </group>

                    <group string="Información RabbitMQ">
                        <div class="alert alert-info" role="alert">
                            <p><strong>Procesamiento Asíncrono:</strong></p>
                            <ul>
                                <li>El DTE se procesa en segundo plano vía RabbitMQ</li>
                                <li>Recibirás notificaciones automáticas del progreso</li>
                                <li>Puedes continuar trabajando mientras se procesa</li>
                            </ul>
                        </div>
                    </group>
                </page>
            </xpath>
            
            <!-- Smart Buttons en button_box -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <!-- ⭐ NUEVO: DTE XML Download Smart Button -->
                <button name="action_download_dte_xml"
                        type="object"
                        class="oe_stat_button"
                        icon="fa-file-code-o"
                        attrs="{'invisible': [('dte_xml', '=', False)]}">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_text">DTE XML</span>
                    </div>
                </button>

                <!-- ⭐ NUEVO: DTE PDF Download Smart Button -->
                <button name="action_download_dte_pdf"
                        type="object"
                        class="oe_stat_button"
                        icon="fa-file-pdf-o"
                        attrs="{'invisible': [('dte_pdf', '=', False)]}">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_text">DTE PDF</span>
                    </div>
                </button>

                <!-- RabbitMQ Status Smart Button -->
                <button name="action_view_rabbitmq_status"
                        type="object"
                        class="oe_stat_button"
                        icon="fa-exchange"
                        attrs="{'invisible': [('dte_async_status', '=', 'draft')]}">
                    <field name="dte_async_status" widget="statinfo" string="Estado Async"/>
                </button>
            </xpath>
            
        </field>
    </record>
    
    <!-- Extensión de Vista Tree de Facturas -->
    <record id="view_move_tree_dte" model="ir.ui.view">
        <field name="name">account.move.tree.dte</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_invoice_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='state']" position="after">
                <field name="dte_status" optional="show" 
                       decoration-success="dte_status == 'accepted'"
                       decoration-warning="dte_status == 'to_send'"
                       decoration-danger="dte_status == 'rejected'"/>
                <field name="dte_async_status" optional="show"
                       decoration-info="dte_async_status == 'queued'"
                       decoration-warning="dte_async_status == 'processing'"
                       decoration-success="dte_async_status in ['sent', 'accepted']"
                       decoration-danger="dte_async_status in ['rejected', 'error']"/>
                <field name="dte_folio" optional="show"/>
                <field name="dte_code" optional="hide"/>
            </xpath>
        </field>
    </record>
    
    <!-- Filtros de búsqueda para estados async -->
    <record id="view_move_search_dte_async" model="ir.ui.view">
        <field name="name">account.move.search.dte.async</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_account_invoice_filter"/>
        <field name="arch" type="xml">
            <xpath expr="//filter[@name='draft']" position="after">
                <!-- Filtros DTE Async -->
                <separator/>
                <filter string="En Cola RabbitMQ" name="dte_queued" 
                        domain="[('dte_async_status', '=', 'queued')]"/>
                <filter string="Procesando Async" name="dte_processing" 
                        domain="[('dte_async_status', '=', 'processing')]"/>
                <filter string="Enviados Async" name="dte_sent_async" 
                        domain="[('dte_async_status', '=', 'sent')]"/>
                <filter string="Aceptados Async" name="dte_accepted_async" 
                        domain="[('dte_async_status', '=', 'accepted')]"/>
                <filter string="Con Errores Async" name="dte_error_async" 
                        domain="[('dte_async_status', 'in', ['rejected', 'error'])]"/>
            </xpath>
            
            <!-- Agrupar por estado async -->
            <xpath expr="//filter[@name='invoice_date']" position="after">
                <filter string="Estado Async" name="group_async_status" 
                        context="{'group_by': 'dte_async_status'}"/>
            </xpath>
        </field>
    </record>
</odoo>
